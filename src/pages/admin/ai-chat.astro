---
import UniversalPageLayout from "../../layouts/UniversalPageLayout.astro";
import GlassPanel from "../../layouts/components/GlassPanel.astro";
import CyberpunkButton from "../../layouts/components/CyberpunkButton.astro";

const pageTitle = "Admin AI Assistant";
const pageDescription = "Inteligentny asystent AI dla administratorĂłw systemu MyBonzo";
const pageQuote = "Technologia wspiera ludzi, a nie na odwrĂłt.";
const pageAuthor = "MyBonzo Admin AI";
---

<UniversalPageLayout 
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageQuote={pageQuote}
  pageAuthor={pageAuthor}
  showRandomQuote={false}
>
    <!-- Admin AI Chat Interface -->
    <GlassPanel title="đź¤– Admin AI Assistant" variant="highlight" padding="xl">
        <div id="admin-ai-chat" style="height: 600px; display: flex; flex-direction: column;">
            
            <!-- Chat Controls -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.4); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px;">
                <div style="flex: 1;">
                    <label style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 5px; display: block;">Model AI:</label>
                    <select id="ai-model" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.6); border: 1px solid rgba(0,217,255,0.5); border-radius: 4px; color: #00d9ff; font-family: 'Courier New', monospace;">
                        <option value="@cf/meta/llama-3.1-8b-instruct">Llama 3.1 8B (Zalecany)</option>
                        <option value="@cf/mistral/mistral-7b-instruct-v0.1">Mistral 7B</option>
                        <option value="@cf/qwen/qwen1.5-7b-chat-awq">Qwen 1.5 7B</option>
                        <option value="@cf/huggingface/bielik-7b-instruct-v0.1">Bielik 7B (Polski)</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 5px; display: block;">Tryb administratora:</label>
                    <select id="admin-mode" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.6); border: 1px solid rgba(0,217,255,0.5); border-radius: 4px; color: #00d9ff; font-family: 'Courier New', monospace;">
                        <option value="general">OgĂłlny Administrator</option>
                        <option value="technical">Wsparcie Techniczne</option>
                        <option value="security">BezpieczeĹ„stwo</option>
                        <option value="analytics">Analityka</option>
                        <option value="deployment">Deployment</option>
                    </select>
                </div>
                <div style="display: flex; align-items: end;">
                    <CyberpunkButton 
                        text="đź”„ Reset" 
                        variant="outline" 
                        size="sm"
                        onclick="clearChat()"
                    />
                </div>
            </div>

            <!-- Messages Container -->
            <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.2); border: 1px solid rgba(0,217,255,0.2); border-radius: 8px; margin-bottom: 15px;">
                <div class="welcome-message" style="background: rgba(0,217,255,0.1); border-left: 4px solid #00d9ff; padding: 15px; margin-bottom: 15px; border-radius: 4px;">
                    <div style="color: #00d9ff; font-weight: bold; margin-bottom: 8px;">đź¤– Admin AI Assistant</div>
                    <div style="color: rgba(255,255,255,0.9);">
                        Witaj w panelu Admin AI Assistant! Jestem tutaj, aby pomĂłc Ci w zadaniach administracyjnych:
                        <ul style="margin: 10px 0; padding-left: 20px; color: rgba(255,255,255,0.8);">
                            <li>Monitorowanie systemu i diagnostyka</li>
                            <li>Analiza logĂłw i problemĂłw</li>
                            <li>Konfiguracja i deployment</li>
                            <li>ZarzÄ…dzanie uĹĽytkownikami i zabezpieczeniami</li>
                            <li>Optymalizacja wydajnoĹ›ci</li>
                        </ul>
                        Zadaj pytanie lub opisz problem, z ktĂłrym potrzebujesz pomocy.
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div style="display: flex; gap: 10px; align-items: end;">
                <div style="flex: 1;">
                    <textarea 
                        id="chat-input" 
                        placeholder="Zadaj pytanie administracyjne..." 
                        style="width: 100%; padding: 12px; background: rgba(0,0,0,0.6); border: 1px solid rgba(0,217,255,0.5); border-radius: 4px; color: white; resize: vertical; min-height: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"
                        onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"
                    ></textarea>
                </div>
                <div>
                    <CyberpunkButton 
                        text="WyĹ›lij" 
                        variant="primary" 
                        size="md"
                        onclick="sendMessage()"
                        id="send-button"
                    />
                </div>
            </div>
        </div>
    </GlassPanel>

    <!-- Quick Admin Actions -->
    <GlassPanel title="âšˇ Szybkie akcje administracyjne" variant="default" padding="lg">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            
            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px; padding: 15px;">
                <h4 style="color: #00d9ff; margin-bottom: 10px;">đź”Ť Diagnostyka systemu</h4>
                <CyberpunkButton 
                    text="SprawdĹş status systemu" 
                    variant="outline" 
                    size="sm"
                    onclick="askAI('SprawdĹş aktualny status wszystkich komponentĂłw systemu MyBonzo. Czy wszystkie workery dziaĹ‚ajÄ… prawidĹ‚owo?')"
                />
            </div>

            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px; padding: 15px;">
                <h4 style="color: #00d9ff; margin-bottom: 10px;">đź“Š Analiza wydajnoĹ›ci</h4>
                <CyberpunkButton 
                    text="Analizuj wydajnoĹ›Ä‡" 
                    variant="outline" 
                    size="sm"
                    onclick="askAI('Przeanalizuj wydajnoĹ›Ä‡ aplikacji. Jakie sÄ… gĹ‚Ăłwne bottlenecki i jak moĹĽna je zoptymalizowaÄ‡?')"
                />
            </div>

            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px; padding: 15px;">
                <h4 style="color: #00d9ff; margin-bottom: 10px;">đź›ˇď¸Ź BezpieczeĹ„stwo</h4>
                <CyberpunkButton 
                    text="SprawdĹş zabezpieczenia" 
                    variant="warning" 
                    size="sm"
                    onclick="askAI('Przeanalizuj zabezpieczenia systemu. Czy sÄ… jakieĹ› potencjalne luki w bezpieczeĹ„stwie?')"
                />
            </div>

            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px; padding: 15px;">
                <h4 style="color: #00d9ff; margin-bottom: 10px;">đźš€ Deployment</h4>
                <CyberpunkButton 
                    text="Pomocy z deployment" 
                    variant="outline" 
                    size="sm"
                    onclick="askAI('PotrzebujÄ™ pomocy z deployment. Jakie sÄ… najlepsze praktyki dla bezpiecznego wdroĹĽenia?')"
                />
            </div>

            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px; padding: 15px;">
                <h4 style="color: #00d9ff; margin-bottom: 10px;">đź‘Ą ZarzÄ…dzanie uĹĽytkownikami</h4>
                <CyberpunkButton 
                    text="Pomocy z uĹĽytkownikami" 
                    variant="outline" 
                    size="sm"
                    onclick="askAI('Jak mogÄ™ efektywnie zarzÄ…dzaÄ‡ uĹĽytkownikami systemu? Jakie sÄ… najlepsze praktyki?')"
                />
            </div>

            <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px; padding: 15px;">
                <h4 style="color: #00d9ff; margin-bottom: 10px;">đź“ť Logi i debugging</h4>
                <CyberpunkButton 
                    text="Analizuj logi" 
                    variant="outline" 
                    size="sm"
                    onclick="askAI('PomĂłĹĽ mi przeanalizowaÄ‡ logi systemu. Jak zidentyfikowaÄ‡ i rozwiÄ…zaÄ‡ problemy?')"
                />
            </div>
        </div>
    </GlassPanel>

    <script>
        let isLoading = false;
        let messageHistory = [];

        // Admin mode configurations
        const adminModes = {
            general: {
                name: "OgĂłlny Administrator",
                icon: "đź‘¤",
                color: "#00d9ff"
            },
            technical: {
                name: "Wsparcie Techniczne", 
                icon: "đź”§",
                color: "#fbbf24"
            },
            security: {
                name: "BezpieczeĹ„stwo",
                icon: "đź›ˇď¸Ź", 
                color: "#ef4444"
            },
            analytics: {
                name: "Analityka",
                icon: "đź“Š",
                color: "#10b981"
            },
            deployment: {
                name: "Deployment",
                icon: "đźš€",
                color: "#8b5cf6"
            }
        };

        function getAdminModeConfig() {
            const mode = document.getElementById('admin-mode').value;
            return adminModes[mode] || adminModes.general;
        }

        function addMessage(content, isUser = false, isError = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const modeConfig = getAdminModeConfig();
            
            messageDiv.style.cssText = `
                margin-bottom: 15px;
                padding: 15px;
                border-radius: 8px;
                ${isUser 
                    ? `background: rgba(0,217,255,0.1); border-left: 4px solid #00d9ff; margin-left: 20px;`
                    : isError
                        ? `background: rgba(239,68,68,0.1); border-left: 4px solid #ef4444;`
                        : `background: rgba(0,0,0,0.4); border-left: 4px solid ${modeConfig.color};`
                }
            `;

            const header = isUser 
                ? `<div style="color: #00d9ff; font-weight: bold; margin-bottom: 8px;">đź‘¤ Administrator</div>`
                : isError
                    ? `<div style="color: #ef4444; font-weight: bold; margin-bottom: 8px;">âťŚ BĹ‚Ä…d</div>`
                    : `<div style="color: ${modeConfig.color}; font-weight: bold; margin-bottom: 8px;">${modeConfig.icon} ${modeConfig.name}</div>`;

            messageDiv.innerHTML = `
                ${header}
                <div style="color: rgba(255,255,255,0.9); line-height: 1.6; white-space: pre-wrap;">${content}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const message = input.value.trim();

            if (!message || isLoading) return;

            // Add user message
            addMessage(message, true);
            messageHistory.push({ role: 'user', content: message });

            // Clear input and set loading state
            input.value = '';
            isLoading = true;
            sendButton.textContent = 'MyĹ›lÄ™...';
            sendButton.style.opacity = '0.6';

            try {
                const response = await fetch('/api/admin/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        model: document.getElementById('ai-model').value,
                        mode: document.getElementById('admin-mode').value,
                        history: messageHistory.slice(-10) // Last 10 messages for context
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage(data.response);
                    messageHistory.push({ role: 'assistant', content: data.response });
                } else {
                    addMessage(`BĹ‚Ä…d: ${data.error}`, false, true);
                }

            } catch (error) {
                console.error('Chat error:', error);
                addMessage(`BĹ‚Ä…d poĹ‚Ä…czenia: ${error.message}`, false, true);
            } finally {
                isLoading = false;
                sendButton.textContent = 'WyĹ›lij';
                sendButton.style.opacity = '1';
            }
        }

        function askAI(predefinedQuestion) {
            document.getElementById('chat-input').value = predefinedQuestion;
            sendMessage();
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="welcome-message" style="background: rgba(0,217,255,0.1); border-left: 4px solid #00d9ff; padding: 15px; margin-bottom: 15px; border-radius: 4px;">
                    <div style="color: #00d9ff; font-weight: bold; margin-bottom: 8px;">đź¤– Admin AI Assistant</div>
                    <div style="color: rgba(255,255,255,0.9);">
                        Chat zostaĹ‚ wyczyszczony. Jak mogÄ™ Ci pomĂłc w zadaniach administracyjnych?
                    </div>
                </div>
            `;
            messageHistory = [];
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Focus on input
            document.getElementById('chat-input').focus();
            
            // Add mode change listener
            document.getElementById('admin-mode').addEventListener('change', function() {
                const modeConfig = getAdminModeConfig();
                const welcomeMsg = document.querySelector('.welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.style.borderLeftColor = modeConfig.color;
                    welcomeMsg.querySelector('div').innerHTML = `${modeConfig.icon} Admin AI Assistant - ${modeConfig.name}`;
                }
            });
        });
    </script>
</UniversalPageLayout>
