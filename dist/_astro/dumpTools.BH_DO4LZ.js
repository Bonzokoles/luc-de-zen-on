const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/engine.Bhq7AZzW.js","_astro/decorators.serialization.DTWIlLMH.js","_astro/math.vector.C8FsJn6B.js","_astro/math.color.BvxHr_bk.js","_astro/preload-helper.BlTxHScW.js","_astro/math.axis.BWIUWoG3.js","_astro/math.plane.DogzNArm.js","_astro/math.path.Rz-CSHk9.js","_astro/baseTexture.xJCKUhPX.js","_astro/math.size.F3xmSqZc.js","_astro/pass.fragment.B0AEbMA6.js"])))=>i.map(i=>d[i]);
import{_ as E}from"./preload-helper.BlTxHScW.js";import{E as _,a as C}from"./postProcess.BhJOrjOy.js";import{T as l}from"./tools.kgQOdK5j.js";import{C as A}from"./math.color.BvxHr_bk.js";import{E as d}from"./math.vector.C8FsJn6B.js";import{L as x}from"./decorators.serialization.DTWIlLMH.js";import"./texture.DcuyhkEj.js";import"./baseTexture.xJCKUhPX.js";import"./math.size.F3xmSqZc.js";import"./instantiationTools.DpJ04vA6.js";import"./math.plane.DogzNArm.js";import"./smartArray.BsIpkRz3.js";import"./engine.Bhq7AZzW.js";import"./math.axis.BWIUWoG3.js";import"./math.path.Rz-CSHk9.js";import"./math.viewport.CgkTt1RS.js";let c=null;async function T(){const e=d.LastCreatedEngine?.createCanvas(100,100)??new OffscreenCanvas(100,100);e instanceof OffscreenCanvas&&x.Warn("DumpData: OffscreenCanvas will be used for dumping data. This may result in lossy alpha values.");const{ThinEngine:t}=await E(async()=>{const{ThinEngine:o}=await import("./engine.Bhq7AZzW.js").then(i=>i.t);return{ThinEngine:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));if(!t.IsSupported){if(!e.getContext("bitmaprenderer"))throw new Error("DumpData: No WebGL or bitmap rendering context available. Cannot dump data.");return{canvas:e}}const r={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1},a=new t(e,!1,r);d.Instances.pop(),d.OnEnginesDisposedObservable.add(o=>{a&&o!==a&&!a.isDisposed&&d.Instances.length===0&&y()}),a.getCaps().parallelShaderCompile=void 0;const m=new _(a),{passPixelShader:s}=await E(async()=>{const{passPixelShader:o}=await import("./pass.fragment.B0AEbMA6.js");return{passPixelShader:o}},__vite__mapDeps([10,1,2,3,4])),f=new C({engine:a,name:s.name,fragmentShader:s.shader,samplerNames:["textureSampler"]});return{canvas:e,dumpEngine:{engine:a,renderer:m,wrapper:f}}}async function I(){return c||(c=T()),await c}async function v(e,t,r,a,m="image/png",s,f){const o=await r.readPixels(0,0,e,t),i=new Uint8Array(o.buffer);D(e,t,i,a,m,s,!0,void 0,f)}async function w(e,t,r,a="image/png",m,s=!1,f=!1,o){if(r instanceof Float32Array){const u=new Uint8Array(r.length);let n=r.length;for(;n--;){const p=r[n];u[n]=Math.round(A(p)*255)}r=u}const i=await I();return await new Promise(async u=>{if(i.dumpEngine){const n=i.dumpEngine;n.engine.setSize(e,t,!0);const p=n.engine.createRawTexture(r,e,t,5,!1,!s,1);n.renderer.setViewport(),n.renderer.applyEffectWrapper(n.wrapper),n.wrapper.effect._bindTexture("textureSampler",p),n.renderer.draw(),p.dispose()}else{const n=i.canvas.getContext("bitmaprenderer");i.canvas.width=e,i.canvas.height=t;const p=new ImageData(e,t);p.data.set(r);const g=await createImageBitmap(p,{premultiplyAlpha:"none",imageOrientation:s?"flipY":"from-image"});n.transferFromImageBitmap(g)}l.ToBlob(i.canvas,n=>{if(!n)throw new Error("DumpData: Failed to convert canvas to blob.");m!==void 0&&l.DownloadBlob(n,m);const p=new FileReader;p.onload=g=>{const h=g.target.result;u(h)},f?p.readAsArrayBuffer(n):p.readAsDataURL(n)},a,o)})}function D(e,t,r,a,m="image/png",s,f=!1,o=!1,i){s===void 0&&!a&&(s=""),w(e,t,r,m,s,f,o,i).then(u=>{a&&a(u)})}function y(){c&&(c?.then(e=>{e.canvas instanceof HTMLCanvasElement&&e.canvas.remove(),e.dumpEngine&&(e.dumpEngine.engine.dispose(),e.dumpEngine.renderer.dispose(),e.dumpEngine.wrapper.dispose())}),c=null)}const J={DumpData:D,DumpDataAsync:w,DumpFramebuffer:v,Dispose:y},R=()=>{l.DumpData=D,l.DumpDataAsync=w,l.DumpFramebuffer=v};R();export{y as Dispose,D as DumpData,w as DumpDataAsync,v as DumpFramebuffer,J as DumpTools};
