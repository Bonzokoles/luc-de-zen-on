const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/dumpTools.BH_DO4LZ.js","_astro/preload-helper.BlTxHScW.js","_astro/tools.kgQOdK5j.js","_astro/math.vector.C8FsJn6B.js","_astro/math.color.BvxHr_bk.js","_astro/decorators.serialization.DTWIlLMH.js","_astro/instantiationTools.DpJ04vA6.js","_astro/texture.DcuyhkEj.js","_astro/baseTexture.xJCKUhPX.js","_astro/math.size.F3xmSqZc.js","_astro/math.plane.DogzNArm.js","_astro/smartArray.BsIpkRz3.js","_astro/engine.Bhq7AZzW.js","_astro/math.axis.BWIUWoG3.js","_astro/math.path.Rz-CSHk9.js","_astro/math.viewport.CgkTt1RS.js","_astro/postprocess.vertex.BN-gUg4C.js"])))=>i.map(i=>d[i]);
import{_ as U}from"./preload-helper.BlTxHScW.js";import{O as v,V as k,M as Q,a as V}from"./math.vector.C8FsJn6B.js";import{T as I}from"./texture.DcuyhkEj.js";import{L as w,u as ee,v as te,N as se,w as z,T as re,d as K,x as q,S as H,A as X,a as C,s as T,y as ie}from"./decorators.serialization.DTWIlLMH.js";import{S as B,a as ne}from"./smartArray.BsIpkRz3.js";import{_ as ae,G as he,R as oe}from"./math.color.BvxHr_bk.js";import{D as de}from"./engine.Bhq7AZzW.js";import{V as le}from"./math.viewport.CgkTt1RS.js";function ue(d,e,t,s){switch(e){case 5120:{let r=d.getInt8(t);return s&&(r=Math.max(r/127,-1)),r}case 5121:{let r=d.getUint8(t);return s&&(r=r/255),r}case 5122:{let r=d.getInt16(t,!0);return s&&(r=Math.max(r/32767,-1)),r}case 5123:{let r=d.getUint16(t,!0);return s&&(r=r/65535),r}case 5124:return d.getInt32(t,!0);case 5125:return d.getUint32(t,!0);case 5126:return d.getFloat32(t,!0);default:throw new Error(`Invalid component type ${e}`)}}function fe(d,e,t,s,r){switch(e){case 5120:{s&&(r=Math.round(r*127)),d.setInt8(t,r);break}case 5121:{s&&(r=Math.round(r*255)),d.setUint8(t,r);break}case 5122:{s&&(r=Math.round(r*32767)),d.setInt16(t,r,!0);break}case 5123:{s&&(r=Math.round(r*65535)),d.setUint16(t,r,!0);break}case 5124:{d.setInt32(t,r,!0);break}case 5125:{d.setUint32(t,r,!0);break}case 5126:{d.setFloat32(t,r,!0);break}default:throw new Error(`Invalid component type ${e}`)}}function F(d){switch(d){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`Invalid type '${d}'`)}}function N(d,e,t,s,r,i,n,a){const u=new Array(s),h=new Array(s);if(d instanceof Array){let o=e/4;const l=t/4;for(let _=0;_<i;_+=s){for(let c=0;c<s;c++)u[c]=h[c]=d[o+c];a(h,_);for(let c=0;c<s;c++)u[c]!==h[c]&&(d[o+c]=h[c]);o+=l}}else{const o=ArrayBuffer.isView(d)?new DataView(d.buffer,d.byteOffset,d.byteLength):new DataView(d),l=F(r);for(let _=0;_<i;_+=s){for(let c=0,g=e;c<s;c++,g+=l)u[c]=h[c]=ue(o,r,g,n);a(h,_);for(let c=0,g=e;c<s;c++,g+=l)u[c]!==h[c]&&fe(o,r,g,n,h[c]);e+=t}}}function Y(d,e,t,s,r,i,n,a){const u=e*F(t),h=n*e;if(t!==5126||r!==u){const o=new Float32Array(h);return N(d,s,r,e,t,h,i,(l,_)=>{for(let c=0;c<e;c++)o[_+c]=l[c]}),o}if(!(d instanceof Array||d instanceof Float32Array)||s!==0||d.length!==h)if(d instanceof Array){const o=s/4;return d.slice(o,o+h)}else{if(d instanceof ArrayBuffer)return new Float32Array(d,s,h);{const o=d.byteOffset+s;return(o&3)!==0&&(w.Warn("Float array must be aligned to 4-bytes border"),a=!0),a?new Float32Array(d.buffer.slice(o,o+h*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(d.buffer,o,h)}}return a?d.slice():d}function Ce(d,e,t,s,r,i,n,a){const u=e*F(t),h=n*e;if(a.length!==h)throw new Error("Output length is not valid");if(t!==5126||r!==u){N(d,s,r,e,t,h,i,(o,l)=>{for(let _=0;_<e;_++)a[l+_]=o[_]});return}if(d instanceof Array){const o=s/4;a.set(d,o)}else if(d instanceof ArrayBuffer){const o=new Float32Array(d,s,h);a.set(o)}else{const o=d.byteOffset+s;if((o&3)!==0){w.Warn("Float array must be aligned to 4-bytes border"),a.set(new Float32Array(d.buffer.slice(o,o+h*Float32Array.BYTES_PER_ELEMENT)));return}const l=new Float32Array(d.buffer,o,h);a.set(l)}}class ${get isDisposed(){return this._isDisposed}constructor(e,t,s,r=0,i=!1,n=!1,a=!1,u,h){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=s,this._instanced=n,this._divisor=u||1,this._label=h,t instanceof de?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=a?r:r*Float32Array.BYTES_PER_ELEMENT,i||this.create()}createVertexBuffer(e,t,s,r,i,n=!1,a){const u=n?t:t*Float32Array.BYTES_PER_ELEMENT,h=r?n?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new f(this._engine,this,e,this._updatable,!0,h,i===void 0?this._instanced:i,u,s,void 0,void 0,!0,this._divisor||a)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}w.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,s,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,s?s*this.byteStride:void 0),t===0&&s===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class f{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,s,r,i,n,a,u,h,o,l=!1,_=!1,c=1,g=!1){this._isDisposed=!1;let p=!1;if(this.engine=e,typeof r=="object"&&r!==null?(p=r.updatable??!1,i=r.postponeInternalCreation,n=r.stride,a=r.instanced,u=r.offset,h=r.size,o=r.type,l=r.normalized??!1,_=r.useBytes??!1,c=r.divisor??1,g=r.takeBufferOwnership??!1,this._label=r.label):p=!!r,t instanceof $?(this._buffer=t,this._ownsBuffer=g):(this._buffer=new $(e,t,p,n,i,a,_,c,this._label),this._ownsBuffer=!0),this.uniqueId=f._Counter++,this._kind=s,o===void 0){const x=this.getData();this.type=x?f.GetDataType(x):f.FLOAT}else this.type=o;const b=F(this.type);_?(this._size=h||(n?n/b:f.DeduceStride(s)),this.byteStride=n||this._buffer.byteStride||this._size*b,this.byteOffset=u||0):(this._size=h||n||f.DeduceStride(s),this.byteStride=n?n*b:this._buffer.byteStride||this._size*b,this.byteOffset=(u||0)*b),this.normalized=l,this._instanced=a!==void 0?a:!1,this._instanceDivisor=a?c:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const s=this.getData();return s?Y(s,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/F(this.type)}getOffset(){return this.byteOffset/F(this.type)}getSize(e=!1){return e?this._size*F(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,s=!1){this._buffer.updateDirectly(e,t,void 0,s),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){N(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,(s,r)=>{for(let i=0;i<this._size;i++)t(s[i],r+i)})}_alignBuffer(){}static DeduceStride(e){switch(e){case f.UVKind:case f.UV2Kind:case f.UV3Kind:case f.UV4Kind:case f.UV5Kind:case f.UV6Kind:return 2;case f.NormalKind:case f.PositionKind:return 3;case f.ColorKind:case f.ColorInstanceKind:case f.MatricesIndicesKind:case f.MatricesIndicesExtraKind:case f.MatricesWeightsKind:case f.MatricesWeightsExtraKind:case f.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?f.BYTE:e instanceof Uint8Array?f.UNSIGNED_BYTE:e instanceof Int16Array?f.SHORT:e instanceof Uint16Array?f.UNSIGNED_SHORT:e instanceof Int32Array?f.INT:e instanceof Uint32Array?f.UNSIGNED_INT:f.FLOAT}static GetTypeByteLength(e){return F(e)}static ForEach(e,t,s,r,i,n,a,u){N(e,t,s,r,i,n,a,(h,o)=>{for(let l=0;l<r;l++)u(h[l],o+l)})}static GetFloatData(e,t,s,r,i,n,a,u){return Y(e,t,s,r,i,n,a,u)}}f._Counter=0;f.BYTE=5120;f.UNSIGNED_BYTE=5121;f.SHORT=5122;f.UNSIGNED_SHORT=5123;f.INT=5124;f.UNSIGNED_INT=5125;f.FLOAT=5126;f.PositionKind="position";f.NormalKind="normal";f.TangentKind="tangent";f.UVKind="uv";f.UV2Kind="uv2";f.UV3Kind="uv3";f.UV4Kind="uv4";f.UV5Kind="uv5";f.UV6Kind="uv6";f.ColorKind="color";f.ColorInstanceKind="instanceColor";f.MatricesIndicesKind="matricesIndices";f.MatricesWeightsKind="matricesWeights";f.MatricesIndicesExtraKind="matricesIndicesExtra";f.MatricesWeightsExtraKind="matricesWeightsExtra";class ce{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new v,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[f.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[f.PositionKind]=new f(this._scene.getEngine(),e,f.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[f.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const s=this._scene.activeCamera;return!s||(t=t||s._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(s,e,t!=null),!0)}directRender(e,t=null,s=!1,r=0,i=0,n=!1,a=e.length){const u=this._scene.getEngine();for(let h=0;h<a;h++){h<e.length-1?e[h+1].activate(this._scene.activeCamera||this._scene,t?.texture):(t?u.bindFramebuffer(t,r,void 0,void 0,s,i):n||u.restoreDefaultFramebuffer(),u._debugInsertMarker?.(`post process ${e[h].name} output`));const o=e[h],l=o.apply();l&&(o.onBeforeRenderObservable.notifyObservers(l),this._prepareBuffers(),u.bindBuffers(this._vertexBuffers,this._indexBuffer,l),u.drawElementsType(0,0,6),o.onAfterRenderObservable.notifyObservers(l))}u.setDepthBuffer(!0),u.setDepthWrite(!0)}_finalizeFrame(e,t,s,r,i=!1){const n=this._scene.activeCamera;if(!n||(this.onBeforeRenderObservable.notifyObservers(this),r=r||n._postProcesses.filter(u=>u!=null),r.length===0||!this._scene.postProcessesEnabled))return;const a=this._scene.getEngine();for(let u=0,h=r.length;u<h;u++){const o=r[u];if(u<h-1?o._outputTexture=r[u+1].activate(n,t?.texture):(t?(a.bindFramebuffer(t,s,void 0,void 0,i),o._outputTexture=t):(a.restoreDefaultFramebuffer(),o._outputTexture=null),a._debugInsertMarker?.(`post process ${r[u].name} output`)),e)break;const l=o.apply();l&&(o.onBeforeRenderObservable.notifyObservers(l),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,l),a.drawElementsType(0,0,6),o.onAfterRenderObservable.notifyObservers(l))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[f.PositionKind];e&&(e.dispose(),this._vertexBuffers[f.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class M{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=M.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=M.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=M.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,s=null,r=null,i=null){this.index=e,this._opaqueSubMeshes=new B(256),this._transparentSubMeshes=new B(256),this._alphaTestSubMeshes=new B(256),this._depthOnlySubMeshes=new B(256),this._particleSystems=new B(256),this._spriteManagers=new B(256),this._empty=!0,this._edgesRenderers=new ne(16),this.disableDepthPrePass=!1,this._scene=t,this.opaqueSortCompareFn=s,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=i}render(e,t,s,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const i=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(i.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),i.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=i.getStencilBuffer();if(i.setStencilBuffer(!1),t&&this._renderSprites(),s&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(i.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const a=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);a.length&&this._renderTransparent(a)}else this._renderTransparent(this._transparentSubMeshes);i.setAlphaMode(0)}if(i.setStencilBuffer(!1),this._edgesRenderers.length){for(let a=0;a<this._edgesRenderers.length;a++)this._edgesRenderers.data[a].render();i.setAlphaMode(0)}i.setStencilBuffer(n)}_renderOpaqueSorted(e){M._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1,this.disableDepthPrePass)}_renderAlphaTestSorted(e){M._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1,this.disableDepthPrePass)}_renderTransparentSorted(e){M._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0,this.disableDepthPrePass)}static _RenderSorted(e,t,s,r,i){let n=0,a;const u=s?s.globalPosition:M._ZeroVector;if(r)for(;n<e.length;n++)a=e.data[n],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=k.Distance(a.getBoundingInfo().boundingSphere.centerWorld,u);const h=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&h.sort(t);const o=h[0].getMesh().getScene();for(n=0;n<h.length;n++)if(a=h[n],!(o._activeMeshesFrozenButKeepClipping&&!a.isInFrustum(o._frustumPlanes))){if(r){const l=a.getMaterial();if(l&&l.needDepthPrePass&&!i){const _=l.getScene().getEngine();_.setColorWrite(!1),_.setAlphaMode(0),a.render(!1),_.setColorWrite(!0)}}a.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:M.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const s=e.getMesh(),r=t.getMesh();return s.material&&r.material?s.material.uniqueId-r.material.uniqueId:s.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,s){t===void 0&&(t=e.getMesh()),s===void 0&&(s=e.getMaterial()),s!=null&&(s.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):s.needAlphaTestingForMesh(t)?(s.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(s.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let s=0;s<this._particleSystems.length;s++){const r=this._particleSystems.data[s];if((t&&t.layerMask&r.layerMask)===0)continue;const i=r.emitter;(!i.position||!e||e.indexOf(i)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const s=this._spriteManagers.data[t];(e&&e.layerMask&s.layerMask)!==0&&s.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}M._ZeroVector=k.Zero();class _e{}class O{get disableDepthPrePass(){return this._disableDepthPrePass}set disableDepthPrePass(e){this._disableDepthPrePass=e;for(const t of this._renderingGroups)t.disableDepthPrePass=e}get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._disableDepthPrePass=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new _e,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=O.MIN_RENDERINGGROUPS;t<O.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,s,r){const i=this._renderingGroupInfo;if(i.scene=this._scene,i.camera=this._scene.activeCamera,i.renderingManager=this,this._scene.spriteManagers&&r)for(let n=0;n<this._scene.spriteManagers.length;n++){const a=this._scene.spriteManagers[n];this.dispatchSprites(a)}for(let n=O.MIN_RENDERINGGROUPS;n<O.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===O.MIN_RENDERINGGROUPS;const a=this._renderingGroups[n];if(!a||a._empty)continue;const u=1<<n;if(i.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(i,u),O.AUTOCLEAR){const h=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];h&&h.autoClear&&this._clearDepthStencilBuffer(h.depth,h.stencil)}for(const h of this._scene._beforeRenderingGroupDrawStage)h.action(n);a.render(e,r,s,t);for(const h of this._scene._afterRenderingGroupDrawStage)h.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(i,u)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=O.MIN_RENDERINGGROUPS;e<O.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=O.MIN_RENDERINGGROUPS;e<O.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=O.MIN_RENDERINGGROUPS;e<O.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new M(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]),this._renderingGroups[e].disableDepthPrePass=this._disableDepthPrePass)}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,s){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,s))}setRenderingOrder(e,t=null,s=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=s,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){const i=this._renderingGroups[e];i.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],i.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],i.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,s=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:s,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}O.MAX_RENDERINGGROUPS=4;O.MIN_RENDERINGGROUPS=0;O.AUTOCLEAR=!0;class E{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=ae(e,this._renderListHasChanged)),this._renderList=e)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(e){e!==this._disableImageProcessing&&(this._disableImageProcessing=e,this._scene.markAllMaterialsAsDirty(64))}get disableDepthPrePass(){return this._disableDepthPrePass}set disableDepthPrePass(e){this._disableDepthPrePass=e,this._renderingManager.disableDepthPrePass=e}get name(){return this._name}set name(e){if(this._name!==e){if(this._name=e,this._sceneUBOs)for(let t=0;t<this._sceneUBOs.length;++t)this._sceneUBOs[t].name=`Scene ubo #${t} for ${this.name}`;if(this._scene)for(let t=0;t<this._renderPassIds.length;++t){const s=this._renderPassIds[t];this._engine._renderPassNames[s]=`${this._name}#${t}`}}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}getActiveMeshes(){return this._activeMeshes}setMaterialForRendering(e,t){let s;Array.isArray(e)?s=e:s=[e];for(let r=0;r<s.length;++r)for(let i=0;i<this.options.numPasses;++i){let n=s[r];s[r].isAnInstance&&(n=s[r].sourceMesh),n.setMaterialForRenderPass(this._renderPassIds[i],t!==void 0?Array.isArray(t)?t[i]:t:void 0)}}_freezeActiveMeshes(e){this._freezeActiveMeshesCancel=ee(()=>this._checkReadiness(),()=>{if(this._freezeActiveMeshesCancel=null,e)for(let t=0;t<this._activeMeshes.length;t++)this._activeMeshes.data[t]._freeze();this._prepareRenderingManager(0,!0),this._isFrozen=!0},(t,s)=>{this._freezeActiveMeshesCancel=null,s?(w.Error("ObjectRenderer: Timeout while waiting for the renderer to be ready."),t&&w.Error(t)):(w.Error("ObjectRenderer: An unexpected error occurred while waiting for the renderer to be ready."),t&&(w.Error(t),t.stack&&w.Error(t.stack)))})}_unfreezeActiveMeshes(){this._freezeActiveMeshesCancel?.(),this._freezeActiveMeshesCancel=null;for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();this._isFrozen=!1}constructor(e,t,s){this._unObserveRenderList=null,this._renderListHasChanged=(r,i)=>{const n=this._renderList?this._renderList.length:0;if(i===0&&n>0||n===0)for(const a of this._scene.meshes)a._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.enableBoundingBoxRendering=!1,this.enableOutlineRendering=!0,this._disableImageProcessing=!1,this.dontSetTransformationMatrix=!1,this._disableDepthPrePass=!1,this.onBeforeRenderObservable=new v,this.onAfterRenderObservable=new v,this.onBeforeRenderingManagerRenderObservable=new v,this.onAfterRenderingManagerRenderObservable=new v,this.onInitRenderingObservable=new v,this.onFinishRenderingObservable=new v,this.onFastPathRenderObservable=new v,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._activeMeshes=new B(256),this._activeBoundingBoxes=new B(32),this._currentFrameId=-1,this._currentSceneUBOIndex=0,this._isFrozen=!1,this._freezeActiveMeshesCancel=null,this._currentSceneCamera=null,this.name=e,this._scene=t,this._engine=this._scene.getEngine(),this._useUBO=this._engine.supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._createSceneUBO()),this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...s},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new O(t),this._renderingManager._useSceneAutoClearSetup=!0,this._scene.addObjectRenderer(this)}_releaseRenderPassId(){for(let e=0;e<this.options.numPasses;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();for(let e=0;e<this.options.numPasses;++e)this._renderPassIds[e]=this._engine.createRenderPassId(`${this.name}#${e}`)}_createSceneUBO(){const e=this._sceneUBOs.length;this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene ubo #${e} for ${this.name}`,!1))}_getSceneUBO(){return this._currentFrameId!==this._engine.frameId&&(this._currentSceneUBOIndex=0,this._currentFrameId=this._engine.frameId),this._currentSceneUBOIndex>=this._sceneUBOs.length&&this._createSceneUBO(),this._sceneUBOs[this._currentSceneUBOIndex++]}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(e,t){this.prepareRenderList(),this.initRender(e,t);const s=this._checkReadiness();return this.finishRender(),s}prepareRenderList(){const e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){const s=this._waitingRenderList[t],r=e.getMeshById(s);r&&this.renderList.push(r)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const t=this._scene.meshes;for(let s=0;s<t.length;s++){const r=t[s];this.renderListPredicate(r)&&this.renderList.push(r)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(e,t){const s=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,this._useUBO&&(this._currentSceneUBO=this._scene.getSceneUniformBuffer(),this._currentSceneUBO.unbindEffect(),this._scene.setSceneUniformBuffer(this._getSceneUBO())),this.onInitRenderingObservable.notifyObservers(this),s&&(this.dontSetTransformationMatrix||this._scene.setTransformMatrix(s.getViewMatrix(),s.getProjectionMatrix(!0)),this._scene.activeCamera=s,this._engine.setViewport(s.rigParent?s.rigParent.viewport:s.viewport,e,t)),this._useUBO&&this._scene.finalizeSceneUbo(),this._defaultRenderListPrepared=!1}finishRender(){const e=this._scene;this._useUBO&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._disableImageProcessing&&(e.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),this._engine.setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial(),this.onFinishRenderingObservable.notifyObservers(this)}render(e=0,t=!1){const s=this._engine.currentRenderPassId;if(this._engine.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e),this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)this.onFastPathRenderObservable.notifyObservers(e);else{const i=this._prepareRenderingManager(e),n=this._scene.getOutlineRenderer?.(),a=n?.enabled;n&&(n.enabled=this.enableOutlineRendering),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,i,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e),n&&(n.enabled=a)}t||this.onAfterRenderObservable.notifyObservers(e),this._engine.currentRenderPassId=s}_checkReadiness(){const e=this._scene,t=this._engine.currentRenderPassId;let s=!0;e.getViewMatrix()||e.updateTransformMatrix();const r=this.options.numPasses;for(let n=0;n<r&&s;n++){let a=null;const u=this.renderList?this.renderList:e.frameGraph?e.meshes:e.getActiveMeshes().data,h=this.renderList?this.renderList.length:e.frameGraph?e.meshes.length:e.getActiveMeshes().length;this._engine.currentRenderPassId=this._renderPassIds[n],this.onBeforeRenderObservable.notifyObservers(n),this.getCustomRenderList&&(a=this.getCustomRenderList(n,u,h)),a||(a=u),this.options.doNotChangeAspectRatio||e.updateTransformMatrix(!0);for(let o=0;o<a.length&&s;++o){const l=a[o];if(!(!l.isEnabled()||l.isBlocked||!l.isVisible||!l.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!0)){s=!1;continue}}else if(!l.isReady(!0)){s=!1;continue}}}this.onAfterRenderObservable.notifyObservers(n),r>1&&(e.incrementRenderId(),e.resetCachedMaterial())}const i=this.particleSystemList||e.particleSystems;for(const n of i)n.isReady()||(s=!1);return this._engine.currentRenderPassId=t,s}_prepareRenderingManager(e=0,t=!1){const s=this._scene;let r=null,i=0,n=!1;const a=this.renderList?this.renderList:s.frameGraph?s.meshes:s.getActiveMeshes().data,u=this.renderList?this.renderList.length:s.frameGraph?s.meshes.length:s.getActiveMeshes().length;if(this.getCustomRenderList&&(r=this.getCustomRenderList(e,a,u)),r)i=r.length,n=this.forceLayerMaskCheck;else{if(this._defaultRenderListPrepared&&!t)return a;this._defaultRenderListPrepared=!0,r=a,i=u,n=!this.renderList||this.forceLayerMaskCheck}const h=s.activeCamera,o=this.cameraForLOD??h,l=s.getBoundingBoxRenderer?.();if(s._activeMeshesFrozen&&this._isFrozen){if(this._renderingManager.resetSprites(),this.enableBoundingBoxRendering&&l){l.reset();for(let g=0;g<this._activeBoundingBoxes.length;g++){const p=this._activeBoundingBoxes.data[g];l.renderList.push(p)}}return r}this._renderingManager.reset(),this._activeMeshes.reset(),this._activeBoundingBoxes.reset(),l&&l.reset();const _=s.getRenderId(),c=s.getFrameId();for(let g=0;g<i;g++){const p=r[g];if(p&&!p.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(p,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!p.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}let b=null;if(o){const P=p._internalAbstractMeshDataInfo._currentLOD.get(o);!P||P[1]!==c?(b=s.customLODSelector?s.customLODSelector(p,o):p.getLOD(o),P?(P[0]=b,P[1]=c):p._internalAbstractMeshDataInfo._currentLOD.set(o,[b,c])):b=P[0]}else b=p;if(!b)continue;b!==p&&b.billboardMode!==0&&b.computeWorldMatrix(),b._preActivateForIntermediateRendering(_);let x;if(n&&h?x=(p.layerMask&h.layerMask)===0:x=!1,p.isEnabled()&&p.isVisible&&p.subMeshes&&!x){if(this._activeMeshes.push(p),b._internalAbstractMeshDataInfo._wasActiveLastFrame=!0,b!==p&&b._activate(_,!0),this.enableBoundingBoxRendering&&l&&l._preActiveMesh(p),p._activate(_,!0)&&p.subMeshes.length){p.isAnInstance?p._internalAbstractMeshDataInfo._actAsRegularMesh&&(b=p):b._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,b._internalAbstractMeshDataInfo._isActiveIntermediate=!0,s._prepareSkeleton(b);for(let P=0;P<b.subMeshes.length;P++){const A=b.subMeshes[P];this.enableBoundingBoxRendering&&l&&l._evaluateSubMesh(p,A),this._renderingManager.dispatch(A,b)}}p._postActivate()}}}if(this.enableBoundingBoxRendering&&l&&t)for(let g=0;g<l.renderList.length;g++){const p=l.renderList.data[g];this._activeBoundingBoxes.push(p)}if(this._scene.particlesEnabled){this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);const g=this.particleSystemList||s.particleSystems;for(let p=0;p<g.length;p++){const b=g[p],x=b.emitter;!b.isStarted()||!x||x.position&&!x.isEnabled()||this._renderingManager.dispatchParticles(b)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}return r}get renderingManager(){return this._renderingManager}setRenderingOrder(e,t=null,s=null,r=null){this._renderingManager.setRenderingOrder(e,t,s,r)}setRenderingAutoClearDepthStencil(e,t,s=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,s,r),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=new E(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}dispose(){const e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let s=0;s<t;s++){const r=e[s];r&&r.getMaterialForRenderPass(this.renderPassId)!==void 0&&r.setMaterialForRenderPass(this.renderPassId,void 0)}if(this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null,this._sceneUBOs)for(const s of this._sceneUBOs)s.dispose();this._sceneUBOs=void 0,this._scene.removeObjectRenderer(this)}_rebuild(){this.refreshRate===E.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=E.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}E.REFRESHRATE_RENDER_ONCE=0;E.REFRESHRATE_RENDER_ONEVERYFRAME=1;E.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;z.prototype.setDepthStencilTexture=function(d,e){this._engine.setDepthStencilTexture(this._samplers[d],this._uniforms[d],e,d)};class L extends I{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get enableBoundingBoxRendering(){return this._objectRenderer.enableBoundingBoxRendering}set enableBoundingBoxRendering(e){this._objectRenderer.enableBoundingBoxRendering=e}get enableOutlineRendering(){return this._objectRenderer.enableOutlineRendering}set enableOutlineRendering(e){this._objectRenderer.enableOutlineRendering=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(e){this._objectRenderer.cameraForLOD=e}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(e){this._objectRenderer.disableImageProcessing=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){return this._renderTarget?.isMulti??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(e,t,s,r=!1,i=!0,n=0,a=!1,u=I.TRILINEAR_SAMPLINGMODE,h=!0,o=!1,l=!1,_=5,c=!1,g,p,b=!1,x=!1){let P,A=!0,D;if(typeof r=="object"){const R=r;r=!!R.generateMipMaps,i=R.doNotChangeAspectRatio??!0,n=R.type??0,a=!!R.isCube,u=R.samplingMode??I.TRILINEAR_SAMPLINGMODE,h=R.generateDepthBuffer??!0,o=!!R.generateStencilBuffer,l=!!R.isMulti,_=R.format??5,c=!!R.delayAllocation,g=R.samples,p=R.creationFlags,b=!!R.noColorAttachment,x=!!R.useSRGBBuffer,P=R.colorAttachment,A=R.gammaSpace??A,D=R.existingObjectRenderer}if(super(null,s,!r,void 0,u,void 0,void 0,void 0,void 0,_),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new v,this.onAfterUnbindObservable=new v,this.onClearObservable=new v,this.onResizeObservable=new v,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=k.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,s=this.getScene(),!s)return;const m=this.getScene().getEngine();this._gammaSpace=A,this._coordinatesMode=I.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!D,this._processSizeParameter(t),this._objectRenderer=D??new E(e,s,{numPasses:a?6:this.getRenderLayers()||1,doNotChangeAspectRatio:i}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(const R of this._scene._beforeRenderTargetClearStage)R.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(m):this.skipInitialClear||m.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const R of this._scene._beforeRenderTargetDrawStage)R.action(this,this._currentFaceIndex,this._currentLayer)}),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(const G of this._scene._afterRenderTargetDrawStage)G.action(this,this._currentFaceIndex,this._currentLayer);const R=this._texture?.generateMipMaps??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const G of this._scene._afterRenderTargetPostProcessStage)G.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=R),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),m):w.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(m):this.skipInitialClear||m.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=m.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=i,!l&&(this._renderTargetOptions={generateMipMaps:r,type:n,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:o,samples:g,creationFlags:p,noColorAttachment:b,useSRGBBuffer:x,colorAttachment:P,label:this.name},this.samplingMode===I.NEAREST_SAMPLINGMODE&&(this.wrapU=I.CLAMP_ADDRESSMODE,this.wrapV=I.CLAMP_ADDRESSMODE),c||(a?(this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=I.INVCUBIC_MODE,this._textureMatrix=Q.Identity()):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,g!==void 0&&(this.samples=g)))}createDepthStencilTexture(e=0,t=!0,s=!1,r=1,i=14,n){this._renderTarget?.createDepthStencilTexture(e,t,s,r,i,n)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){return this._renderTarget?.samples??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new ce(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;const t=this._size.depth;return t||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){const t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;const s=this.getScene();s&&(this._processSizeParameter(e),t?this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,U(()=>import("./dumpTools.BH_DO4LZ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])).then(t=>this._dumpTools=t)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){const s=this.getScene();if(s){if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),(this.is2DArray||this.is3D)&&!this.isMulti)for(let r=0;r<this.getRenderLayers();r++)this._renderToTarget(0,e,t,r),s.incrementRenderId(),s.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let r=0;r<6;r++)this._renderToTarget(r,e,t),s.incrementRenderId(),s.resetCachedMaterial();else this._renderToTarget(0,e,t);this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){const r=e*t,i=se(r+16384/(128+r));return Math.min(te(e),i)}_bindFrameBuffer(e=0,t=0){const s=this.getScene();if(!s)return;const r=s.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,s,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(t,s):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,s)}_renderToTarget(e,t,s,r=0){const i=this.getScene();if(!i)return;const n=i.getEngine();this._currentFaceIndex=e,this._currentLayer=r,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=s,this._prepareFrame(i,e,r,t),n._debugPushGroup?.(`render to face #${e} layer #${r}`,2),this._objectRenderer.render(e+r,!0),n._debugPopGroup?.(2),this._unbindFrameBuffer(n,e),this._texture&&this.isCube&&e===5&&n.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,s=null,r=null){this._objectRenderer.setRenderingOrder(e,t,s,r)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){const e=this.getSize(),t=new L(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){this._renderTarget?.dispose(!0)}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const s of e.cameras)t=s.customRenderTargets.indexOf(this),t>=0&&s.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}L.REFRESHRATE_RENDER_ONCE=E.REFRESHRATE_RENDER_ONCE;L.REFRESHRATE_RENDER_ONEVERYFRAME=E.REFRESHRATE_RENDER_ONEVERYFRAME;L.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=E.REFRESHRATE_RENDER_ONEVERYTWOFRAMES;I._CreateRenderTargetTexture=(d,e,t,s,r)=>new L(d,e,t,s);class pe{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,s=!0){this.effect=e,t!==void 0&&(this.defines=t),s&&this.drawContext?.reset()}dispose(e=!1){if(this.effect){const t=this.effect;e?t.dispose():re.SetImmediate(()=>{t.getEngine().onEndFrameObservable.addOnce(()=>{t.dispose()})}),this.effect=null}this.drawContext?.dispose()}}const j="postprocessVertexShader",Z=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;K.ShadersStore[j]||(K.ShadersStore[j]=Z);const ge={name:j,shader:Z},J=Object.freeze(Object.defineProperty({__proto__:null,postprocessVertexShader:ge},Symbol.toStringTag,{value:"Module"})),W={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Te{constructor(e,t=W){this._fullscreenViewport=new le(0,0,1,1);const s=t.positions??W.positions,r=t.indices??W.indices;this.engine=e,this._vertexBuffers={[f.PositionKind]:new f(e,s,f.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._indexBufferLength=r.length,this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(r);for(const i in this._vertexBuffers)this._vertexBuffers[i]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e,t=!1,s=!1){this.engine.setState(!0),this.engine.depthCullingState.depthTest=t,this.engine.stencilState.stencilTest=s,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const s=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;s&&this.engine.bindFramebuffer(s),this.applyEffectWrapper(e),this.draw(),s&&this.engine.unBindFramebuffer(s),this.restoreStates()}dispose(){const e=this._vertexBuffers[f.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[f.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class y{static RegisterShaderCodeProcessing(e,t){if(!t){delete y._CustomShaderCodeProcessing[e??""];return}y._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){return y._CustomShaderCodeProcessing[e]??y._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){return this._drawWrapper.effect?.isReady()??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new v(void 0,!0),this.onApplyObservable=new v,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1,allowEmptySourceTexture:e.allowEmptySourceTexture??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(!this.options.allowEmptySourceTexture&&this.options.samplers.indexOf("textureSampler")===-1&&this.options.samplers.push("textureSampler"),this.options.uniforms.indexOf("scale")===-1&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new pe(this.options.engine),this._webGPUReady=this.options.shaderLanguage===1;const t=Array.isArray(this.options.defines)?this.options.defines.join(`
`):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations)}_gatherImports(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([U(()=>import("./postprocess.vertex.BN-gUg4C.js"),__vite__mapDeps([16,5,3,4,1]))])):t.push(Promise.all([U(()=>Promise.resolve().then(()=>J),void 0)])))}_postConstructor(e,t=null,s,r){this._importPromises.length=0,r&&this._importPromises.push(...r);const i=this.options.engine.isWebGPU&&!y.ForceGLSL;this._gatherImports(i,this._importPromises),s!==void 0&&s(i,this._importPromises),i&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,s=null,r,i,n,a,u){const h=y._GetShaderCodeProcessing(this.name);if(h?.defineCustomBindings){const _=t?.slice()??[];_.push(...this.options.uniforms);const c=s?.slice()??[];c.push(...this.options.samplers),e=h.defineCustomBindings(this.name,e,_,c),t=_,s=c}this.options.defines=e||"";const o=this._shadersLoaded||this._importPromises.length===0?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let l;this.options.extraInitializationsAsync?l=async()=>{o?.(),await this.options.extraInitializationsAsync()}:l=o,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:a??this._shaderPath.vertex,fragment:u??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:s||this.options.samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:i??this.options.onCompiled,onError:n??null,indexParameters:r||this.options.indexParameters,processCodeAfterIncludes:h?.processCodeAfterIncludes?(_,c)=>h.processCodeAfterIncludes(this.name,_,c):null,processFinalCode:h?.processFinalCode?(_,c)=>h.processFinalCode(this.name,_,c):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:l},this.options.engine):this._drawWrapper.effect=new z(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,s||this.options.samplerNames,this.options.engine,e,void 0,i||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,l),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(e=!1){this.options.useAsPostProcess&&!e&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),y._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}y.ForceGLSL=!1;y._CustomShaderCodeProcessing={};X.prototype.setTextureFromPostProcess=function(d,e,t){let s=null;e&&(e._forcedOutputTexture?s=e._forcedOutputTexture:e._textures.data[e._currentRenderTextureInd]&&(s=e._textures.data[e._currentRenderTextureInd])),this._bindTexture(d,s?.texture??null,t)};X.prototype.setTextureFromPostProcessOutput=function(d,e,t){this._bindTexture(d,e?._outputTexture?.texture??null,t)};z.prototype.setTextureFromPostProcess=function(d,e){this._engine.setTextureFromPostProcess(this._samplers[d],e,d)};z.prototype.setTextureFromPostProcessOutput=function(d,e){this._engine.setTextureFromPostProcessOutput(this._samplers[d],e,d)};class S{static get ForceGLSL(){return y.ForceGLSL}static set ForceGLSL(e){y.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){y.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,s,r,i,n,a=1,u,h,o=null,l=0,_="postprocess",c,g=!1,p=5,b,x){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new B(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new V(1,1),this._texelSize=V.Zero(),this.onActivateObservable=new v,this.onSizeChangedObservable=new v,this.onApplyObservable=new v,this.onBeforeRenderObservable=new v,this.onAfterRenderObservable=new v,this.onDisposeObservable=new v;let P=1,A=null,D;if(s&&!Array.isArray(s)){const m=s;s=m.uniforms??null,r=m.samplers??null,P=m.size??1,n=m.camera??null,a=m.samplingMode??1,u=m.engine,h=m.reusable,o=Array.isArray(m.defines)?m.defines.join(`
`):m.defines??null,l=m.textureType??0,_=m.vertexUrl??"postprocess",c=m.indexParameters,g=m.blockCompilation??!1,p=m.textureFormat??5,b=m.shaderLanguage??0,A=m.uniformBuffers??null,x=m.extraInitializations,D=m.effectWrapper}else i&&(typeof i=="number"?P=i:P={width:i.width,height:i.height});if(this._useExistingThinPostProcess=!!D,this._effectWrapper=D??new y({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:u||n?.getScene().getEngine(),uniforms:s,samplers:r,uniformBuffers:A,defines:o,vertexUrl:_,indexParameters:c,blockCompilation:!0,shaderLanguage:b,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,n!=null?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.addPostProcess(this),this.uniqueId=this._scene.getUniqueId()):u&&(this._engine=u,this._engine.postProcesses.push(this)),this._options=P,this.renderTargetSamplingMode=a||1,this._reusable=h||!1,this._textureType=l,this._textureFormat=p,this._shaderLanguage=b||0,this._samplers=r||[],this._samplers.indexOf("textureSampler")===-1&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=_,this._parameters=s||[],this._parameters.indexOf("scale")===-1&&this._parameters.push("scale"),this._uniformBuffers=A||[],this._indexParameters=c,!this._useExistingThinPostProcess){this._webGPUReady=this._shaderLanguage===1;const m=[];this._gatherImports(this._engine.isWebGPU&&!S.ForceGLSL,m),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(g,o,x,m)}}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([U(()=>import("./postprocess.vertex.BN-gUg4C.js"),__vite__mapDeps([16,5,3,4,1]))])):t.push(Promise.all([U(()=>Promise.resolve().then(()=>J),void 0)]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new B(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,s=null,r,i,n,a,u){this._effectWrapper.updateEffect(e,t,s,r,i,n,a,u),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join(`
`):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,s=0){for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture.width===e.width&&this._textureCache[i].texture.height===e.height&&this._textureCache[i].postProcessChannel===s&&this._textureCache[i].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[i].texture.samples===t.samples)return this._textureCache[i].texture;const r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:s,lastUsedRenderId:-1}),r}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let s=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){s=!0;break}s||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,s=null,r=!1,i=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(s){for(let h=0;h<s._postProcesses.length;h++)if(s._postProcesses[h]!==null){n=s._postProcesses[h];break}}const a={width:this.width,height:this.height},u={generateMipMaps:r,generateDepthBuffer:i||n===this,generateStencilBuffer:(i||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,u,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,u,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture===e){t=this._textureCache[s];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,s){const r=e===null||e.cameraRigMode!==void 0?e||this._camera:null,i=r?.getScene()??e,n=i.getEngine(),a=n.getCaps().maxTextureSize,u=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let o=this._options.width||u,l=this._options.height||h;const _=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;let c=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const g=n.currentViewport;g&&(o*=g.width,l*=g.height)}(_||this.alwaysForcePOT)&&(this._options.width||(o=n.needPOTTextures?q(o,a,this.scaleMode):o),this._options.height||(l=n.needPOTTextures?q(l,a,this.scaleMode):l)),(this.width!==o||this.height!==l||!(c=this._getTarget()))&&this.resize(o,l,r,_,s),this._textures.forEach(g=>{g.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(g,this.samples)}),this._flushTextureCache(),this._renderId++}return c||(c=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(u/o,h/l),this._engine.bindFramebuffer(c,0,u,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(c,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(r),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:i.clearColor,i._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),c}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode);let e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures();let t;if(this._scene&&(t=this._scene.removePostProcess(this)),this._parentContainer){const s=this._parentContainer.postProcesses.indexOf(this);s>-1&&this._parentContainer.postProcesses.splice(s,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),this.onDisposeObservable.notifyObservers(),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const s=this._camera._getFirstPostProcess();s&&s.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const e=H.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=S.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,s){const r=he(e.customType);if(!r||!r._Parse)return null;const i=t?t.getCameraById(e.cameraId):null;return r._Parse(e,i,t,s)}static _Parse(e,t,s,r){return H.Parse(()=>new S(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,s,r)}}C([T()],S.prototype,"uniqueId",void 0);C([T()],S.prototype,"name",null);C([T()],S.prototype,"width",void 0);C([T()],S.prototype,"height",void 0);C([T()],S.prototype,"renderTargetSamplingMode",void 0);C([ie()],S.prototype,"clearColor",void 0);C([T()],S.prototype,"autoClear",void 0);C([T()],S.prototype,"forceAutoClearInAlphaMode",void 0);C([T()],S.prototype,"alphaMode",null);C([T()],S.prototype,"alphaConstants",void 0);C([T()],S.prototype,"enablePixelPerfectMode",void 0);C([T()],S.prototype,"forceFullscreenViewport",void 0);C([T()],S.prototype,"scaleMode",void 0);C([T()],S.prototype,"alwaysForcePOT",void 0);C([T("samples")],S.prototype,"_samples",void 0);C([T()],S.prototype,"adaptScaleToCurrentViewport",void 0);oe("BABYLON.PostProcess",S);export{$ as B,Ce as C,pe as D,Te as E,E as O,S as P,L as R,f as V,y as a,O as b,ce as c};
