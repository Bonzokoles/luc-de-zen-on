const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/dds.CeNvnj7I.js","_astro/math.color.BvxHr_bk.js","_astro/decorators.serialization.DTWIlLMH.js","_astro/math.vector.C8FsJn6B.js","_astro/preload-helper.BlTxHScW.js","_astro/passPostProcess.C_qZ8mVx.js","_astro/postProcess.BhJOrjOy.js","_astro/texture.DcuyhkEj.js","_astro/baseTexture.xJCKUhPX.js","_astro/math.size.F3xmSqZc.js","_astro/instantiationTools.DpJ04vA6.js","_astro/math.plane.DogzNArm.js","_astro/smartArray.BsIpkRz3.js","_astro/math.viewport.CgkTt1RS.js","_astro/math.axis.BWIUWoG3.js","_astro/math.path.Rz-CSHk9.js"])))=>i.map(i=>d[i]);
import{A as d,w as Z,z as Q,L as M,B as X,C as le,H as _e,J as he,K as ue,O as oe,Q as ce,U as fe,V as Ee,X as Te,Y as de,Z as ge,n as w,x as $,$ as pe,I as J,a0 as Re,P as H,l as Y,a1 as Ae,a2 as te,u as be}from"./decorators.serialization.DTWIlLMH.js";import{V as b,T as x,E as W}from"./math.vector.C8FsJn6B.js";import{_ as me}from"./preload-helper.BlTxHScW.js";import"./math.axis.BWIUWoG3.js";import"./math.color.BvxHr_bk.js";import"./math.plane.DogzNArm.js";import"./math.path.Rz-CSHk9.js";import{B as Se}from"./baseTexture.xJCKUhPX.js";function xe(i){return i.getPipelineContext===void 0}class Fe{constructor(){this.shaderLanguage=0}postProcessor(e,t,r,s,n){if(n.drawBuffersExtensionDisabled){const a=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(a,"")}return e}}const Pe=/(flat\s)?\s*varying\s*.*/;class Ie{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return Pe.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,r){const s=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,n=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(n,""),e=e.replace(/texture2D\s*\(/g,"texture("),r){const a=e.search(/layout *\(location *= *0\) *out/g)!==-1,h=t.indexOf("#define DUAL_SOURCE_BLENDING")!==-1,l=h?`layout(location = 0, index = 0) out vec4 glFragColor;
layout(location = 0, index = 1) out vec4 glFragColor2;
`:`layout(location = 0) out vec4 glFragColor;
`;h&&(e=`#extension GL_EXT_blend_func_extended : require
`+e),e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(s||a?"":l)+"void main(")}else if(t.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0&&(e=`invariant gl_Position;
`+e),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class q{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=q._Counter++}}q._Counter=0;class V extends q{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class re{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}function ee(i){return i===13||i===14||i===15||i===16||i===17||i===18||i===19}function k(i){return i===13||i===17||i===18||i===19}class Be{}class g extends d{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return Z.ShadersRepository}static set ShadersRepository(e){Z.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,r,s){if(r=r||{},super(t??r.antialias,r,s),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let n=null;if(e.getContext){if(n=e,r.preserveDrawingBuffer===void 0&&(r.preserveDrawingBuffer=!1),r.xrCompatible===void 0&&(r.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const l=navigator.userAgent;for(const _ of g.ExceptionList){const u=_.key,f=_.targets;if(new RegExp(u).test(l)){if(_.capture&&_.captureConstraint){const c=_.capture,A=_.captureConstraint,R=new RegExp(c).exec(l);if(R&&R.length>0&&parseInt(R[R.length-1])>=A)continue}for(const c of f)switch(c){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":r.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{Q(this._gl)}:(this._onContextLost=l=>{l.preventDefault(),this._contextWasLost=!0,Q(this._gl),M.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},n.addEventListener("webglcontextrestored",this._onContextRestored,!1),r.powerPreference=r.powerPreference||"high-performance"),n.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(r.xrCompatible=!1),!r.disableWebGL2Support)try{this._gl=n.getContext("webgl2",r)||n.getContext("experimental-webgl2",r),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!n)throw new Error("The provided canvas is null or undefined.");try{this._gl=n.getContext("webgl",r)||n.getContext("experimental-webgl",r)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,n=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const l=this._gl.getContextAttributes();l&&(r.stencil=l.stencil)}this._sharedInit(n),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),r.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=r.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let l=0;l<this._caps.maxVertexAttribs;l++)this._currentBufferPointers[l]=new Be;this._shaderProcessor=this.webGLVersion>1?new Ie:new Fe;const a=`Babylon.js v${g.Version}`;M.Log(a+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",a);const h=X(this._gl);h.validateShaderPrograms=this.validateShaderPrograms,h.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),shaderFloatPrecision:0,parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),blendFloat:this._gl.getExtension("EXT_float_blend")!==null,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16"),blendParametersPerTarget:!1,dualSourceBlending:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763);const t=this._gl.getExtension("OES_draw_buffers_indexed");if(this._caps.blendParametersPerTarget=!!t,this._alphaState=new le(this._caps.blendParametersPerTarget),t&&(this._gl.blendEquationSeparateIndexed=t.blendEquationSeparateiOES.bind(t),this._gl.blendEquationIndexed=t.blendEquationiOES.bind(t),this._gl.blendFuncSeparateIndexed=t.blendFuncSeparateiOES.bind(t),this._gl.blendFuncIndexed=t.blendFunciOES.bind(t),this._gl.colorMaskIndexed=t.colorMaskiOES.bind(t),this._gl.disableIndexed=t.disableiOES.bind(t),this._gl.enableIndexed=t.enableiOES.bind(t)),this._caps.dualSourceBlending=!!this._gl.getExtension("WEBGL_blend_func_extended"),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const r=this._gl.getExtension("WEBGL_draw_buffers");if(r!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=r.drawBuffersWEBGL.bind(r),this._caps.maxDrawBuffers=this._gl.getParameter(r.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let s=0;s<16;s++)this._gl["COLOR_ATTACHMENT"+s+"_WEBGL"]=r["COLOR_ATTACHMENT"+s+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const r=this._gl.getExtension("WEBGL_depth_texture");r!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=r.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const r=this._gl.getExtension("OES_vertex_array_object");r!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=r.createVertexArrayOES.bind(r),this._gl.bindVertexArray=r.bindVertexArrayOES.bind(r),this._gl.deleteVertexArray=r.deleteVertexArrayOES.bind(r))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const r=this._gl.getExtension("ANGLE_instanced_arrays");r!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=r.drawArraysInstancedANGLE.bind(r),this._gl.drawElementsInstanced=r.drawElementsInstancedANGLE.bind(r),this._gl.vertexAttribDivisor=r.vertexAttribDivisorANGLE.bind(r)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const r=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),s=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);if(r&&s&&(this._caps.highPrecisionShaderSupported=r.precision!==0&&s.precision!==0,this._caps.shaderFloatPrecision=Math.min(r.precision,s.precision)),!this._shouldUseHighPrecisionShader){const n=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.MEDIUM_FLOAT),a=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.MEDIUM_FLOAT);n&&a&&(this._caps.shaderFloatPrecision=Math.min(n.precision,a.precision))}this._caps.shaderFloatPrecision<10&&(this._caps.shaderFloatPrecision=10)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const r=this._gl.getExtension("EXT_blend_minmax");r!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=r.MAX_EXT,this._gl.MIN=r.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const r=this._gl.getExtension("EXT_sRGB");r!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:r.SRGB_EXT,SRGB8:r.SRGB_ALPHA_EXT,SRGB8_ALPHA8:r.SRGB_ALPHA_EXT})}if(this._creationOptions){const r=this._creationOptions.forceSRGBBufferSupportState;r!==void 0&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&r)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let r=0;r<this._maxSimultaneousTextures;r++)this._nextFreeTextureSlots.push(r);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>"u",supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportIBLShadows:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,r,s=!1,n=0){const a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;let h=0;if(t&&e){let l=!0;if(this._currentRenderTarget){const _=this._currentRenderTarget.texture?.format;if(_===8||_===9||_===10||_===11){const u=this._currentRenderTarget.texture?.type;u===7||u===5?(g._TempClearColorUint32[0]=e.r*255,g._TempClearColorUint32[1]=e.g*255,g._TempClearColorUint32[2]=e.b*255,g._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,g._TempClearColorUint32),l=!1):(g._TempClearColorInt32[0]=e.r*255,g._TempClearColorInt32[1]=e.g*255,g._TempClearColorInt32[2]=e.b*255,g._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,g._TempClearColorInt32),l=!1)}}l&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),h|=this._gl.COLOR_BUFFER_BIT)}r&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),h|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(n),h|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(h)}_viewport(e,t,r,s){(e!==this._viewportCached.x||t!==this._viewportCached.y||r!==this._viewportCached.z||s!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=r,this._viewportCached.w=s,this._gl.viewport(e,t,r,s))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,r,s,n,a=0,h=0){const l=e;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._framebuffer);const _=this._gl;e.isMulti||(e.is2DArray||e.is3D?(_.framebufferTextureLayer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,a,h),l._currentLOD=a):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,a):l._currentLOD!==a&&(_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,a),l._currentLOD=a));const u=e._depthStencilTexture;if(u){e.is3D&&(e.texture.width!==u.width||e.texture.height!==u.height||e.texture.depth!==u.depth)&&M.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment");const f=e._depthStencilTextureWithStencil?_.DEPTH_STENCIL_ATTACHMENT:_.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?_.framebufferTextureLayer(_.FRAMEBUFFER,f,u._hardwareTexture?.underlyingResource,a,h):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,f,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,u._hardwareTexture?.underlyingResource,a):_.framebufferTexture2D(_.FRAMEBUFFER,f,_.TEXTURE_2D,u._hardwareTexture?.underlyingResource,a)}l._MSAAFramebuffer&&this._bindUnboundFramebuffer(l._MSAAFramebuffer),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,r,s):(r||(r=e.width,a&&(r=r/Math.pow(2,a))),s||(s=e.height,a&&(s=s/Math.pow(2,a))),this._viewport(0,0,r,s)),this.wipeCaches()}setStateCullFaceType(e,t){const r=this.cullBackFaces??e??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==r||t)&&(this._depthCullingState.cullFace=r)}setState(e,t=0,r,s=!1,n,a,h=0){(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(n,r),this.setZOffset(t),this.setZOffsetUnits(h);const l=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||r)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=a}_resolveAndGenerateMipMapsFramebuffer(e,t=!1){e.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e))}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t,r){const s=e;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(e,t),r&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),r()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(e){!e.isMulti&&e.texture?.generateMipMaps&&!e.isCube&&this.generateMipmaps(e.texture)}resolveFramebuffer(e){const t=e,r=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let s=t.resolveMSAAColors?r.COLOR_BUFFER_BIT:0;s|=t._generateDepthBuffer&&t.resolveMSAADepth?r.DEPTH_BUFFER_BIT:0,s|=t._generateStencilBuffer&&t.resolveMSAAStencil?r.STENCIL_BUFFER_BIT:0,r.bindFramebuffer(r.READ_FRAMEBUFFER,t._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,t._framebuffer),r.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s,r.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,r){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const r=this._gl.createBuffer();if(!r)throw new Error("Unable to create vertex buffer");const s=new V(r);return this.bindArrayBuffer(s),typeof e!="number"?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),s.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),s.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),s.capacity=e),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,r){const s=this._gl.createBuffer(),n=new V(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);const a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=a.BYTES_PER_ELEMENT===4,n}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let r=0;r<e.length;r++)if(e[r]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,r){const s=e.program,n=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,n,r)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,r,s,n,a,h){const l=this._currentBufferPointers[t];if(!l)return;let _=!1;l.active?(l.buffer!==e&&(l.buffer=e,_=!0),l.size!==r&&(l.size=r,_=!0),l.type!==s&&(l.type=s,_=!0),l.normalized!==n&&(l.normalized=n,_=!0),l.stride!==a&&(l.stride=a,_=!0),l.offset!==h&&(l.offset=h,_=!0)):(_=!0,l.active=!0,l.index=t,l.size=r,l.type=s,l.normalized=n,l.stride=a,l.offset=h,l.buffer=e),(_||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,r,s,a,h):this._gl.vertexAttribPointer(t,r,s,n,a,h))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,r){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let n=0;n<s.length;n++){const a=t.getAttributeLocation(n);if(a>=0){const h=s[n];let l=null;if(r&&(l=r[h]),l||(l=e[h]),!l)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);const _=l.getBuffer();_&&(this._vertexAttribPointer(_,a,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(_))))}}}recordVertexArrayObject(e,t,r,s){const n=this._gl.createVertexArray();if(!n)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(n),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,r,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),n}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,r,s,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n;const a=n.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let h=0;for(let l=0;l<a;l++)if(l<r.length){const _=n.getAttributeLocation(l);_>=0&&(this._gl.enableVertexAttribArray(_),this._vertexAttribArraysEnabled[_]=!0,this._vertexAttribPointer(e,_,r[l],this._gl.FLOAT,!1,s,h)),h+=r[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,r,s){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r,this._bindVertexBuffersAttributes(e,r,s)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,r=this._currentInstanceLocations.length;t<r;t++){const s=this._currentInstanceBuffers[t];e!=s&&s.references&&(e=s,this.bindArrayBuffer(s));const n=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(n,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,r){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),r[0].index!==void 0)this.bindInstancesBuffer(e,r,!0);else for(let s=0;s<4;s++){const n=r[s];this._vertexAttribArraysEnabled[n]||(this._gl.enableVertexAttribArray(n),this._vertexAttribArraysEnabled[n]=!0),this._vertexAttribPointer(e,n,4,this._gl.FLOAT,!1,64,s*16),this._gl.vertexAttribDivisor(n,1),this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,r=!0){this.bindArrayBuffer(e);let s=0;if(r)for(let n=0;n<t.length;n++){const a=t[n];s+=a.attributeSize*4}for(let n=0;n<t.length;n++){const a=t[n];a.index===void 0&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(e,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,s,a.offset),this._gl.vertexAttribDivisor(a.index,a.divisor===void 0?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,r;for(;(r=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(r,1),this._currentInstanceBuffers.splice(r,1),t=!0,r=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,r,s){this.drawElementsType(e?0:1,t,r,s)}drawPointClouds(e,t,r){this.drawArraysType(2,e,t,r)}drawUnIndexed(e,t,r,s){this.drawArraysType(e?0:1,t,r,s)}drawElementsType(e,t,r,s){this.applyStates(),this._reportDrawCall();const n=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,h=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(n,r,a,t*h,s):this._gl.drawElements(n,r,a,t*h)}drawArraysType(e,t,r,s){this.applyStates(),this._reportDrawCall();const n=this._drawMode(e);s?this._gl.drawArraysInstanced(n,t,r,s):this._gl.drawArrays(n,t,r)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,_e(t),this._gl&&(this._currentProgram===t.program&&this._setProgram(null),this._gl.deleteProgram(t.program)))}_getGlobalDefines(e){return he(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,r,s,n,a,h,l,_,u=0,f){const p=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,c=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,A=this._getGlobalDefines(),S=t.attributes!==void 0;let R=n??t.defines??"";A&&(R+=A);const E=p+"+"+c+"@"+R;if(this._compiledEffects[E]){const P=this._compiledEffects[E];return h&&P.isReady()&&h(P),P._refCount++,P}this._gl&&X(this._gl);const T=new Z(e,t,S?this:r,s,this,n,a,h,l,_,E,t.shaderLanguage??u,t.extraInitializationsAsync??f);return this._compiledEffects[E]=T,T}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,r,s,n=null){const a=X(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,ue(e,t,r,s||this._gl,n)}createShaderProgram(e,t,r,s,n,a=null){const h=X(this._gl);return h._contextWasLost=this._contextWasLost,h.validateShaderPrograms=this.validateShaderPrograms,oe(e,t,r,s,n||this._gl,a)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){const r=X(this._gl);r.parallelShaderCompile=this._caps.parallelShaderCompile}const t=ce(this._gl);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return fe(e,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(e,t,r,s,n,a,h,l,_,u,f){const p=X(this._gl);return p._contextWasLost=this._contextWasLost,p.validateShaderPrograms=this.validateShaderPrograms,p._createShaderProgramInjection=this._createShaderProgram.bind(this),p.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),p.createShaderProgramInjection=this.createShaderProgram.bind(this),p.loadFileInjection=this._loadFile.bind(this),Ee(e,t,r,s,n,a,h,l,_,u,f)}_createShaderProgram(e,t,r,s,n=null){return Te(e,t,r,s,n)}_isRenderingStateCompiled(e){return this._isDisposed?!1:de(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){ge(e,t)}getUniforms(e,t){const r=new Array,s=e;for(let n=0;n<t.length;n++)r.push(this._gl.getUniformLocation(s.program,t[n]));return r}getAttributes(e,t){const r=[],s=e;for(let n=0;n<t.length;n++)try{r.push(this._gl.getAttribLocation(s.program,t[n]))}catch{r.push(-1)}return r}enableEffect(e){e=e!==null&&xe(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,r){return e?(this._gl.uniform2i(e,t,r),!0):!1}setInt3(e,t,r,s){return e?(this._gl.uniform3i(e,t,r,s),!0):!1}setInt4(e,t,r,s,n){return e?(this._gl.uniform4i(e,t,r,s,n),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,r){return e?(this._gl.uniform2ui(e,t,r),!0):!1}setUInt3(e,t,r,s){return e?(this._gl.uniform3ui(e,t,r,s),!0):!1}setUInt4(e,t,r,s,n){return e?(this._gl.uniform4ui(e,t,r,s,n),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,r){return e?(this._gl.uniform2f(e,t,r),!0):!1}setFloat3(e,t,r,s){return e?(this._gl.uniform3f(e,t,r,s),!0):!1}setFloat4(e,t,r,s,n){return e?(this._gl.uniform4f(e,t,r,s,n),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl,this._currentRenderTarget&&this._currentRenderTarget.textures?this._currentRenderTarget.textures.length:1),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._resetAlphaMode(),this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const r=this._gl;let s=r.NEAREST,n=r.NEAREST,a=!1;switch(e){case 11:s=r.LINEAR,t?n=r.LINEAR_MIPMAP_NEAREST:n=r.LINEAR;break;case 3:s=r.LINEAR,a=!0,t?n=r.LINEAR_MIPMAP_LINEAR:n=r.LINEAR;break;case 8:a=!0,s=r.NEAREST,t?n=r.NEAREST_MIPMAP_LINEAR:n=r.NEAREST;break;case 4:s=r.NEAREST,t?n=r.NEAREST_MIPMAP_NEAREST:n=r.NEAREST;break;case 5:s=r.NEAREST,t?n=r.LINEAR_MIPMAP_NEAREST:n=r.LINEAR;break;case 6:a=!0,s=r.NEAREST,t?n=r.LINEAR_MIPMAP_LINEAR:n=r.LINEAR;break;case 7:s=r.NEAREST,n=r.LINEAR;break;case 1:s=r.NEAREST,n=r.NEAREST;break;case 9:s=r.LINEAR,t?n=r.NEAREST_MIPMAP_NEAREST:n=r.NEAREST;break;case 10:a=!0,s=r.LINEAR,t?n=r.NEAREST_MIPMAP_LINEAR:n=r.NEAREST;break;case 2:s=r.LINEAR,n=r.LINEAR;break;case 12:s=r.LINEAR,n=r.NEAREST;break}return{min:n,mag:s,hasMipMaps:a}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new re(this._createTexture(),this._gl)}_createInternalTexture(e,t,r=!0,s=0){let n=!1,a=!1,h=0,l=3,_=5,u=!1,f=1,p,c=!1,A=0;t!==void 0&&typeof t=="object"?(n=!!t.generateMipMaps,a=!!t.createMipMaps,h=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,_=t.format===void 0?5:t.format,u=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,f=t.samples??1,p=t.label,c=!!t.createMSAATexture,A=t.comparisonFunction||0):n=!!t,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(h===1&&!this._caps.textureFloatLinearFiltering||h===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),h===1&&!this._caps.textureFloat&&(h=0,M.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const S=ee(_),R=k(_),E=this._gl,T=new w(this,s),P=e.width||e,F=e.height||e,C=e.depth||0,I=e.layers||0,B=this._getSamplingParameters(l,(n||a)&&!S),m=I!==0?E.TEXTURE_2D_ARRAY:C!==0?E.TEXTURE_3D:E.TEXTURE_2D,U=S?this._getInternalFormatFromDepthTextureFormat(_,!0,R):this._getRGBABufferInternalSizedFormat(h,_,u),y=S?R?E.DEPTH_STENCIL:E.DEPTH_COMPONENT:this._getInternalFormat(_),D=S?this._getWebGLTextureTypeFromDepthTextureFormat(_):this._getWebGLTextureType(h);if(this._bindTextureDirectly(m,T),I!==0?(T.is2DArray=!0,E.texImage3D(m,0,U,P,F,I,0,y,D,null)):C!==0?(T.is3D=!0,E.texImage3D(m,0,U,P,F,C,0,y,D,null)):E.texImage2D(m,0,U,P,F,0,y,D,null),E.texParameteri(m,E.TEXTURE_MAG_FILTER,B.mag),E.texParameteri(m,E.TEXTURE_MIN_FILTER,B.min),E.texParameteri(m,E.TEXTURE_WRAP_S,E.CLAMP_TO_EDGE),E.texParameteri(m,E.TEXTURE_WRAP_T,E.CLAMP_TO_EDGE),S&&this.webGLVersion>1&&(A===0?(E.texParameteri(m,E.TEXTURE_COMPARE_FUNC,515),E.texParameteri(m,E.TEXTURE_COMPARE_MODE,E.NONE)):(E.texParameteri(m,E.TEXTURE_COMPARE_FUNC,A),E.texParameteri(m,E.TEXTURE_COMPARE_MODE,E.COMPARE_REF_TO_TEXTURE))),(n||a)&&this._gl.generateMipmap(m),this._bindTextureDirectly(m,null),T._useSRGBBuffer=u,T.baseWidth=P,T.baseHeight=F,T.width=P,T.height=F,T.depth=I||C,T.isReady=!0,T.samples=f,T.generateMipMaps=n,T.samplingMode=l,T.type=h,T.format=_,T.label=p,T.comparisonFunction=A,this._internalTexturesCache.push(T),c){let G=null;if(ee(T.format)?G=this._setupFramebufferDepthAttachments(k(T.format),T.format!==19,T.width,T.height,f,T.format,!0):G=this._createRenderBuffer(T.width,T.height,f,-1,this._getRGBABufferInternalSizedFormat(T.type,T.format,T._useSRGBBuffer),-1),!G)throw new Error("Unable to create render buffer");T._autoMSAAManagement=!0;let K=T._hardwareTexture;K||(K=T._hardwareTexture=this._createHardwareTexture()),K.addMSAARenderBuffer(G)}return T}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,r,s,n=3,a=null,h=null,l=null,_=null,u=null,f=null,p,c,A,S){return this._createTextureBase(e,t,r,s,n,a,h,(...R)=>this._prepareWebGLTexture(...R,u),(R,E,T,P,F,C)=>{const I=this._gl,B=T.width===R&&T.height===E;F._creationFlags=A??0;const m=this._getTexImageParametersForCreateTexture(F.format,F._useSRGBBuffer);if(B)return I.texImage2D(I.TEXTURE_2D,0,m.internalFormat,m.format,m.type,T),!1;const U=this._caps.maxTextureSize;if(T.width>U||T.height>U||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=R,this._workingCanvas.height=E,this._workingContext.drawImage(T,0,0,T.width,T.height,0,0,R,E),I.texImage2D(I.TEXTURE_2D,0,m.internalFormat,m.format,m.type,this._workingCanvas),F.width=R,F.height=E),!1;{const y=new w(this,2);this._bindTextureDirectly(I.TEXTURE_2D,y,!0),I.texImage2D(I.TEXTURE_2D,0,m.internalFormat,m.format,m.type,T),this._rescaleTexture(y,F,s,m.format,()=>{this._releaseTexture(y),this._bindTextureDirectly(I.TEXTURE_2D,F,!0),C()})}return!0},l,_,u,f,p,c,S)}_getTexImageParametersForCreateTexture(e,t){let r,s;return this.webGLVersion===1?(r=this._getInternalFormat(e,t),s=r):(r=this._getInternalFormat(e,!1),s=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:s,format:r,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,r,s,n){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,r=!1){const s=this._getTextureTarget(t),n=this._getSamplingParameters(e,t.useMipMaps||r);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,n.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,n.min),r&&n.hasMipMaps&&(t.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e}updateTextureDimensions(e,t,r,s=1){}updateTextureWrappingMode(e,t,r=null,s=null){const n=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),r!==null&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r),e),e._cachedWrapV=r),(e.is2DArray||e.is3D)&&s!==null&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(n,null)}_uploadCompressedDataToTextureDirectly(e,t,r,s,n,a=0,h=0){const l=this._gl;let _=l.TEXTURE_2D;if(e.isCube&&(_=l.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}if(e.generateMipMaps){const u=e._hardwareTexture;u.memoryAllocated||(l.texStorage2D(l.TEXTURE_2D,Math.floor(Math.log2(Math.max(r,s)))+1,t,e.width,e.height),u.memoryAllocated=!0),this._gl.compressedTexSubImage2D(_,h,0,0,r,s,t,n)}else this._gl.compressedTexImage2D(_,h,t,r,s,0,n)}_uploadDataToTextureDirectly(e,t,r=0,s=0,n,a=!1){const h=this._gl,l=this._getWebGLTextureType(e.type),_=this._getInternalFormat(e.format),u=n===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(n,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let f=h.TEXTURE_2D;e.isCube&&(f=h.TEXTURE_CUBE_MAP_POSITIVE_X+r);const p=Math.round(Math.log(e.width)*Math.LOG2E),c=Math.round(Math.log(e.height)*Math.LOG2E),A=a?e.width:Math.pow(2,Math.max(p-s,0)),S=a?e.height:Math.pow(2,Math.max(c-s,0));h.texImage2D(f,s,u,A,S,0,_,l,t)}updateTextureData(e,t,r,s,n,a,h=0,l=0,_=!1){const u=this._gl,f=this._getWebGLTextureType(e.type),p=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let c=u.TEXTURE_2D,A=u.TEXTURE_2D;e.isCube&&(A=u.TEXTURE_CUBE_MAP_POSITIVE_X+h,c=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(c,e,!0),u.texSubImage2D(A,l,r,s,n,a,p,f,t),_&&this._gl.generateMipmap(A),this._bindTextureDirectly(c,null)}_uploadArrayBufferViewToTexture(e,t,r=0,s=0){const n=this._gl,a=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,r,s),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(e,t,r,s,n){const a=this._gl;if(!a)return;const h=this._getSamplingParameters(n,!r);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,h.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,h.min),!r&&!s&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,r,s,n,a,h,l,_,u){const f=this.getCaps().maxTextureSize,p=Math.min(f,this.needPOTTextures?$(s.width,f):s.width),c=Math.min(f,this.needPOTTextures?$(s.height,f):s.height),A=this._gl;if(A){if(!e._hardwareTexture){r&&r.removePendingData(e);return}this._bindTextureDirectly(A.TEXTURE_2D,e,!0),this._unpackFlipY(n===void 0?!0:!!n),e.baseWidth=s.width,e.baseHeight=s.height,e.width=p,e.height=c,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:u??(t===".jpg"&&!e._useSRGBBuffer?4:5),!l(p,c,s,t,e,()=>{this._prepareWebGLTextureContinuation(e,r,a,h,_)})&&this._prepareWebGLTextureContinuation(e,r,a,h,_)}}_getInternalFormatFromDepthTextureFormat(e,t,r){const s=this._gl;if(!t)return s.STENCIL_INDEX8;let a=r?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;return this.webGLVersion>1?e===15?a=s.DEPTH_COMPONENT16:e===16?a=s.DEPTH_COMPONENT24:e===17||e===13?a=r?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT24:e===14?a=s.DEPTH_COMPONENT32F:e===18&&(a=r?s.DEPTH32F_STENCIL8:s.DEPTH_COMPONENT32F):a=s.DEPTH_COMPONENT16,a}_getWebGLTextureTypeFromDepthTextureFormat(e){const t=this._gl;let r=t.UNSIGNED_INT;return e===15?r=t.UNSIGNED_SHORT:e===17||e===13?r=t.UNSIGNED_INT_24_8:e===14?r=t.FLOAT:e===18?r=t.FLOAT_32_UNSIGNED_INT_24_8_REV:e===19&&(r=t.UNSIGNED_BYTE),r}_setupFramebufferDepthAttachments(e,t,r,s,n=1,a,h=!1){const l=this._gl;a=a??(e?13:14);const _=this._getInternalFormatFromDepthTextureFormat(a,t,e);return e&&t?this._createRenderBuffer(r,s,n,l.DEPTH_STENCIL,_,h?-1:l.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(r,s,n,_,_,h?-1:l.DEPTH_ATTACHMENT):e?this._createRenderBuffer(r,s,n,_,_,h?-1:l.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,r,s,n,a,h=!0){const _=this._gl.createRenderbuffer();return this._updateRenderBuffer(_,e,t,r,s,n,a,h)}_updateRenderBuffer(e,t,r,s,n,a,h,l=!0){const _=this._gl;return _.bindRenderbuffer(_.RENDERBUFFER,e),s>1&&_.renderbufferStorageMultisample?_.renderbufferStorageMultisample(_.RENDERBUFFER,s,a,t,r):_.renderbufferStorage(_.RENDERBUFFER,n,t,r),h!==-1&&_.framebufferRenderbuffer(_.FRAMEBUFFER,h,_.RENDERBUFFER,e),l&&_.bindRenderbuffer(_.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&(pe(e,this._gl),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const r=e.getSamplers();for(let s=0;s<r.length;s++){const n=e.getUniform(r[s]);n&&(this._boundUniforms[s]=n)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,r=!1,s=!1){let n=!1;const a=t&&t._associatedChannel>-1;if(r&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw M.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else r&&(n=!0,this._activateCurrentTexture());return a&&!r&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),n}_bindTexture(e,t,r){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,r,s){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,r))}_bindSamplerUniformToChannel(e,t){const r=this._boundUniforms[e];!r||r._currentState===t||(this._gl.uniform1i(r,t),r._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,r=!1,s=!1,n=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const _=t.getInternalTexture();_&&(_._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;s?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,!r&&a&&(a._associatedChannel=e);let h=!0;this._boundTexturesCache[e]===a&&(r||this._bindSamplerUniformToChannel(a._associatedChannel,e),h=!1),this._activeChannel=e;const l=this._getTextureTarget(a);if(h&&this._bindTextureDirectly(l,a,r),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;const _=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=_,t.wrapV=_}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(l,a,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,r,s){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==r.length)&&(this._textureUnits=new Int32Array(r.length));for(let n=0;n<r.length;n++){const a=r[n].getInternalTexture();a?(this._textureUnits[n]=e+n,a._associatedChannel=e+n):this._textureUnits[n]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let n=0;n<r.length;n++)this._setTexture(this._textureUnits[n],r[n],!0)}}_setAnisotropicLevel(e,t,r){const s=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(r=1),s&&t._cachedAnisotropicFilteringLevel!==r&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=r)}_setTextureParameterFloat(e,t,r,s){this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameterf(e,t,r)}_setTextureParameterInteger(e,t,r,s){s&&this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameteri(e,t,r)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){J()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),Q(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let r=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(r=r&&a===t.FRAMEBUFFER_COMPLETE,r=r&&t.getError()===t.NO_ERROR,r&&(t.clear(t.COLOR_BUFFER_BIT),r=r&&t.getError()===t.NO_ERROR),r){t.bindFramebuffer(t.FRAMEBUFFER,null);const h=t.RGBA,l=t.UNSIGNED_BYTE,_=new Uint8Array(4);t.readPixels(0,0,1,1,h,l,_),r=r&&t.getError()===t.NO_ERROR}for(t.deleteTexture(s),t.deleteFramebuffer(n),t.bindFramebuffer(t.FRAMEBUFFER,null);!r&&t.getError()!==t.NO_ERROR;);return r}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let r=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:r=this._gl.ALPHA;break;case 1:r=this._gl.LUMINANCE;break;case 2:r=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:r=this._gl.RED;break;case 7:case 33324:case 36761:r=this._gl.RG;break;case 4:case 32852:case 36762:r=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:r=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:r=this._gl.RED_INTEGER;break;case 9:r=this._gl.RG_INTEGER;break;case 10:r=this._gl.RGB_INTEGER;break;case 11:r=this._gl.RGBA_INTEGER;break}return r}_getRGBABufferInternalSizedFormat(e,t,r=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return r?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return r?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,r,s,n=!0,a=!0,h=null){const l=n?4:3,_=n?this._gl.RGBA:this._gl.RGB,u=r*s*l;if(!h)h=new Uint8Array(u);else if(h.length<u)return M.Error(`Data buffer is too small to store the read pixels (${h.length} should be more than ${u})`),Promise.resolve(h);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,r,s,_,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=d._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=d._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}g._TempClearColorUint32=new Uint32Array(4);g._TempClearColorInt32=new Int32Array(4);g.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];g._ConcatenateShader=Re;g._IsSupported=null;g._HasMajorPerformanceCaveat=null;const Qe=Object.freeze(Object.defineProperty({__proto__:null,ThinEngine:g},Symbol.toStringTag,{value:"Module"}));class Ce{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new Me(e)}sampleFrame(e=H.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class Me{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const r=this._samples[this._pos];t=r-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(r-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}g.prototype.setAlphaMode=function(i,e=!1,t=0){if(this._alphaMode[t]===i){if(!e){const s=i===0;this.depthCullingState.depthMask!==s&&(this.depthCullingState.depthMask=s)}return}const r=i===0;this._alphaState.setAlphaBlend(!r,t),this._alphaState.setAlphaMode(i,t),e||(this.depthCullingState.depthMask=r),this._alphaMode[t]=i};g.prototype.updateRawTexture=function(i,e,t,r,s=null,n=0,a=!1){if(!i)return;const h=this._getRGBABufferInternalSizedFormat(n,t,a),l=this._getInternalFormat(t),_=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(i._bufferView=e,i.format=t,i.type=n,i.invertY=r,i._compression=s),i.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[s],i.width,i.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,h,i.width,i.height,0,l,_,e),i.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),i.isReady=!0};g.prototype.createRawTexture=function(i,e,t,r,s,n,a,h=null,l=0,_=0,u=!1){const f=new w(this,3);f.baseWidth=e,f.baseHeight=t,f.width=e,f.height=t,f.format=r,f.generateMipMaps=s,f.samplingMode=a,f.invertY=n,f._compression=h,f.type=l,f._useSRGBBuffer=this._getUseSRGBBuffer(u,!s),this._doNotHandleContextLost||(f._bufferView=i),this.updateRawTexture(f,i,r,n,h,l,f._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,f,!0);const p=this._getSamplingParameters(a,s);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,p.min),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(f),f};g.prototype.createRawCubeTexture=function(i,e,t,r,s,n,a,h=null){const l=this._gl,_=new w(this,8);_.isCube=!0,_.format=t,_.type=r,this._doNotHandleContextLost||(_._bufferViewArray=i);const u=this._getWebGLTextureType(r);let f=this._getInternalFormat(t);f===l.RGB&&(f=l.RGBA),u===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(s=!1,a=1,M.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(s=!1,a=1,M.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===l.FLOAT&&!this._caps.textureFloatRender?(s=!1,M.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):u===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(s=!1,M.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const p=e,c=p;if(_.width=p,_.height=c,_.invertY=n,_._compression=h,!this.needPOTTextures||Y(_.width)&&Y(_.height)||(s=!1),i)this.updateRawCubeTexture(_,i,t,r,n,h);else{const R=this._getRGBABufferInternalSizedFormat(r),E=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,_,!0);for(let T=0;T<6;T++)h?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+T,E,this.getCaps().s3tc[h],_.width,_.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+T,E,R,_.width,_.height,0,f,u,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,_,!0),i&&s&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const S=this._getSamplingParameters(a,s);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,S.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,S.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),_.generateMipMaps=s,_.samplingMode=a,_.isReady=!0,_};g.prototype.updateRawCubeTexture=function(i,e,t,r,s,n=null,a=0){i._bufferViewArray=e,i.format=t,i.type=r,i.invertY=s,i._compression=n;const h=this._gl,l=this._getWebGLTextureType(r);let _=this._getInternalFormat(t);const u=this._getRGBABufferInternalSizedFormat(r);let f=!1;_===h.RGB&&(_=h.RGBA,f=!0),this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,i,!0),this._unpackFlipY(s===void 0?!0:!!s),i.width%4!==0&&h.pixelStorei(h.UNPACK_ALIGNMENT,1);for(let c=0;c<6;c++){let A=e[c];n?h.compressedTexImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,this.getCaps().s3tc[n],i.width,i.height,0,A):(f&&(A=se(A,i.width,i.height,r)),h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,u,i.width,i.height,0,_,l,A))}(!this.needPOTTextures||Y(i.width)&&Y(i.height))&&i.generateMipMaps&&a===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),i.isReady=!0};g.prototype.createRawCubeTextureFromUrl=function(i,e,t,r,s,n,a,h,l=null,_=null,u=3,f=!1){const p=this._gl,c=this.createRawCubeTexture(null,t,r,s,!n,f,u,null);e?.addPendingData(c),c.url=i,c.isReady=!1,this._internalTexturesCache.push(c);const A=(R,E)=>{e?.removePendingData(c),_&&R&&_(R.status+" "+R.statusText,E)},S=async R=>{if(!c._hardwareTexture)return;const E=a(R);if(!E)return;const T=E instanceof Promise?await E:E,P=c.width;if(h){const F=this._getWebGLTextureType(s);let C=this._getInternalFormat(r);const I=this._getRGBABufferInternalSizedFormat(s);let B=!1;C===p.RGB&&(C=p.RGBA,B=!0),this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,c,!0),this._unpackFlipY(!1);const m=h(T);for(let U=0;U<m.length;U++){const y=P>>U;for(let D=0;D<6;D++){let G=m[U][D];B&&(G=se(G,y,y,s)),p.texImage2D(D,U,I,y,y,0,C,F,G)}}this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(c,T,r,s,f);c.isReady=!0,e?.removePendingData(c),c.onLoadedObservable.notifyObservers(c),c.onLoadedObservable.clear(),l&&l()};return this._loadFile(i,R=>{S(R).catch(E=>{A(void 0,E)})},void 0,e?.offlineProvider,!0,A),c};function se(i,e,t,r){let s,n=1;r===1?s=new Float32Array(e*t*4):r===2?(s=new Uint16Array(e*t*4),n=15360):r===7?s=new Uint32Array(e*t*4):s=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let h=0;h<t;h++){const l=(h*e+a)*3,_=(h*e+a)*4;s[_+0]=i[l+0],s[_+1]=i[l+1],s[_+2]=i[l+2],s[_+3]=n}return s}function ie(i){return function(e,t,r,s,n,a,h,l,_=null,u=0){const f=i?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,p=i?10:11,c=new w(this,p);c.baseWidth=t,c.baseHeight=r,c.baseDepth=s,c.width=t,c.height=r,c.depth=s,c.format=n,c.type=u,c.generateMipMaps=a,c.samplingMode=l,i?c.is3D=!0:c.is2DArray=!0,this._doNotHandleContextLost||(c._bufferView=e),i?this.updateRawTexture3D(c,e,n,h,_,u):this.updateRawTexture2DArray(c,e,n,h,_,u),this._bindTextureDirectly(f,c,!0);const A=this._getSamplingParameters(l,a);return this._gl.texParameteri(f,this._gl.TEXTURE_MAG_FILTER,A.mag),this._gl.texParameteri(f,this._gl.TEXTURE_MIN_FILTER,A.min),a&&this._gl.generateMipmap(f),this._bindTextureDirectly(f,null),this._internalTexturesCache.push(c),c}}g.prototype.createRawTexture2DArray=ie(!1);g.prototype.createRawTexture3D=ie(!0);function ne(i){return function(e,t,r,s,n=null,a=0){const h=i?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),_=this._getInternalFormat(r),u=this._getRGBABufferInternalSizedFormat(a,r);this._bindTextureDirectly(h,e,!0),this._unpackFlipY(s===void 0?!0:!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.invertY=s,e._compression=n),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&t?this._gl.compressedTexImage3D(h,0,this.getCaps().s3tc[n],e.width,e.height,e.depth,0,t):this._gl.texImage3D(h,0,u,e.width,e.height,e.depth,0,_,l,t),e.generateMipMaps&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),e.isReady=!0}}g.prototype.updateRawTexture2DArray=ne(!1);g.prototype.updateRawTexture3D=ne(!0);g.prototype._readTexturePixelsSync=function(i,e,t,r=-1,s=0,n=null,a=!0,h=!1,l=0,_=0){const u=this._gl;if(!u)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const p=u.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}u.bindFramebuffer(u.FRAMEBUFFER,this._dummyFramebuffer),r>-1?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+r,i._hardwareTexture?.underlyingResource,s):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,i._hardwareTexture?.underlyingResource,s);let f=i.type!==void 0?this._getWebGLTextureType(i.type):u.UNSIGNED_BYTE;if(h)n||(n=Ae(i.type,4*e*t));else switch(f){case u.UNSIGNED_BYTE:n||(n=new Uint8Array(4*e*t)),f=u.UNSIGNED_BYTE;break;default:n||(n=new Float32Array(4*e*t)),f=u.FLOAT;break}return a&&this.flushFramebuffer(),u.readPixels(l,_,e,t,u.RGBA,f,n),u.bindFramebuffer(u.FRAMEBUFFER,this._currentFramebuffer),n};g.prototype._readTexturePixels=function(i,e,t,r=-1,s=0,n=null,a=!0,h=!1,l=0,_=0){return Promise.resolve(this._readTexturePixelsSync(i,e,t,r,s,n,a,h,l,_))};g.prototype.updateDynamicIndexBuffer=function(i,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(i);let r;i.is32Bits?r=e instanceof Uint32Array?e:new Uint32Array(e):r=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};g.prototype.updateDynamicVertexBuffer=function(i,e,t,r){this.bindArrayBuffer(i),t===void 0&&(t=0);const s=e.byteLength||e.length;r===void 0||r>=s&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e).subarray(0,r/4)):(e instanceof ArrayBuffer?e=new Uint8Array(e,0,r):e=new Uint8Array(e.buffer,e.byteOffset,r),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e)),this._resetVertexBufferBinding()};g.prototype._createDepthStencilCubeTexture=function(i,e){const t=new w(this,12);if(t.isCube=!0,this.webGLVersion===1)return M.Error("Depth cube texture is not supported by WebGL 1."),t;const r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,t,!0),this._setupDepthStencilTexture(t,i,r.bilinearFiltering,r.comparisonFunction);for(let n=0;n<6;n++)r.generateStencil?s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,s.DEPTH24_STENCIL8,i,i,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,s.DEPTH_COMPONENT24,i,i,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null);return this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(t),t};g.prototype._setCubeMapTextureParams=function(i,e,t){const r=this._gl;r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,e?r.LINEAR_MIPMAP_LINEAR:r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),i.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAX_LEVEL,t),i._maxLodLevel=t),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null)};g.prototype.createCubeTexture=function(i,e,t,r,s=null,n=null,a,h=null,l=!1,_=0,u=0,f=null,p,c=!1,A=null){const S=this._gl;return this.createCubeTextureBase(i,e,t,!!r,s,n,a,h,l,_,u,f,R=>this._bindTextureDirectly(S.TEXTURE_CUBE_MAP,R,!0),(R,E)=>{const T=this.needPOTTextures?$(E[0].width,this._caps.maxCubemapTextureSize):E[0].width,P=T,F=[S.TEXTURE_CUBE_MAP_POSITIVE_X,S.TEXTURE_CUBE_MAP_POSITIVE_Y,S.TEXTURE_CUBE_MAP_POSITIVE_Z,S.TEXTURE_CUBE_MAP_NEGATIVE_X,S.TEXTURE_CUBE_MAP_NEGATIVE_Y,S.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(S.TEXTURE_CUBE_MAP,R,!0),this._unpackFlipY(!1);const C=a?this._getInternalFormat(a,R._useSRGBBuffer):R._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:S.RGBA;let I=a?this._getInternalFormat(a):S.RGBA;R._useSRGBBuffer&&this.webGLVersion===1&&(I=C);for(let B=0;B<F.length;B++)if(E[B].width!==T||E[B].height!==P){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){M.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=T,this._workingCanvas.height=P,this._workingContext.drawImage(E[B],0,0,E[B].width,E[B].height,0,0,T,P),S.texImage2D(F[B],0,C,I,S.UNSIGNED_BYTE,this._workingCanvas)}else S.texImage2D(F[B],0,C,I,S.UNSIGNED_BYTE,E[B]);r||S.generateMipmap(S.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(R,!r),R.width=T,R.height=P,R.isReady=!0,a&&(R.format=a),R.onLoadedObservable.notifyObservers(R),R.onLoadedObservable.clear(),s&&s()},!!c,A)};g.prototype.generateMipMapsForCubemap=function(i,e=!0){if(i.generateMipMaps){const t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,i,!0),t.generateMipmap(t.TEXTURE_CUBE_MAP),e&&this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}};class Ue{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(e,t=!0){t&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=e,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,e&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=k(e.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){return this._textures?.[0]??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(e){if(!this._textures)return-1;const t=this._textures[e],r=this._layerIndices?.[e]??0,s=this._faceIndices?.[e]??0;return t.isCube?r*6+s:t.is3D?0:r}get samples(){return this._samples}setSamples(e,t=!0,r=!1){if(this.samples===e&&!r)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(e,t,r,s,n){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this.depthReadOnly=!1,this.stencilReadOnly=!1,this._isMulti=e,this._isCube=t,this._size=r,this._engine=s,this._depthStencilTexture=null,this.label=n}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,r=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&r&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,r){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),t!==void 0&&t>=0&&(this._layerIndices[e]=t),r!==void 0&&r>=0&&(this._faceIndices[e]=r)}createDepthStencilTexture(e=0,t=!0,r=!1,s=1,n=14,a){return this._depthStencilTexture?.dispose(),this._depthStencilTextureWithStencil=r,this._depthStencilTextureLabel=a,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:r,isCube:this._isCube,samples:s,depthTextureFormat:n,label:a},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e)}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let e=null;if(this._isMulti){const t=this.textures;if(t&&t.length>0){let r=!1,s=t.length,n=-1;const a=t[t.length-1]._source;(a===14||a===12)&&(r=!0,n=t[t.length-1].format,s--);const h=[],l=[],_=[],u=[],f=[],p=[],c=[],A={};for(let E=0;E<s;++E){const T=t[E];h.push(T.samplingMode),l.push(T.type),_.push(T.format),A[T.uniqueId]!==void 0?(u.push(-1),c.push(0)):(A[T.uniqueId]=E,T.is2DArray?(u.push(35866),c.push(T.depth)):T.isCube?(u.push(34067),c.push(0)):T.is3D?(u.push(32879),c.push(T.depth)):(u.push(3553),c.push(0))),this._faceIndices&&f.push(this._faceIndices[E]??0),this._layerIndices&&p.push(this._layerIndices[E]??0)}const S={samplingModes:h,generateMipMaps:t[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:r,depthTextureFormat:n,types:l,formats:_,textureCount:s,targetTypes:u,faceIndex:f,layerIndex:p,layerCounts:c,label:this.label},R={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(R,S);for(let E=0;E<s;++E){if(u[E]!==-1)continue;const T=A[t[E].uniqueId];e.setTexture(e.textures[T],E)}}}else{const t={};if(t.generateDepthBuffer=this._generateDepthBuffer,t.generateMipMaps=this.texture?.generateMipMaps??!1,t.generateStencilBuffer=this._generateStencilBuffer,t.samplingMode=this.texture?.samplingMode,t.type=this.texture?.type,t.format=this.texture?.format,t.noColorAttachment=!this._textures,t.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,t);else{const r={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?this.texture?.depth:void 0};e=this._engine.createRenderTargetTexture(r,t)}e.texture&&(e.texture.isReady=!0)}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,r=this._depthStencilTexture.format,s=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,s,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,r,this._depthStencilTextureLabel)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;++e)this._textures[e].dispose();this._textures=null}dispose(e=!1){e||(this._depthStencilTexture?.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class ye extends Ue{setDepthStencilTexture(e,t=!0){if(super.setDepthStencilTexture(e,t),!e)return;const r=this._engine,s=this._context,n=e._hardwareTexture;if(n&&e._autoMSAAManagement&&this._MSAAFramebuffer){const a=r._currentFramebuffer;r._bindUnboundFramebuffer(this._MSAAFramebuffer),s.framebufferRenderbuffer(s.FRAMEBUFFER,k(e.format)?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT,s.RENDERBUFFER,n.getMSAARenderBuffer()),r._bindUnboundFramebuffer(a)}}constructor(e,t,r,s,n){super(e,t,r,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=n}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,r=!1,s=1,n=14,a){if(this._depthStencilBuffer){const h=this._engine,l=h._currentFramebuffer,_=this._context;h._bindUnboundFramebuffer(this._framebuffer),_.framebufferRenderbuffer(_.FRAMEBUFFER,_.DEPTH_STENCIL_ATTACHMENT,_.RENDERBUFFER,null),_.framebufferRenderbuffer(_.FRAMEBUFFER,_.DEPTH_ATTACHMENT,_.RENDERBUFFER,null),_.framebufferRenderbuffer(_.FRAMEBUFFER,_.STENCIL_ATTACHMENT,_.RENDERBUFFER,null),h._bindUnboundFramebuffer(l),_.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,r,s,n,a)}shareDepth(e){super.shareDepth(e);const t=this._context,r=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer,n=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==r&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=r;const a=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;n._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,a,t.RENDERBUFFER,r),n._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,r,s=0){const n=e._hardwareTexture;if(!n)return;const a=this._framebuffer,h=this._engine,l=h._currentFramebuffer;h._bindUnboundFramebuffer(a);let _;if(h.webGLVersion>1){const u=this._context;_=u["COLOR_ATTACHMENT"+t],e.is2DArray||e.is3D?(r=r??this.layerIndices?.[t]??0,u.framebufferTextureLayer(u.FRAMEBUFFER,_,n.underlyingResource,s,r)):e.isCube?(r=r??this.faceIndices?.[t]??0,u.framebufferTexture2D(u.FRAMEBUFFER,_,u.TEXTURE_CUBE_MAP_POSITIVE_X+r,n.underlyingResource,s)):u.framebufferTexture2D(u.FRAMEBUFFER,_,u.TEXTURE_2D,n.underlyingResource,s)}else{const u=this._context;_=u["COLOR_ATTACHMENT"+t+"_WEBGL"];const f=r!==void 0?u.TEXTURE_CUBE_MAP_POSITIVE_X+r:u.TEXTURE_2D;u.framebufferTexture2D(u.FRAMEBUFFER,_,f,n.underlyingResource,s)}if(e._autoMSAAManagement&&this._MSAAFramebuffer){const u=this._context;h._bindUnboundFramebuffer(this._MSAAFramebuffer),u.framebufferRenderbuffer(u.FRAMEBUFFER,_,u.RENDERBUFFER,n.getMSAARenderBuffer())}h._bindUnboundFramebuffer(l)}setTexture(e,t=0,r=!0){super.setTexture(e,t,r),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const r=this._attachments?.length??this.textures.length;for(let s=0;s<r;s++){const n=this.textures[s];n&&(n.is2DArray||n.is3D?this._bindTextureRenderTarget(n,s,this.layerIndices[s]):n.isCube?this._bindTextureRenderTarget(n,s,this.faceIndices[s]):this._bindTextureRenderTarget(n,s))}}setLayerAndFaceIndex(e=0,t,r){if(super.setLayerAndFaceIndex(e,t,r),!this.textures||!this.layerIndices||!this.faceIndices)return;const s=this.textures[e];s.is2DArray||s.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):s.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}resolveMSAATextures(){const e=this._engine,t=e._currentFramebuffer;e._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),e._bindUnboundFramebuffer(t)}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}d.prototype.createDepthStencilTexture=function(i,e,t){if(e.isCube){const r=i.width||i;return this._createDepthStencilCubeTexture(r,e)}else return this._createDepthStencilTexture(i,e,t)};g.prototype._createHardwareRenderTargetWrapper=function(i,e,t){const r=new ye(i,e,t,this,this._gl);return this._renderTargetWrapperCache.push(r),r};g.prototype.createRenderTargetTexture=function(i,e){const t=this._createHardwareRenderTargetWrapper(!1,!1,i);let r=!0,s=!1,n=!1,a,h=1,l;e!==void 0&&typeof e=="object"&&(r=e.generateDepthBuffer??!0,s=!!e.generateStencilBuffer,n=!!e.noColorAttachment,a=e.colorAttachment,h=e.samples??1,l=e.label);const _=a||(n?null:this._createInternalTexture(i,e,!0,5)),u=i.width||i,f=i.height||i,p=this._currentFramebuffer,c=this._gl,A=c.createFramebuffer();if(this._bindUnboundFramebuffer(A),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(s,r,u,f),_&&!_.is2DArray&&!_.is3D&&c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,_._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(p),t.label=l??"RenderTargetWrapper",t._framebuffer=A,t._generateDepthBuffer=r,t._generateStencilBuffer=s,t.setTextures(_),!a)this.updateRenderTargetTextureSampleCount(t,h);else if(t._samples=a.samples,a.samples>1){const S=a._hardwareTexture.getMSAARenderBuffer(0);t._MSAAFramebuffer=c.createFramebuffer(),this._bindUnboundFramebuffer(t._MSAAFramebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,S),this._bindUnboundFramebuffer(null)}return t};g.prototype._createDepthStencilTexture=function(i,e,t){const r=this._gl,s=i.layers||0,n=i.depth||0;let a=r.TEXTURE_2D;s!==0?a=r.TEXTURE_2D_ARRAY:n!==0&&(a=r.TEXTURE_3D);const h=new w(this,12);if(h.label=e.label,!this._caps.depthTextureExtension)return M.Error("Depth texture is not supported by your browser or hardware."),h;const l={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(a,h,!0),this._setupDepthStencilTexture(h,i,l.comparisonFunction===0?!1:l.bilinearFiltering,l.comparisonFunction,l.samples),l.depthTextureFormat!==void 0){if(l.depthTextureFormat!==15&&l.depthTextureFormat!==16&&l.depthTextureFormat!==17&&l.depthTextureFormat!==13&&l.depthTextureFormat!==14&&l.depthTextureFormat!==18)return M.Error(`Depth texture ${l.depthTextureFormat} format is not supported.`),h;h.format=l.depthTextureFormat}else h.format=l.generateStencil?13:16;const _=k(h.format),u=this._getWebGLTextureTypeFromDepthTextureFormat(h.format),f=_?r.DEPTH_STENCIL:r.DEPTH_COMPONENT,p=this._getInternalFormatFromDepthTextureFormat(h.format,!0,_);return h.is2DArray?r.texImage3D(a,0,p,h.width,h.height,s,0,f,u,null):h.is3D?r.texImage3D(a,0,p,h.width,h.height,n,0,f,u,null):r.texImage2D(a,0,p,h.width,h.height,0,f,u,null),this._bindTextureDirectly(a,null),this._internalTexturesCache.push(h),t._depthStencilBuffer&&(r.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=null),this._bindUnboundFramebuffer(t._MSAAFramebuffer??t._framebuffer),t._generateStencilBuffer=_,t._depthStencilTextureWithStencil=_,t._depthStencilBuffer=this._setupFramebufferDepthAttachments(t._generateStencilBuffer,t._generateDepthBuffer,t.width,t.height,t.samples,h.format),this._bindUnboundFramebuffer(null),h};g.prototype.updateRenderTargetTextureSampleCount=function(i,e){if(this.webGLVersion<2||!i)return 1;if(i.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),i._depthStencilBuffer&&(t.deleteRenderbuffer(i._depthStencilBuffer),i._depthStencilBuffer=null),i._MSAAFramebuffer&&(t.deleteFramebuffer(i._MSAAFramebuffer),i._MSAAFramebuffer=null);const r=i.texture?._hardwareTexture;if(r?.releaseMSAARenderBuffers(),i.texture&&e>1&&typeof t.renderbufferStorageMultisample=="function"){const n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");i._MSAAFramebuffer=n,this._bindUnboundFramebuffer(i._MSAAFramebuffer);const a=this._createRenderBuffer(i.texture.width,i.texture.height,e,-1,this._getRGBABufferInternalSizedFormat(i.texture.type,i.texture.format,i.texture._useSRGBBuffer),t.COLOR_ATTACHMENT0,!1);if(!a)throw new Error("Unable to create multi sampled framebuffer");r?.addMSAARenderBuffer(a)}this._bindUnboundFramebuffer(i._MSAAFramebuffer??i._framebuffer),i.texture&&(i.texture.samples=e),i._samples=e;const s=i._depthStencilTexture?i._depthStencilTexture.format:void 0;return i._depthStencilBuffer=this._setupFramebufferDepthAttachments(i._generateStencilBuffer,i._generateDepthBuffer,i.width,i.height,e,s),this._bindUnboundFramebuffer(null),e};g.prototype._setupDepthStencilTexture=function(i,e,t,r,s=1){const n=e.width??e,a=e.height??e,h=e.layers||0,l=e.depth||0;i.baseWidth=n,i.baseHeight=a,i.width=n,i.height=a,i.is2DArray=h>0,i.depth=h||l,i.isReady=!0,i.samples=s,i.generateMipMaps=!1,i.samplingMode=t?2:1,i.type=0,i._comparisonFunction=r;const _=this._gl,u=this._getTextureTarget(i),f=this._getSamplingParameters(i.samplingMode,!1);_.texParameteri(u,_.TEXTURE_MAG_FILTER,f.mag),_.texParameteri(u,_.TEXTURE_MIN_FILTER,f.min),_.texParameteri(u,_.TEXTURE_WRAP_S,_.CLAMP_TO_EDGE),_.texParameteri(u,_.TEXTURE_WRAP_T,_.CLAMP_TO_EDGE),this.webGLVersion>1&&(r===0?(_.texParameteri(u,_.TEXTURE_COMPARE_FUNC,515),_.texParameteri(u,_.TEXTURE_COMPARE_MODE,_.NONE)):(_.texParameteri(u,_.TEXTURE_COMPARE_FUNC,r),_.texParameteri(u,_.TEXTURE_COMPARE_MODE,_.COMPARE_REF_TO_TEXTURE)))};g.prototype.setDepthStencilTexture=function(i,e,t,r){i!==void 0&&(e&&(this._boundUniforms[i]=e),!t||!t.depthStencilTexture?this._setTexture(i,null,void 0,void 0,r):this._setTexture(i,t,!1,!0,r))};g.prototype.createRenderTargetCubeTexture=function(i,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,i),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(r.type===1&&!this._caps.textureFloatLinearFiltering||r.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(r.samplingMode=1);const s=this._gl,n=new w(this,5);this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,n,!0);const a=this._getSamplingParameters(r.samplingMode,r.generateMipMaps);r.type===1&&!this._caps.textureFloat&&(r.type=0,M.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,a.mag),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,a.min),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let l=0;l<6;l++)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),i,i,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);const h=s.createFramebuffer();return this._bindUnboundFramebuffer(h),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(r.generateStencilBuffer,r.generateDepthBuffer,i,i),r.generateMipMaps&&s.generateMipmap(s.TEXTURE_CUBE_MAP),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=h,t._generateDepthBuffer=r.generateDepthBuffer,t._generateStencilBuffer=r.generateStencilBuffer,n.width=i,n.height=i,n.isReady=!0,n.isCube=!0,n.samples=1,n.generateMipMaps=r.generateMipMaps,n.samplingMode=r.samplingMode,n.type=r.type,n.format=r.format,this._internalTexturesCache.push(n),t.setTextures(n),t};const L=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],De=[()=>1,i=>i.y,i=>i.z,i=>i.x,i=>i.x*i.y,i=>i.y*i.z,i=>3*i.z*i.z-1,i=>i.x*i.z,i=>i.x*i.x-i.y*i.y],N=(i,e)=>L[i]*De[i](e),O=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class z{constructor(){this.preScaled=!1,this.l00=b.Zero(),this.l1_1=b.Zero(),this.l10=b.Zero(),this.l11=b.Zero(),this.l2_2=b.Zero(),this.l2_1=b.Zero(),this.l20=b.Zero(),this.l21=b.Zero(),this.l22=b.Zero()}addLight(e,t,r){x.Vector3[0].set(t.r,t.g,t.b);const s=x.Vector3[0],n=x.Vector3[1];s.scaleToRef(r,n),n.scaleToRef(N(0,e),x.Vector3[2]),this.l00.addInPlace(x.Vector3[2]),n.scaleToRef(N(1,e),x.Vector3[2]),this.l1_1.addInPlace(x.Vector3[2]),n.scaleToRef(N(2,e),x.Vector3[2]),this.l10.addInPlace(x.Vector3[2]),n.scaleToRef(N(3,e),x.Vector3[2]),this.l11.addInPlace(x.Vector3[2]),n.scaleToRef(N(4,e),x.Vector3[2]),this.l2_2.addInPlace(x.Vector3[2]),n.scaleToRef(N(5,e),x.Vector3[2]),this.l2_1.addInPlace(x.Vector3[2]),n.scaleToRef(N(6,e),x.Vector3[2]),this.l20.addInPlace(x.Vector3[2]),n.scaleToRef(N(7,e),x.Vector3[2]),this.l21.addInPlace(x.Vector3[2]),n.scaleToRef(N(8,e),x.Vector3[2]),this.l22.addInPlace(x.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(O[0]),this.l1_1.scaleInPlace(O[1]),this.l10.scaleInPlace(O[2]),this.l11.scaleInPlace(O[3]),this.l2_2.scaleInPlace(O[4]),this.l2_1.scaleInPlace(O[5]),this.l20.scaleInPlace(O[6]),this.l21.scaleInPlace(O[7]),this.l22.scaleInPlace(O[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(L[0]),this.l1_1.scaleInPlace(L[1]),this.l10.scaleInPlace(L[2]),this.l11.scaleInPlace(L[3]),this.l2_2.scaleInPlace(L[4]),this.l2_1.scaleInPlace(L[5]),this.l20.scaleInPlace(L[6]),this.l21.scaleInPlace(L[7]),this.l22.scaleInPlace(L[8])}updateFromArray(e){return b.FromArrayToRef(e[0],0,this.l00),b.FromArrayToRef(e[1],0,this.l1_1),b.FromArrayToRef(e[2],0,this.l10),b.FromArrayToRef(e[3],0,this.l11),b.FromArrayToRef(e[4],0,this.l2_2),b.FromArrayToRef(e[5],0,this.l2_1),b.FromArrayToRef(e[6],0,this.l20),b.FromArrayToRef(e[7],0,this.l21),b.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return b.FromFloatsToRef(e[0],e[1],e[2],this.l00),b.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),b.FromFloatsToRef(e[6],e[7],e[8],this.l10),b.FromFloatsToRef(e[9],e[10],e[11],this.l11),b.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),b.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),b.FromFloatsToRef(e[18],e[19],e[20],this.l20),b.FromFloatsToRef(e[21],e[22],e[23],this.l21),b.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new z().updateFromArray(e)}static FromPolynomial(e){const t=new z;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class j{constructor(){this.x=b.Zero(),this.y=b.Zero(),this.z=b.Zero(),this.xx=b.Zero(),this.yy=b.Zero(),this.zz=b.Zero(),this.xy=b.Zero(),this.yz=b.Zero(),this.zx=b.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=z.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){x.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=x.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),x.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),x.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(x.Vector3[0]).addInPlace(x.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(x.Vector3[0]).subtractInPlace(x.Vector3[1]),this.zz.copyFrom(e.l00),x.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(x.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new j().updateFromHarmonics(e)}static FromArray(e){const t=new j;return b.FromArrayToRef(e[0],0,t.x),b.FromArrayToRef(e[1],0,t.y),b.FromArrayToRef(e[2],0,t.z),b.FromArrayToRef(e[3],0,t.xx),b.FromArrayToRef(e[4],0,t.yy),b.FromArrayToRef(e[5],0,t.zz),b.FromArrayToRef(e[6],0,t.yz),b.FromArrayToRef(e[7],0,t.zx),b.FromArrayToRef(e[8],0,t.xy),t}}g.prototype.createPrefilteredCubeTexture=function(i,e,t,r,s=null,n=null,a,h=null,l=!0){const _=async u=>{if(!u){s&&s(null);return}const f=u.texture;if(l?u.info.sphericalPolynomial&&(f._sphericalPolynomial=u.info.sphericalPolynomial):f._sphericalPolynomial=new j,f._source=9,this.getCaps().textureLOD){s&&s(f);return}const p=3,c=this._gl,A=u.width;if(!A)return;const{DDSTools:S}=await me(async()=>{const{DDSTools:E}=await import("./dds.CeNvnj7I.js");return{DDSTools:E}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])),R=[];for(let E=0;E<p;E++){const P=1-E/(p-1),F=r,C=Math.log2(A)*t+r,I=F+(C-F)*P,B=Math.round(Math.min(Math.max(I,0),C)),m=new w(this,2);if(m.type=f.type,m.format=f.format,m.width=Math.pow(2,Math.max(Math.log2(A)-B,0)),m.height=m.width,m.isCube=!0,m._cachedWrapU=0,m._cachedWrapV=0,this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,m,!0),m.samplingMode=2,c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),u.isDDS){const y=u.info,D=u.data;this._unpackFlipY(y.isCompressed),S.UploadDDSLevels(this,m,D,y,!0,6,B)}else M.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,null);const U=new Se(e);U._isCube=!0,U._texture=m,m.isReady=!0,R.push(U)}f._lodTextureHigh=R[2],f._lodTextureMid=R[1],f._lodTextureLow=R[0],s&&s(f)};return this.createCubeTexture(i,e,null,!1,_,n,a,h,l,t,r)};g.prototype.createUniformBuffer=function(i,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");const r=new V(t);return this.bindUniformBuffer(r),i instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,i,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(i),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),r.references=1,r};g.prototype.createDynamicUniformBuffer=function(i,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");const r=new V(t);return this.bindUniformBuffer(r),i instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,i,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(i),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),r.references=1,r};g.prototype.updateUniformBuffer=function(i,e,t,r){this.bindUniformBuffer(i),t===void 0&&(t=0),r===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+r)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+r)),this.bindUniformBuffer(null)};g.prototype.bindUniformBuffer=function(i){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,i?i.underlyingResource:null)};g.prototype.bindUniformBufferBase=function(i,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,i?i.underlyingResource:null)};g.prototype.bindUniformBlock=function(i,e,t){const r=i.program,s=this._gl.getUniformBlockIndex(r,e);s!==4294967295&&this._gl.uniformBlockBinding(r,s,t)};d.prototype.displayLoadingUI=function(){if(!J())return;const i=this.loadingScreen;i&&i.displayLoadingUI()};d.prototype.hideLoadingUI=function(){if(!J())return;const i=this._loadingScreen;i&&i.hideLoadingUI()};Object.defineProperty(d.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=d.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(i){this._loadingScreen=i},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"loadingUIText",{set:function(i){this.loadingScreen.loadingUIText=i},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"loadingUIBackgroundColor",{set:function(i){this.loadingScreen.loadingUIBackgroundColor=i},enumerable:!0,configurable:!0});d.prototype.getInputElement=function(){return this._renderingCanvas};d.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null};d.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null};d.prototype.getAspectRatio=function(i,e=!1){const t=i.viewport;return this.getRenderWidth(e)*t.width/(this.getRenderHeight(e)*t.height)};d.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)};d.prototype._verifyPointerLock=function(){this._onPointerLockChange?.()};d.prototype.setAlphaEquation=function(i,e=0){if(this._alphaEquation[e]!==i){switch(i){case 0:this._alphaState.setAlphaEquationParameters(32774,32774,e);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778,e);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779,e);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776,e);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775,e);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774,e);break}this._alphaEquation[e]=i}};d.prototype.getInputElement=function(){return this._renderingCanvas};d.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc};d.prototype.setDepthFunction=function(i){this._depthCullingState.depthFunc=i};d.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)};d.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)};d.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)};d.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)};d.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask};d.prototype.setDepthWrite=function(i){this._depthCullingState.depthMask=i};d.prototype.setAlphaConstants=function(i,e,t,r){this._alphaState.setAlphaBlendConstants(i,e,t,r)};d.prototype.getAlphaMode=function(i=0){return this._alphaMode[i]};d.prototype.getAlphaEquation=function(i=0){return this._alphaEquation[i]};d.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest};d.prototype.setStencilBuffer=function(i){this._stencilState.stencilTest=i};d.prototype.getStencilMask=function(){return this._stencilState.stencilMask};d.prototype.setStencilMask=function(i){this._stencilState.stencilMask=i};d.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc};d.prototype.getStencilBackFunction=function(){return this._stencilState.stencilBackFunc};d.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef};d.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask};d.prototype.setStencilFunction=function(i){this._stencilState.stencilFunc=i};d.prototype.setStencilBackFunction=function(i){this._stencilState.stencilBackFunc=i};d.prototype.setStencilFunctionReference=function(i){this._stencilState.stencilFuncRef=i};d.prototype.setStencilFunctionMask=function(i){this._stencilState.stencilFuncMask=i};d.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail};d.prototype.getStencilBackOperationFail=function(){return this._stencilState.stencilBackOpStencilFail};d.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail};d.prototype.getStencilBackOperationDepthFail=function(){return this._stencilState.stencilBackOpDepthFail};d.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass};d.prototype.getStencilBackOperationPass=function(){return this._stencilState.stencilBackOpStencilDepthPass};d.prototype.setStencilOperationFail=function(i){this._stencilState.stencilOpStencilFail=i};d.prototype.setStencilBackOperationFail=function(i){this._stencilState.stencilBackOpStencilFail=i};d.prototype.setStencilOperationDepthFail=function(i){this._stencilState.stencilOpDepthFail=i};d.prototype.setStencilBackOperationDepthFail=function(i){this._stencilState.stencilBackOpDepthFail=i};d.prototype.setStencilOperationPass=function(i){this._stencilState.stencilOpStencilDepthPass=i};d.prototype.setStencilBackOperationPass=function(i){this._stencilState.stencilBackOpStencilDepthPass=i};d.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()};d.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)};d.prototype.getRenderPassNames=function(){return this._renderPassNames};d.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]};d.prototype.createRenderPassId=function(i){const e=++d._RenderPassIdCounter;return this._renderPassNames[e]=i??"NONAME",e};d.prototype.releaseRenderPassId=function(i){this._renderPassNames[i]=void 0;for(let e=0;e<this.scenes.length;++e){const t=this.scenes[e];for(let r=0;r<t.meshes.length;++r){const s=t.meshes[r];if(s.subMeshes)for(let n=0;n<s.subMeshes.length;++n)s.subMeshes[n]._removeDrawWrapper(i)}}};function Le(i){!i||!i.setAttribute||(i.setAttribute("touch-action","none"),i.style.touchAction="none",i.style.webkitTapHighlightColor="transparent")}function we(i,e,t){i._onCanvasFocus=()=>{i.onCanvasFocusObservable.notifyObservers(i)},i._onCanvasBlur=()=>{i.onCanvasBlurObservable.notifyObservers(i)},i._onCanvasContextMenu=s=>{i.disableContextMenu&&s.preventDefault()},e.addEventListener("focus",i._onCanvasFocus),e.addEventListener("blur",i._onCanvasBlur),e.addEventListener("contextmenu",i._onCanvasContextMenu),i._onBlur=()=>{i.disablePerformanceMonitorInBackground&&i.performanceMonitor.disable(),i._windowIsBackground=!0},i._onFocus=()=>{i.disablePerformanceMonitorInBackground&&i.performanceMonitor.enable(),i._windowIsBackground=!1},i._onCanvasPointerOut=s=>{document.elementFromPoint(s.clientX,s.clientY)!==e&&i.onCanvasPointerOutObservable.notifyObservers(s)};const r=i.getHostWindow();r&&typeof r.addEventListener=="function"&&(r.addEventListener("blur",i._onBlur),r.addEventListener("focus",i._onFocus)),e.addEventListener("pointerout",i._onCanvasPointerOut),t.doNotHandleTouchAction||Le(e),!d.audioEngine&&t.audioEngine&&d.AudioEngineFactory&&(d.audioEngine=d.AudioEngineFactory(i.getRenderingCanvas(),i.getAudioContext(),i.getAudioDestination())),te()&&(i._onFullscreenChange=()=>{i.isFullscreen=!!document.fullscreenElement,i.isFullscreen&&i._pointerLockRequested&&e&&ae(e)},document.addEventListener("fullscreenchange",i._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",i._onFullscreenChange,!1),i._onPointerLockChange=()=>{i.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",i._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",i._onPointerLockChange,!1)),i.enableOfflineSupport=d.OfflineProviderFactory!==void 0,i._deterministicLockstep=!!t.deterministicLockstep,i._lockstepMaxSteps=t.lockstepMaxSteps||0,i._timeStep=t.timeStep||1/60}function Ne(i,e){W.Instances.length===1&&d.audioEngine&&(d.audioEngine.dispose(),d.audioEngine=null);const t=i.getHostWindow();t&&typeof t.removeEventListener=="function"&&(t.removeEventListener("blur",i._onBlur),t.removeEventListener("focus",i._onFocus)),e&&(e.removeEventListener("focus",i._onCanvasFocus),e.removeEventListener("blur",i._onCanvasBlur),e.removeEventListener("pointerout",i._onCanvasPointerOut),e.removeEventListener("contextmenu",i._onCanvasContextMenu)),te()&&(document.removeEventListener("fullscreenchange",i._onFullscreenChange),document.removeEventListener("mozfullscreenchange",i._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",i._onFullscreenChange),document.removeEventListener("msfullscreenchange",i._onFullscreenChange),document.removeEventListener("pointerlockchange",i._onPointerLockChange),document.removeEventListener("mspointerlockchange",i._onPointerLockChange),document.removeEventListener("mozpointerlockchange",i._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",i._onPointerLockChange))}function Oe(i){const e=document.createElement("span");e.textContent="Hg",e.style.font=i;const t=document.createElement("div");t.style.display="inline-block",t.style.width="1px",t.style.height="0px",t.style.verticalAlign="bottom";const r=document.createElement("div");r.style.whiteSpace="nowrap",r.appendChild(e),r.appendChild(t),document.body.appendChild(r);let s=0,n=0;try{n=t.getBoundingClientRect().top-e.getBoundingClientRect().top,t.style.verticalAlign="baseline",s=t.getBoundingClientRect().top-e.getBoundingClientRect().top}finally{document.body.removeChild(r)}return{ascent:s,height:n,descent:n-s}}async function Ge(i,e,t){return await new Promise((r,s)=>{const n=new Image;n.onload=()=>{n.decode().then(()=>{i.createImageBitmap(n,t).then(a=>{r(a)})})},n.onerror=()=>{s(`Error loading image ${n.src}`)},n.src=e})}function Xe(i,e,t,r){const n=i.createCanvas(t,r).getContext("2d");if(!n)throw new Error("Unable to get 2d context for resizeImageBitmap");return n.drawImage(e,0,0),n.getImageData(0,0,t,r).data}function ve(i){const e=i.requestFullscreen||i.webkitRequestFullscreen;e&&e.call(i)}function Ve(){const i=document;document.exitFullscreen?document.exitFullscreen():i.webkitCancelFullScreen&&i.webkitCancelFullScreen()}function ae(i){if(i.requestPointerLock){const e=i.requestPointerLock();e instanceof Promise?e.then(()=>{i.focus()}).catch(()=>{}):i.focus()}}function ke(){document.exitPointerLock&&document.exitPointerLock()}class v{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){v.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){v.Enabled&&(this._startMonitoringTime=H.Now)}endMonitoring(e=!0){if(!v.Enabled)return;e&&this.fetchNewFrame();const t=H.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=H.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}v.Enabled=!0;class o extends g{static get NpmPackage(){return d.NpmPackage}static get Version(){return d.Version}static get Instances(){return W.Instances}static get LastCreatedEngine(){return W.LastCreatedEngine}static get LastCreatedScene(){return W.LastCreatedScene}static DefaultLoadingScreenFactory(e){return d.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!o._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,r,s=!1){super(e,t,r,s),this.customAnimationFrameRequester=null,this._performanceMonitor=new Ce,this._drawCalls=new v,e&&(this._features.supportRenderPasses=!0,r=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),we(this,e,this._creationOptions)}resizeImageBitmap(e,t,r){return Xe(this,e,t,r)}async _createImageBitmapFromSource(e,t){return await Ge(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&ve(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&Ve()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,r,s){const n=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,r,s),n}scissorClear(e,t,r,s,n){this.enableScissor(e,t,r,s),this.clear(n,!0,!0,!0),this.disableScissor()}enableScissor(e,t,r,s){const n=this._gl;n.enable(n.SCISSOR_TEST),n.scissor(e,t,r,s)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}async _loadFileAsync(e,t,r){return await new Promise((s,n)=>{this._loadFile(e,a=>{s(a)},void 0,t,r,(a,h)=>{n(h)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return Oe(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(this._frameHandler!==0){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&ae(this._renderingCanvas)}exitPointerlock(){ke()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,r,s,n,a=null){n=n||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const h=super.createShaderProgram(e,t,r,s,n,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}_createShaderProgram(e,t,r,s,n=null){const a=s.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");if(s.attachShader(a,t),s.attachShader(a,r),this.webGLVersion>1&&n){const h=this.createTransformFeedback();this.bindTransformFeedback(h),this.setTranformFeedbackVaryings(a,n),e.transformFeedback=h}return s.linkProgram(a),this.webGLVersion>1&&n&&this.bindTransformFeedback(null),e.context=s,e.vertexShader=t,e.fragmentShader=r,e.isParallelCompiled||this._finalizePipelineContext(e),a}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e);for(const t of this.scenes){for(const r of t.postProcesses)r._outputTexture===e&&(r._outputTexture=null);for(const r of t.cameras)for(const s of r._postProcesses)s&&s._outputTexture===e&&(s._outputTexture=null)}}_rescaleTexture(e,t,r,s,n){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const a=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&o._RescalePostProcessFactory&&(this._rescalePostProcess=o._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const h=()=>{this._rescalePostProcess.onApply=function(u){u._bindTexture("textureSampler",e)};let _=r;_||(_=this.scenes[this.scenes.length-1]),_.postProcessManager.directRender([this._rescalePostProcess],a,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,t.width,t.height,0),this.unBindFramebuffer(a),a.dispose(),n&&n()},l=this._rescalePostProcess.getEffect();l?l.executeWhenCompiled(h):this._rescalePostProcess.onEffectCreatedObservable.addOnce(_=>{_.executeWhenCompiled(h)})}}wrapWebGLTexture(e,t=!1,r=3,s=0,n=0){const a=new re(e,this._gl),h=new w(this,0,!0);return h._hardwareTexture=a,h.baseWidth=s,h.baseHeight=n,h.width=s,h.height=n,h.isReady=!0,h.useMipMaps=t,this.updateTextureSamplingMode(r,h),h}_uploadImageToTexture(e,t,r=0,s=0){const n=this._gl,a=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,h),_=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(_,e,!0),this._unpackFlipY(e.invertY);let u=n.TEXTURE_2D;e.isCube&&(u=n.TEXTURE_CUBE_MAP_POSITIVE_X+r),n.texImage2D(u,s,l,h,a,t),this._bindTextureDirectly(_,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){M.Error("WebGL 1 does not support texture comparison.");return}const r=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_FUNC,515),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_MODE,r.NONE)):(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_FUNC,t),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_FUNC,515),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.NONE)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_FUNC,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const r=new V(t);return r.capacity=e,this.bindArrayBuffer(r),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),r.references=1,r}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}async _clientWaitAsync(e,t=0,r=10){const s=this._gl;return await new Promise((n,a)=>{be(()=>{const h=s.clientWaitSync(e,t,0);if(h==s.WAIT_FAILED)throw new Error("clientWaitSync failed");return h!=s.TIMEOUT_EXPIRED},n,a,r)})}_readPixelsAsync(e,t,r,s,n,a,h){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,_=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,_),l.bufferData(l.PIXEL_PACK_BUFFER,h.byteLength,l.STREAM_READ),l.readPixels(e,t,r,s,n,a,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const u=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(l.flush(),this._clientWaitAsync(u,0,10).then(()=>(l.deleteSync(u),l.bindBuffer(l.PIXEL_PACK_BUFFER,_),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,h),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(_),h))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),Ne(this,this._renderingCanvas),super.dispose()}}o.ALPHA_DISABLE=0;o.ALPHA_ADD=1;o.ALPHA_COMBINE=2;o.ALPHA_SUBTRACT=3;o.ALPHA_MULTIPLY=4;o.ALPHA_MAXIMIZED=5;o.ALPHA_ONEONE=6;o.ALPHA_PREMULTIPLIED=7;o.ALPHA_PREMULTIPLIED_PORTERDUFF=8;o.ALPHA_INTERPOLATE=9;o.ALPHA_SCREENMODE=10;o.DELAYLOADSTATE_NONE=0;o.DELAYLOADSTATE_LOADED=1;o.DELAYLOADSTATE_LOADING=2;o.DELAYLOADSTATE_NOTLOADED=4;o.NEVER=512;o.ALWAYS=519;o.LESS=513;o.EQUAL=514;o.LEQUAL=515;o.GREATER=516;o.GEQUAL=518;o.NOTEQUAL=517;o.KEEP=7680;o.REPLACE=7681;o.INCR=7682;o.DECR=7683;o.INVERT=5386;o.INCR_WRAP=34055;o.DECR_WRAP=34056;o.TEXTURE_CLAMP_ADDRESSMODE=0;o.TEXTURE_WRAP_ADDRESSMODE=1;o.TEXTURE_MIRROR_ADDRESSMODE=2;o.TEXTUREFORMAT_ALPHA=0;o.TEXTUREFORMAT_LUMINANCE=1;o.TEXTUREFORMAT_LUMINANCE_ALPHA=2;o.TEXTUREFORMAT_RGB=4;o.TEXTUREFORMAT_RGBA=5;o.TEXTUREFORMAT_RED=6;o.TEXTUREFORMAT_R=6;o.TEXTUREFORMAT_R16_UNORM=33322;o.TEXTUREFORMAT_RG16_UNORM=33324;o.TEXTUREFORMAT_RGB16_UNORM=32852;o.TEXTUREFORMAT_RGBA16_UNORM=32859;o.TEXTUREFORMAT_R16_SNORM=36760;o.TEXTUREFORMAT_RG16_SNORM=36761;o.TEXTUREFORMAT_RGB16_SNORM=36762;o.TEXTUREFORMAT_RGBA16_SNORM=36763;o.TEXTUREFORMAT_RG=7;o.TEXTUREFORMAT_RED_INTEGER=8;o.TEXTUREFORMAT_R_INTEGER=8;o.TEXTUREFORMAT_RG_INTEGER=9;o.TEXTUREFORMAT_RGB_INTEGER=10;o.TEXTUREFORMAT_RGBA_INTEGER=11;o.TEXTURETYPE_UNSIGNED_BYTE=0;o.TEXTURETYPE_UNSIGNED_INT=0;o.TEXTURETYPE_FLOAT=1;o.TEXTURETYPE_HALF_FLOAT=2;o.TEXTURETYPE_BYTE=3;o.TEXTURETYPE_SHORT=4;o.TEXTURETYPE_UNSIGNED_SHORT=5;o.TEXTURETYPE_INT=6;o.TEXTURETYPE_UNSIGNED_INTEGER=7;o.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;o.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;o.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;o.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;o.TEXTURETYPE_UNSIGNED_INT_24_8=12;o.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;o.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;o.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;o.TEXTURE_NEAREST_SAMPLINGMODE=1;o.TEXTURE_BILINEAR_SAMPLINGMODE=2;o.TEXTURE_TRILINEAR_SAMPLINGMODE=3;o.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;o.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;o.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;o.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;o.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;o.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;o.TEXTURE_NEAREST_LINEAR=7;o.TEXTURE_NEAREST_NEAREST=1;o.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;o.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;o.TEXTURE_LINEAR_LINEAR=2;o.TEXTURE_LINEAR_NEAREST=12;o.TEXTURE_EXPLICIT_MODE=0;o.TEXTURE_SPHERICAL_MODE=1;o.TEXTURE_PLANAR_MODE=2;o.TEXTURE_CUBIC_MODE=3;o.TEXTURE_PROJECTION_MODE=4;o.TEXTURE_SKYBOX_MODE=5;o.TEXTURE_INVCUBIC_MODE=6;o.TEXTURE_EQUIRECTANGULAR_MODE=7;o.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;o.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;o.SCALEMODE_FLOOR=1;o.SCALEMODE_NEAREST=2;o.SCALEMODE_CEILING=3;const $e=Object.freeze(Object.defineProperty({__proto__:null,Engine:o},Symbol.toStringTag,{value:"Module"}));export{q as D,o as E,xe as I,v as P,j as S,z as a,$e as e,Qe as t};
