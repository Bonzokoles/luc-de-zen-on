if(typeof MessageChannel>"u"){class s{constructor(){this.onmessage=null}postMessage(a){const o={data:a};(typeof queueMicrotask=="function"?queueMicrotask:t=>setTimeout(t,0))(()=>this.onmessage&&this.onmessage(o))}start(){}close(){}}class e{constructor(){this.port1=new s,this.port2=new s;const a=(o,t)=>{const d={data:t};(typeof queueMicrotask=="function"?queueMicrotask:c=>setTimeout(c,0))(()=>o.onmessage&&o.onmessage(d))};this.port1.postMessage=o=>a(this.port2,o),this.port2.postMessage=o=>a(this.port1,o)}}globalThis.MessageChannel=e}let u=JSON.parse(localStorage.getItem("tavilySearchHistory")||"[]"),i=JSON.parse(localStorage.getItem("tavilySearchStats")||"{ totalSearches: 0, totalResults: 0, totalTime: 0, domains: {} }"),x=[],p=null;async function E(){const s=document.getElementById("searchQuery").value.trim();if(!s){alert("Proszę wprowadzić zapytanie");return}const e=document.getElementById("searchBtn"),n=document.getElementById("loadingSection"),a=document.getElementById("resultsSection"),o=document.getElementById("summarySection"),t=document.getElementById("searchStatus");e.disabled=!0,e.textContent="Wyszukiwanie...",n.classList.remove("hidden"),a.classList.add("hidden"),o.classList.add("hidden"),p=Date.now();const d=["Inicjalizacja wyszukiwania...","Przeszukiwanie stron internetowych...","Analizowanie treści...","Wyciąganie kluczowych informacji...","Generowanie podsumowania AI...","Finalizowanie wyników..."];let c=0;const y=setInterval(()=>{c<d.length&&(t.textContent=d[c],c++)},1e3);try{const m=document.getElementById("searchDepth").value,f=parseInt(document.getElementById("maxResults").value),I=document.getElementById("language").value,w=document.getElementById("contentType").value,g=document.getElementById("includeDomains").value,h=document.getElementById("excludeDomains").value,r=await(await fetch("/api/tavi",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:s,searchDepth:m,maxResults:f,language:I,contentType:w,includeDomains:g?g.split(",").map(l=>l.trim()):[],excludeDomains:h?h.split(",").map(l=>l.trim()):[]})})).json();if(clearInterval(y),r.success){const l=(Date.now()-p)/1e3;x=r.results,r.summary&&B(r.summary),k(r.results,l),T(s,r.results.length,l,r.results),b(s,r.results.length,l)}else throw new Error(r.error||"Błąd wyszukiwania")}catch(m){clearInterval(y),console.error("Search error:",m),L(m.message)}finally{e.disabled=!1,e.textContent="🔍 Szukaj",n.classList.add("hidden")}}function B(s){const e=document.getElementById("summarySection"),n=document.getElementById("aiSummary");n.innerHTML=`
      <div class="ai-summary-content">
        <p class="text-lg leading-relaxed">${s}</p>
        <div class="mt-4 text-sm text-gray-400">
          <em>Podsumowanie wygenerowane przez AI na podstawie znalezionych wyników</em>
        </div>
      </div>
    `,e.classList.remove("hidden")}function k(s,e){const n=document.getElementById("resultsSection"),a=document.getElementById("resultsList"),o=document.getElementById("resultsInfo");o.textContent=`Znaleziono ${s.length} wyników w ${e.toFixed(2)} sekund`,s.length===0?a.innerHTML='<div class="text-gray-400 text-center py-8">Brak wyników dla tego zapytania</div>':(a.innerHTML="",s.forEach((t,d)=>{const c=document.createElement("div");c.className="search-result",c.onclick=()=>window.open(t.url,"_blank");const y=new URL(t.url).hostname,m=t.score||100-d*5;c.innerHTML=`
          <div class="result-header mb-3">
            <a href="${t.url}" target="_blank" class="result-title">${t.title}</a>
            <div class="result-url">${t.url}</div>
          </div>
          <div class="result-snippet mb-3">${t.content||t.snippet||"Brak opisu dostępnego"}</div>
          <div class="result-meta">
            <span class="meta-tag">🌐 ${y}</span>
            <span class="meta-tag">📊 ${m.toFixed(0)}% trafność</span>
            <span class="meta-tag">📅 ${t.published_date||"Nieznana data"}</span>
            ${t.language?`<span class="meta-tag">🗣️ ${t.language}</span>`:""}
            ${t.content_type?`<span class="meta-tag">📄 ${t.content_type}</span>`:""}
          </div>
        `,a.appendChild(c)})),n.classList.remove("hidden")}function L(s){const e=document.getElementById("resultsSection"),n=document.getElementById("resultsList"),a=document.getElementById("resultsInfo");a.textContent="Błąd wyszukiwania",n.innerHTML=`<div class="bg-red-600/20 border border-red-400/30 rounded p-4">
      <div class="text-red-400 font-semibold mb-2">Błąd wyszukiwania:</div>
      <div class="text-primary-foreground">${s}</div>
    </div>`,e.classList.remove("hidden")}function T(s,e,n,a){i.totalSearches++,i.totalResults+=e,i.totalTime+=n,a.forEach(o=>{try{const t=new URL(o.url).hostname;i.domains[t]=(i.domains[t]||0)+1}catch{}}),localStorage.setItem("tavilySearchStats",JSON.stringify(i)),S()}function S(){document.getElementById("totalSearches").textContent=i.totalSearches;const s=i.totalSearches>0?(i.totalResults/i.totalSearches).toFixed(1):"0";document.getElementById("avgResults").textContent=s;const e=i.totalSearches>0?(i.totalTime/i.totalSearches).toFixed(1)+"s":"0s";document.getElementById("avgTime").textContent=e;const n=Object.entries(i.domains);if(n.length>0){const a=n.sort((o,t)=>t[1]-o[1])[0][0];document.getElementById("topDomain").textContent=a}}function b(s,e,n){const a={id:Date.now(),query:s,resultCount:e,searchTime:n.toFixed(2),timestamp:new Date().toISOString()};u.unshift(a),u.length>20&&(u=u.slice(0,20)),localStorage.setItem("tavilySearchHistory",JSON.stringify(u)),v()}function v(){const s=document.getElementById("searchHistoryList");s.innerHTML="",u.forEach(e=>{const n=document.createElement("div");n.className="history-item bg-black/20 border border-edge rounded-lg p-3 cursor-pointer hover:border-green-400 transition-colors";const a=new Date(e.timestamp).toLocaleDateString("pl-PL"),o=new Date(e.timestamp).toLocaleTimeString("pl-PL");n.innerHTML=`
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <p class="text-primary-foreground text-sm font-medium">${e.query}</p>
            <p class="text-gray-400 text-xs">${a} ${o} • ${e.resultCount} wyników • ${e.searchTime}s</p>
          </div>
          <button onclick="deleteFromSearchHistory(${e.id})" class="text-red-400 hover:text-red-300 text-xs ml-2">✕</button>
        </div>
      `,n.onclick=t=>{t.target.tagName!=="BUTTON"&&(document.getElementById("searchQuery").value=e.query)},s.appendChild(n)})}document.addEventListener("DOMContentLoaded",()=>{v(),S();const s=localStorage.getItem("quickTavilySearch");s&&(document.getElementById("searchQuery").value=s,localStorage.removeItem("quickTavilySearch")),document.getElementById("searchQuery").addEventListener("keypress",e=>{e.key==="Enter"&&E()})});
