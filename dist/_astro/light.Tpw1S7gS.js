import{L as T,S as l,a as u,b as E,s as _,m as F}from"./decorators.serialization.DTWIlLMH.js";import{V as y}from"./math.vector.C8FsJn6B.js";import{a as m,T as p,G as M}from"./math.color.BvxHr_bk.js";import{N as I}from"./node.B7U3vf9R.js";import{T as A}from"./tools.kgQOdK5j.js";class s{constructor(e,t,i=!1,r,n=!1,h){this._uniformNames=[],this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||n,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._trackUBOsInFrame=!1,(h===void 0&&this._engine._features.trackUbosInFrame||h===!0)&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0,this._trackUBOsInFrame=!0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}getUniformNames(){return this._uniformNames}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const r=this._uniformLocationPointer-i;for(let n=0;n<r;n++)this._data.push(0)}}addUniform(e,t,i=0){if(i>0&&typeof t=="number"&&(this._uniformArraySizes[e]={strideSize:t,arraySize:i}),this._uniformLocations[e]!==void 0||(this._uniformNames.push(e),this._noUBO))return;let r;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),t==16)t=t*i;else{const h=(4-t)*i;t=t*i+h}r=[];for(let n=0;n<t;n++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{r=[];for(let n=0;n<t;n++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let n=0;n<t;n++)this._data.push(r[n]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){const r=[t,i];this.addUniform(e,r)}addFloat3(e,t,i,r){const n=[t,i,r];this.addUniform(e,n)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNamesDebug(){const e=[];let t=0;for(const i in this._uniformLocations)if(e.push(i),++t===10)break;return e.join(",")}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()),this._trackUBOsInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._trackUBOsInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}set name(e){this._name=e}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._trackUBOsInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(s._UpdatedUbosInFrame[this._name]||(s._UpdatedUbosInFrame[this._name]=0),s._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._trackUBOsInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){if(this._buffer){T.Error("Cannot add an uniform after UBO has been created. uniformName="+e);return}this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let n=0;n<i;n++)this._bufferData[r+n]=t[n];else{let n=!1;for(let h=0;h<i;h++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+h]!==Math.fround(t[h]))&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+h]=t[h]);this._needSync=this._needSync||n}}updateUniformArray(e,t,i){this._checkNewFrame();const r=this._uniformLocations[e];if(r===void 0){T.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const n=this._uniformArraySizes[e];if(this._dynamic)for(let h=0;h<i;h++)this._bufferData[r+h]=t[h];else{let h=!1,o=0,d=0;for(let c=0;c<i;c++)if(this._bufferData[r+d*4+o]!==A.FloatRound(t[c])&&(h=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+d*4+o]=t[c]),o++,o===n.strideSize){for(;o<4;o++)this._bufferData[r+d*4+o]=0;o=0,d++}this._needSync=this._needSync||h}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)s._TempBuffer[i*4]=t[i*3],s._TempBuffer[i*4+1]=t[i*3+1],s._TempBuffer[i*4+2]=t[i*3+2],s._TempBuffer[i*4+3]=0;this.updateUniform(e,s._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)s._TempBuffer[i*4]=t[i*2],s._TempBuffer[i*4+1]=t[i*2+1],s._TempBuffer[i*4+2]=0,s._TempBuffer[i*4+3]=0;this.updateUniform(e,s._TempBuffer,8)}_updateFloatForEffect(e,t,i=""){this._currentEffect.setFloat(e+i,t)}_updateFloatForUniform(e,t){s._TempBuffer[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){s._TempBuffer[0]=t,s._TempBuffer[1]=i,this.updateUniform(e,s._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,n=""){this._currentEffect.setFloat3(e+n,t,i,r)}_updateFloat3ForUniform(e,t,i,r){s._TempBuffer[0]=t,s._TempBuffer[1]=i,s._TempBuffer[2]=r,this.updateUniform(e,s._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,n,h=""){this._currentEffect.setFloat4(e+h,t,i,r,n)}_updateFloat4ForUniform(e,t,i,r,n){s._TempBuffer[0]=t,s._TempBuffer[1]=i,s._TempBuffer[2]=r,s._TempBuffer[3]=n,this.updateUniform(e,s._TempBuffer,4)}_updateFloatArrayForEffect(e,t,i=""){switch(this._uniformArraySizes[e]?.strideSize){case 2:this._currentEffect.setFloatArray2(e+i,t);break;case 3:this._currentEffect.setFloatArray3(e+i,t);break;case 4:this._currentEffect.setFloatArray4(e+i,t);break;default:this._currentEffect.setFloatArray(e+i,t);break}}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){s._TempBufferInt32View.set(t),this.updateUniformArray(e,s._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){s._TempBufferUInt32View.set(t),this.updateUniformArray(e,s._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){s._TempBuffer[0]=t.x,s._TempBuffer[1]=t.y,s._TempBuffer[2]=t.z,this.updateUniform(e,s._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){s._TempBuffer[0]=t.x,s._TempBuffer[1]=t.y,s._TempBuffer[2]=t.z,s._TempBuffer[3]=t.w,this.updateUniform(e,s._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,this.updateUniform(e,s._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,s._TempBuffer[3]=i,this.updateUniform(e,s._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,s._TempBuffer[3]=t.a,this.updateUniform(e,s._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){s._TempBufferInt32View[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=i,this.updateUniform(e,s._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,n=""){this._currentEffect.setInt3(e+n,t,i,r)}_updateInt3ForUniform(e,t,i,r){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=i,s._TempBufferInt32View[2]=r,this.updateUniform(e,s._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,n,h=""){this._currentEffect.setInt4(e+h,t,i,r,n)}_updateInt4ForUniform(e,t,i,r,n){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=i,s._TempBufferInt32View[2]=r,s._TempBufferInt32View[3]=n,this.updateUniform(e,s._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){s._TempBufferUInt32View[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=i,this.updateUniform(e,s._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,n=""){this._currentEffect.setUInt3(e+n,t,i,r)}_updateUInt3ForUniform(e,t,i,r){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=i,s._TempBufferUInt32View[2]=r,this.updateUniform(e,s._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,n,h=""){this._currentEffect.setUInt4(e+h,t,i,r,n)}_updateUInt4ForUniform(e,t,i,r,n){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=i,s._TempBufferUInt32View[2]=r,s._TempBufferUInt32View[3]=n,this.updateUniform(e,s._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,this._buffers.length>1&&this._buffers[t][1]&&this._bufferData.set(this._buffers[t][1]),this._valueCache={},this._currentFrameId=this._engine.frameId,!0;return!1}has(e){return this._uniformLocations[e]!==void 0}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._trackUBOsInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const r=this._buffers[i][0];this._engine._releaseBuffer(r)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}s._UpdatedUbosInFrame={};s._MAX_UNIFORM_SIZE=256;s._TempBuffer=new Float32Array(s._MAX_UNIFORM_SIZE);s._TempBufferInt32View=new Int32Array(s._TempBuffer.buffer);s._TempBufferUInt32View=new Uint32Array(s._TempBuffer.buffer);class f{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}f.FALLOFF_DEFAULT=0;f.FALLOFF_PHYSICAL=1;f.FALLOFF_GLTF=2;f.FALLOFF_STANDARD=3;f.LIGHTMAP_DEFAULT=0;f.LIGHTMAP_SPECULAR=1;f.LIGHTMAP_SHADOWSONLY=2;f.INTENSITYMODE_AUTOMATIC=0;f.INTENSITYMODE_LUMINOUSPOWER=1;f.INTENSITYMODE_LUMINOUSINTENSITY=2;f.INTENSITYMODE_ILLUMINANCE=3;f.INTENSITYMODE_LUMINANCE=4;f.LIGHTTYPEID_POINTLIGHT=0;f.LIGHTTYPEID_DIRECTIONALLIGHT=1;f.LIGHTTYPEID_SPOTLIGHT=2;f.LIGHTTYPEID_HEMISPHERICLIGHT=3;f.LIGHTTYPEID_RECT_AREALIGHT=4;f.LIGHTTYPEID_CLUSTERED_CONTAINER=5;class a extends I{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new m(1,1,1),this.specular=new m(1,1,1),this.falloffType=a.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=a.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._currentViewDepth=0,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new s(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,n=!0){const h=e.toString();let o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+h),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;const d=this.getScaledIntensity();this.transferToEffect(i,h),this.diffuse.scaleToRef(d,p.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",p.Color3[0],this.range,h),r&&(this.specular.scaleToRef(d,p.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",p.Color3[1],this.radius,h)),o=!0}if(this.transferTexturesToEffect(i,h),t.shadowsEnabled&&this.shadowEnabled&&n){const d=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();d&&(d.bindShadowLight(h,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric","Clustered"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return this._shadowGenerators===null?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return y.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=a.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const r=l.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){const e=l.Serialize(this);if(e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0){e.excludedMeshesIds=[];for(const t of this.excludedMeshes)e.excludedMeshesIds.push(t.id)}if(this.includedOnlyMeshes.length>0){e.includedOnlyMeshesIds=[];for(const t of this.includedOnlyMeshes)e.includedOnlyMeshesIds.push(t.id)}return l.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const r=I.Construct("Light_Type_"+e,t,i);return r||null}static Parse(e,t){const i=a.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const r=l.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(let n=0;n<e.animations.length;n++){const h=e.animations[n],o=M("BABYLON.Animation");o&&r.animations.push(o.Parse(h))}I.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){const t=e.push;e.push=(...r)=>{const n=t.apply(e,r);for(const h of r)h._resyncLightSource(this);return n};const i=e.splice;e.splice=(r,n)=>{const h=i.apply(e,[r,n]);for(const o of h)o._resyncLightSource(this);return h};for(const r of e)r._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...r)=>{const n=t.apply(e,r);return this._resyncMeshes(),n};const i=e.splice;e.splice=(r,n)=>{const h=i.apply(e,[r,n]);return this._resyncMeshes(),h},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===a.INTENSITYMODE_AUTOMATIC&&(t===a.LIGHTTYPEID_DIRECTIONALLIGHT?i=a.INTENSITYMODE_ILLUMINANCE:i=a.INTENSITYMODE_LUMINOUSINTENSITY),t){case a.LIGHTTYPEID_POINTLIGHT:case a.LIGHTTYPEID_SPOTLIGHT:switch(i){case a.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case a.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case a.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case a.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case a.INTENSITYMODE_ILLUMINANCE:e=1;break;case a.INTENSITYMODE_LUMINANCE:{let r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r));break}}break;case a.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}_isReady(){return!0}}a.FALLOFF_DEFAULT=f.FALLOFF_DEFAULT;a.FALLOFF_PHYSICAL=f.FALLOFF_PHYSICAL;a.FALLOFF_GLTF=f.FALLOFF_GLTF;a.FALLOFF_STANDARD=f.FALLOFF_STANDARD;a.LIGHTMAP_DEFAULT=f.LIGHTMAP_DEFAULT;a.LIGHTMAP_SPECULAR=f.LIGHTMAP_SPECULAR;a.LIGHTMAP_SHADOWSONLY=f.LIGHTMAP_SHADOWSONLY;a.INTENSITYMODE_AUTOMATIC=f.INTENSITYMODE_AUTOMATIC;a.INTENSITYMODE_LUMINOUSPOWER=f.INTENSITYMODE_LUMINOUSPOWER;a.INTENSITYMODE_LUMINOUSINTENSITY=f.INTENSITYMODE_LUMINOUSINTENSITY;a.INTENSITYMODE_ILLUMINANCE=f.INTENSITYMODE_ILLUMINANCE;a.INTENSITYMODE_LUMINANCE=f.INTENSITYMODE_LUMINANCE;a.LIGHTTYPEID_POINTLIGHT=f.LIGHTTYPEID_POINTLIGHT;a.LIGHTTYPEID_DIRECTIONALLIGHT=f.LIGHTTYPEID_DIRECTIONALLIGHT;a.LIGHTTYPEID_SPOTLIGHT=f.LIGHTTYPEID_SPOTLIGHT;a.LIGHTTYPEID_HEMISPHERICLIGHT=f.LIGHTTYPEID_HEMISPHERICLIGHT;a.LIGHTTYPEID_RECT_AREALIGHT=f.LIGHTTYPEID_RECT_AREALIGHT;u([E()],a.prototype,"diffuse",void 0);u([E()],a.prototype,"specular",void 0);u([_()],a.prototype,"falloffType",void 0);u([_()],a.prototype,"intensity",void 0);u([_()],a.prototype,"range",null);u([_()],a.prototype,"intensityMode",null);u([_()],a.prototype,"radius",null);u([_()],a.prototype,"_renderPriority",void 0);u([F("_reorderLightsInScene")],a.prototype,"renderPriority",void 0);u([_("shadowEnabled")],a.prototype,"_shadowEnabled",void 0);u([_("excludeWithLayerMask")],a.prototype,"_excludeWithLayerMask",void 0);u([_("includeOnlyWithLayerMask")],a.prototype,"_includeOnlyWithLayerMask",void 0);u([_("lightmapMode")],a.prototype,"_lightmapMode",void 0);export{a as L,s as U,f as a};
