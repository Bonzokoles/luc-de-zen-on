var l=[],p=[],f=[];try{l=JSON.parse(localStorage.getItem("imageHistory")||"[]"),p=JSON.parse(localStorage.getItem("userGallery")||"[]"),f=JSON.parse(localStorage.getItem("lastThreeGenerated")||"[]")}catch{l=[],p=[],f=[]}function J(a){var r=String(a||"").split("x"),t=parseInt(r[0],10),e=parseInt(r[1],10);return(isNaN(t)||isNaN(e))&&(t=512,e=512),{width:t,height:e}}async function W(){console.log("đźŽ¨ generateImage() called!");var a=document.getElementById("imagePrompt"),r=document.getElementById("imageModel"),t=document.getElementById("imageStyle"),e=document.getElementById("imageSize"),n=document.getElementById("imageSteps");document.getElementById("loading");var i=document.getElementById("errorBox"),o=document.getElementById("generateBtn"),d=document.getElementById("resultSection"),s=document.getElementById("previewWindow"),v=a?String(a.value).trim():"";if(!v){alert("ProszÄ™ wprowadziÄ‡ opis obrazu");return}var m=document.getElementById("apiProvider")?.value||"cloudflare";i&&(i.classList.add("hidden"),i.textContent=""),d&&d.classList.add("hidden"),s&&s.classList.remove("hidden"),Z(),o&&(o.disabled=!0,o.textContent="đźŽ¨ Generowanie...");var S=_(m),z=document.getElementById("negativePrompt"),w=document.getElementById("seedInput"),I=document.getElementById("guidanceScale");document.getElementById("batchCount");var B=document.getElementById("cfgScale"),L=document.getElementById("tilingToggle"),k=document.getElementById("hiResToggle");try{var C=r?String(r.value):"",x=t?String(t.value):"",P=n?parseInt(String(n.value),10):void 0,R=e?String(e.value):"512x512",h=J(R),$=m==="huggingface"?"/api/generate-hf":"/api/generate-image",c={prompt:v,model:C,width:h.width,height:h.height,steps:P};if(m==="cloudflare")c.style=x,c.enhancePrompt=!0,c.enhanceOptions={quality:"high",enhanceCreativity:!0};else if(m==="huggingface"){var D=B?parseFloat(B.value):7.5;c.guidance_scale=isNaN(D)?7.5:D,c.negative_prompt=z&&z.value.trim()||"blurry, bad quality, distorted, ugly"}if(w&&w.value){var M=parseInt(w.value,10);isNaN(M)||(c.seed=M)}if(I&&I.value&&m==="cloudflare"){var N=parseFloat(I.value);isNaN(N)||(c.guidance=N)}L&&L.checked&&(c.tiling=!0),k&&k.checked&&(c.hiRes=!0);var y=await fetch($,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!y.ok){var T="BĹ‚Ä…d generacji obrazu";try{var E=await y.json();E&&E.error&&(T=E.error)}catch{}throw new Error(T)}var G,g,O=null;m==="huggingface"?(G=await y.json(),g=G.imageUrl):(O=await y.blob(),g=URL.createObjectURL(O)),clearInterval(S),Q(g,v);var A=document.getElementById("generatedImage");A&&(A.src=g),setTimeout(function(){d&&d.classList.remove("hidden"),s&&setTimeout(function(){s.classList.add("hidden")},2e3)},1e3);try{var K=g,b={id:Date.now(),prompt:v,imageUrl:K,ts:new Date().toISOString(),settings:{apiProvider:m,model:C,style:x,width:h.width,height:h.height,steps:P}};l.unshift(b),l.length>50&&(l=l.slice(0,50)),f.unshift(b),f.length>3&&(f=f.slice(0,3)),p.unshift(b),p.length>4&&(p=p.slice(0,4)),localStorage.setItem("imageHistory",JSON.stringify(l)),localStorage.setItem("lastThreeGenerated",JSON.stringify(f)),localStorage.setItem("userGallery",JSON.stringify(p)),F(),U(),j("đźŽ‰ Obraz wygenerowany pomyĹ›lnie!","success"),m!=="huggingface"&&g&&g.startsWith("blob:")&&setTimeout(function(){URL.revokeObjectURL(g)},6e4)}catch(u){console.error("Storage error:",u)}}catch(u){console.error("Generation error:",u),clearInterval(S),s&&s.classList.add("hidden"),i&&(i.textContent=u&&u.message?u.message:String(u),i.classList.remove("hidden")),j("âťŚ "+(u.message||"BĹ‚Ä…d generacji"),"error")}finally{o&&(o.disabled=!1,o.textContent="đźŽ¨ Generuj Obraz")}}function F(){X()}function X(){try{var a=document.getElementById("totalGenerated");a&&l&&(a.textContent=l.length.toString());var r=document.getElementById("todayGenerated");if(r&&l){var t=new Date().toDateString(),e=l.filter(function(n){try{return new Date(n.ts).toDateString()===t}catch{return!1}}).length;r.textContent=e.toString()}}catch(n){console.error("Error updating chat stats:",n)}}function U(){try{window.dispatchEvent(new CustomEvent("refreshChatHistory",{detail:{history:l,latest:l[0]}}))}catch(a){console.error("Error refreshing chat history:",a)}}function Z(){var a=document.getElementById("placeholderContent"),r=document.getElementById("previewImage"),t=document.getElementById("progressBar"),e=document.getElementById("progressLabel"),n=document.getElementById("progressPercent");a&&a.classList.remove("hidden"),r&&r.classList.add("hidden"),t&&(t.style.width="0%"),e&&(e.textContent="Przygotowywanie..."),n&&(n.textContent="0%")}function _(a){var r=document.getElementById("progressBar"),t=document.getElementById("progressLabel"),e=document.getElementById("progressPercent"),n=0,i,o;a==="huggingface"?(i=[{percent:10,label:"ĹÄ…czenie z Hugging Face..."},{percent:25,label:"Ĺadowanie modelu..."},{percent:45,label:"Generowanie obrazu..."},{percent:70,label:"Przetwarzanie..."},{percent:90,label:"Finalizacja..."}],o=.8):(i=[{percent:15,label:"Inicjalizacja modelu..."},{percent:30,label:"Analiza promptu..."},{percent:50,label:"Generowanie obrazu..."},{percent:75,label:"Optymalizacja..."},{percent:95,label:"Finalizacja..."}],o=1.2);var d=0;return setInterval(function(){if(d<i.length&&n>=i[d].percent-5){var s=i[d];n=Math.min(s.percent,n+Math.random()*3*o),r&&(r.style.width=n+"%"),t&&(t.textContent=s.label),e&&(e.textContent=Math.floor(n)+"%"),n>=s.percent&&d++}else n<90&&(n+=Math.random()*.8,r&&(r.style.width=n+"%"),e&&(e.textContent=Math.floor(n)+"%"))},250)}function Q(a,r){var t=document.getElementById("placeholderContent"),e=document.getElementById("previewImage"),n=document.getElementById("progressBar"),i=document.getElementById("progressLabel"),o=document.getElementById("progressPercent");n&&(n.style.width="100%"),i&&(i.textContent="Gotowe!"),o&&(o.textContent="100%"),setTimeout(function(){t&&t.classList.add("hidden"),e&&(e.src=a,e.classList.remove("hidden"))},500)}function j(a,r="info"){var t=document.createElement("div");t.className=`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-300 ${r==="success"?"bg-green-600":r==="error"?"bg-red-600":"bg-blue-600"}`,t.textContent=a,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}function Y(a){var r=document.getElementById("imageModal");r&&r.classList.add("hidden")}document.addEventListener("DOMContentLoaded",function(){F();var a=document.getElementById("photoToPhotoImage");a&&a.addEventListener("change",function(r){var t=r.target.files[0];if(t){var e=new FileReader;e.onload=function(n){var i=document.getElementById("photoUploadPreview");i&&(i.innerHTML=`
                    <img src="${n.target.result}" alt="Upload preview" 
                         class="w-full h-full object-cover rounded" />
                  `)},e.readAsDataURL(t)}})});function q(){const a=document.getElementById("photoPrompt"),r=document.getElementById("chatMessagesArea");if(!a||!r)return;const t=a.value.trim();t&&(H(t,"user"),setTimeout(()=>{const e=V(t);H(e,"ai")},1e3),a.value="")}function H(a,r){const t=document.getElementById("chatMessagesArea");if(!t)return;t.innerHTML.includes("Rozpocznij konwersacjÄ™")&&(t.innerHTML="");const e=document.createElement("div");e.className=`chat-message ${r}`,e.textContent=a,t.appendChild(e),t.scrollTop=t.scrollHeight}function V(a){const r=[`Rozumiem! Chcesz przeksztaĹ‚ciÄ‡ obraz: "${a}". Zaraz to zrobiÄ™! đźŽ¨`,`Ĺšwietny pomysĹ‚! "${a}" brzmi interesujÄ…co. PrzygotowujÄ™ transformacjÄ™...`,`AI: AnalizujÄ™ twĂłj request "${a}". BÄ™dzie rewelacyjnie! âś¨`,`Przetwarzam: "${a}". AI wie co robiÄ‡! đź¤–`,`Fantastyczne! "${a}" to ciekawe wyzwanie dla AI! đźš€`];return r[Math.floor(Math.random()*r.length)]}document.addEventListener("DOMContentLoaded",function(){const a=document.getElementById("photoPrompt");a&&a.addEventListener("keypress",function(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),q())}),document.addEventListener("keydown",function(e){if(e.ctrlKey&&e.key==="Enter"&&(e.preventDefault(),W()),e.ctrlKey&&e.shiftKey&&e.key==="G"){e.preventDefault();const n=document.getElementById("imagePrompt");n&&n.focus()}e.key==="F5"&&!e.ctrlKey&&(e.preventDefault(),window.dispatchEvent(new Event("refreshChatHistory"))),e.key==="Escape"&&(Y(),closePromptEnhancer()),e.key==="F1"&&(e.preventDefault(),toggleKeyboardShortcuts()),e.altKey&&e.key==="m"&&(e.preventDefault(),toggleAllPanels("minimize"))}),window.minimizePanel=function(e){const n=document.querySelector(`[data-panel="${e}"]`)||document.querySelector(".xl\\:col-span-3, .xl\\:col-span-6");n&&n.classList.toggle("panel-minimized")},window.updateModelOptions=function(){const e=document.getElementById("apiProvider").value,n=document.getElementById("imageModel");n.innerHTML="",e==="cloudflare"?n.innerHTML=`
              <option value="@cf/stabilityai/stable-diffusion-xl-base-1.0" selected>Stable Diffusion XL</option>
              <option value="@cf/lykon/dreamshaper-8-lcm">DreamShaper 8 LCM</option>
              <option value="@cf/black-forest-labs/flux-1-schnell">Flux-1 Schnell</option>
              <option value="@cf/runwayml/stable-diffusion-v1-5">Stable Diffusion v1.5</option>
            `:e==="huggingface"&&(n.innerHTML=`
              <option value="stabilityai/stable-diffusion-2-1" selected>Stable Diffusion 2.1</option>
              <option value="stabilityai/stable-diffusion-xl-base-1.0">SDXL Base 1.0</option>
              <option value="runwayml/stable-diffusion-v1-5">SD v1.5</option>
              <option value="CompVis/stable-diffusion-v1-4">SD v1.4</option>
              <option value="dreamlike-art/dreamlike-diffusion-1.0">Dreamlike Diffusion</option>
              <option value="nitrosocke/Ghibli-Diffusion">Ghibli Style</option>
            `)},window.maximizePanel=function(e){const n=document.querySelector(`[data-panel="${e}"]`)||document.querySelector(".xl\\:col-span-3, .xl\\:col-span-6");n&&n.classList.toggle("panel-maximized")},window.toggleAllPanels=function(e){document.querySelectorAll(".xl\\:col-span-3, .xl\\:col-span-6").forEach(i=>{e==="minimize"&&i.classList.toggle("panel-minimized")})};var r=document.getElementById("advancedSettings");r&&r.classList.add("hidden"),window.toggleKeyboardShortcuts=function(){let e=document.getElementById("keyboardShortcuts");e||(e=t(),document.body.appendChild(e)),e.classList.toggle("show")};function t(){const e=document.createElement("div");return e.id="keyboardShortcuts",e.className="keyboard-shortcuts",e.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 0.5rem; color: #4fd1c5;">âŚ¨ď¸Ź SkrĂłty klawiszowe</div>
            <div class="shortcut-item">
              <span>Generuj obraz</span>
              <span class="shortcut-key">Ctrl+Enter</span>
            </div>
            <div class="shortcut-item">
              <span>Focus na prompt</span>
              <span class="shortcut-key">Ctrl+Shift+G</span>
            </div>
            <div class="shortcut-item">
              <span>OdĹ›wieĹĽ historiÄ™</span>
              <span class="shortcut-key">F5</span>
            </div>
            <div class="shortcut-item">
              <span>Zamknij modaĹ‚y</span>
              <span class="shortcut-key">Escape</span>
            </div>
            <div class="shortcut-item">
              <span>Minimalizuj panele</span>
              <span class="shortcut-key">Alt+M</span>
            </div>
            <div class="shortcut-item">
              <span>PokaĹĽ skrĂłty</span>
              <span class="shortcut-key">F1</span>
            </div>
            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(79, 209, 197, 0.2); color: #64748b; font-size: 0.7rem;">
              Aplikacja w stylu desktop â€˘ v2.0
            </div>
          `,e}});
