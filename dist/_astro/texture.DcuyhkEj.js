import{_ as v,T as p,S as N,E as V,a as d,s as u}from"./decorators.serialization.DTWIlLMH.js";import{O as B,V as y,M as _,T as g}from"./math.vector.C8FsJn6B.js";import{B as w}from"./baseTexture.xJCKUhPX.js";import{G as D,R as F}from"./math.color.BvxHr_bk.js";import{I as G}from"./instantiationTools.DpJ04vA6.js";import{P as W}from"./math.plane.DogzNArm.js";function P(f,e,a=!1){const i=e.width,n=e.height;if(f instanceof Float32Array){let s=f.byteLength/f.BYTES_PER_ELEMENT;const h=new Uint8Array(s);for(;--s>=0;){let c=f[s];c<0?c=0:c>1&&(c=1),h[s]=c*255}f=h}const o=document.createElement("canvas");o.width=i,o.height=n;const l=o.getContext("2d");if(!l)return null;const R=l.createImageData(i,n);if(R.data.set(f),l.putImageData(R,0,0),a){const s=document.createElement("canvas");s.width=i,s.height=n;const h=s.getContext("2d");return h?(h.translate(0,n),h.scale(1,-1),h.drawImage(o,0,0),s.toDataURL("image/png")):null}return o.toDataURL("image/png")}function z(f,e=0,a=0){const i=f.getInternalTexture();if(!i)return null;const n=f._readPixelsSync(e,a);return n?P(n,f.getSize(),i.invertY):null}async function Y(f,e=0,a=0){const i=f.getInternalTexture();if(!i)return null;const n=await f.readPixels(e,a);return n?P(n,f.getSize(),i.invertY):null}class t extends w{static _CreateVideoTexture(e,a,i,n=!1,o=!1,l=t.TRILINEAR_SAMPLINGMODE,R={},r,s=5){throw v("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,a,i,n,o=t.TRILINEAR_SAMPLINGMODE,l=null,R=null,r=null,s=!1,h,c,M,b,L){super(a),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new B,this._isBlocking=!0,this.name=e||"",this.url=e;let S,T=!1,C=null,O=!0;typeof i=="object"&&i!==null?(S=i.noMipmap??!1,n=i.invertY??!0,o=i.samplingMode??t.TRILINEAR_SAMPLINGMODE,l=i.onLoad??null,R=i.onError??null,r=i.buffer??null,s=i.deleteBuffer??!1,h=i.format,c=i.mimeType,M=i.loaderOptions,b=i.creationFlags,T=i.useSRGBBuffer??!1,C=i.internalTexture??null,O=i.gammaSpace??O,L=i.forcedExtension??L):S=!!i,this._gammaSpace=O,this._noMipmap=S,this._invertY=n===void 0?!0:n,this._initialSamplingMode=o,this._buffer=r,this._deleteBuffer=s,this._mimeType=c,this._loaderOptions=M,this._creationFlags=b,this._useSRGBBuffer=T,this._forcedExtension=L,h!==void 0&&(this._format=h);const E=this.getScene(),U=this._getEngine();if(!U)return;U.onBeforeTextureInitObservable.notifyObservers(this);const x=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),l&&l(),!this.isBlocking&&E&&E.resetCachedMaterial()},I=(m,A)=>{this._loadingError=!0,this._errorObject={message:m,exception:A},R&&R(m,A),t.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!C){this._delayedOnLoad=x,this._delayedOnError=I;return}if(this._texture=C??this._getFromCache(this.url,S,o,this._invertY,T,this.isCube),this._texture)if(this._texture.isReady)p.SetImmediate(()=>x());else{const m=this._texture.onLoadedObservable.add(x);this._texture.onErrorObservable.add(A=>{I(A.message,A.exception),this._texture?.onLoadedObservable.remove(m)})}else if(!E||!E.useDelayedTextureLoading){try{this._texture=U.createTexture(this.url,S,this._invertY,E,o,x,I,this._buffer,void 0,this._format,this._forcedExtension,c,M,b,T)}catch(m){throw I("error loading",m),m}s&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=x,this._delayedOnError=I}updateURL(e,a=null,i,n){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,o=>o.hasTexture(this))),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=a,this._forcedExtension=n,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?p.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,a,i,n){e*=this._cachedUScale,a*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,a-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,y.TransformCoordinatesFromFloatsToRef(e,a,i,this._rowGenerationMatrix,n),n.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,n.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,n.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=_.Zero(),this._rowGenerationMatrix=new _,this._t0=y.Zero(),this._t1=y.Zero(),this._t2=y.Zero()),_.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(_.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,g.Matrix[0]),_.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,g.Matrix[1]),_.ScalingToRef(this._cachedUScale,this._cachedVScale,0,g.Matrix[2]),_.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,g.Matrix[3]),g.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(g.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(g.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(g.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),_.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const a=this.getScene();if(!a)return this._cachedTextureMatrix;const i=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&i!==this._cachedIdentity3x2&&a.markAllMaterialsAsDirty(1,n=>n.hasTexture(this)),this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===t.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=_.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=_.Zero());const a=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case t.PLANAR_MODE:{_.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case t.PROJECTION_MODE:{_.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:_.IdentityToRef(this._cachedReflectionTextureMatrix);break}return a&&e.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return N.Clone(()=>new t(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){const e=this.name;t.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const a=super.serialize(t._SerializeInternalTextureUniqueId);if(!a)return null;if(t.SerializeBuffers||t.ForceSerializeBuffers)if(typeof this._buffer=="string"&&this._buffer.startsWith("data:"))a.base64String=this._buffer,a.name=a.name.replace("data:","");else if(this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array){const i=this.mimeType||"image/png";a.base64String=`data:${i};base64,${V(this._buffer)}`}else(t.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(a.base64String=!this._engine||this._engine._features.supportSyncTextureRead?z(this):Y(this));return a.invertY=this._invertY,a.samplingMode=this.samplingMode,a._creationFlags=this._creationFlags,a._useSRGBBuffer=this._useSRGBBuffer,t._SerializeInternalTextureUniqueId&&(a.internalTextureUniqueId=this._texture?.uniqueId),a.internalTextureLabel=this._texture?.label,a.noMipmap=this._noMipmap,this.name=e,a}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,a,i){if(e.customType){const s=G.Instantiate(e.customType).Parse(e,a,i);return e.samplingMode&&s.updateSamplingMode&&s._samplingMode&&s._samplingMode!==e.samplingMode&&s.updateSamplingMode(e.samplingMode),s}if(e.isCube&&!e.isRenderTarget)return t._CubeTextureParser(e,a,i);const n=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!n)return null;let o;if(n){const r=a.getEngine().getLoadedTexturesCache();for(const s of r)if(s.uniqueId===e.internalTextureUniqueId){o=s;break}}const l=r=>{if(r&&r._texture&&(r._texture._cachedWrapU=null,r._texture._cachedWrapV=null,r._texture._cachedWrapR=null),e.samplingMode){const s=e.samplingMode;r&&r.samplingMode!==s&&r.updateSamplingMode(s)}if(r&&e.animations)for(let s=0;s<e.animations.length;s++){const h=e.animations[s],c=D("BABYLON.Animation");c&&r.animations.push(c.Parse(h))}r&&r._texture&&(n&&!o&&r._texture._setUniqueId(e.internalTextureUniqueId),r._texture.label=e.internalTextureLabel)};return N.Parse(()=>{let r=!0;if(e.noMipmap&&(r=!1),e.mirrorPlane){const s=t._CreateMirror(e.name,e.renderTargetSize,a,r);return s._waitingRenderList=e.renderList,s.mirrorPlane=W.FromArray(e.mirrorPlane),l(s),s}else if(e.isRenderTarget&&!e.base64String){let s=null;if(e.isCube){if(a.reflectionProbes)for(let h=0;h<a.reflectionProbes.length;h++){const c=a.reflectionProbes[h];if(c.name===e.name)return c.cubeTexture}}else s=t._CreateRenderTargetTexture(e.name,e.renderTargetSize,a,r,e._creationFlags??0),s._waitingRenderList=e.renderList;return l(s),s}else if(e.isVideo){const s=t._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),a,r,e.invertY,e.samplingMode,e.settings||{});return l(s),s}else{let s;if(e.base64String&&!o)s=t.CreateFromBase64String(e.base64String,e.base64String,a,!r,e.invertY,e.samplingMode,()=>{l(s)},e._creationFlags??0,e._useSRGBBuffer??!1),s.name=e.name;else{let h;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?h=e.name:h=i+e.name,e.url&&(e.url.startsWith("data:")||t.UseSerializedUrlIfAny)&&(h=e.url);const c={noMipmap:!r,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{l(s)},internalTexture:o};s=new t(h,a,c)}return s}},e,a)}static CreateFromBase64String(e,a,i,n,o,l=t.TRILINEAR_SAMPLINGMODE,R=null,r=null,s=5,h,c){return new t("data:"+a,i,n,o,l,R,r,e,!1,s,void 0,void 0,h,c)}static LoadFromDataString(e,a,i,n=!1,o,l=!0,R=t.TRILINEAR_SAMPLINGMODE,r=null,s=null,h=5,c,M){return e.substring(0,5)!=="data:"&&(e="data:"+e),new t(e,i,o,l,R,r,s,a,n,h,void 0,void 0,c,M)}}t.SerializeBuffers=!0;t.ForceSerializeBuffers=!1;t.OnTextureLoadErrorObservable=new B;t._SerializeInternalTextureUniqueId=!1;t._CubeTextureParser=(f,e,a)=>{throw v("CubeTexture")};t._CreateMirror=(f,e,a,i)=>{throw v("MirrorTexture")};t._CreateRenderTargetTexture=(f,e,a,i,n)=>{throw v("RenderTargetTexture")};t.NEAREST_SAMPLINGMODE=1;t.NEAREST_NEAREST_MIPLINEAR=8;t.BILINEAR_SAMPLINGMODE=2;t.LINEAR_LINEAR_MIPNEAREST=11;t.TRILINEAR_SAMPLINGMODE=3;t.LINEAR_LINEAR_MIPLINEAR=3;t.NEAREST_NEAREST_MIPNEAREST=4;t.NEAREST_LINEAR_MIPNEAREST=5;t.NEAREST_LINEAR_MIPLINEAR=6;t.NEAREST_LINEAR=7;t.NEAREST_NEAREST=1;t.LINEAR_NEAREST_MIPNEAREST=9;t.LINEAR_NEAREST_MIPLINEAR=10;t.LINEAR_LINEAR=2;t.LINEAR_NEAREST=12;t.EXPLICIT_MODE=0;t.SPHERICAL_MODE=1;t.PLANAR_MODE=2;t.CUBIC_MODE=3;t.PROJECTION_MODE=4;t.SKYBOX_MODE=5;t.INVCUBIC_MODE=6;t.EQUIRECTANGULAR_MODE=7;t.FIXED_EQUIRECTANGULAR_MODE=8;t.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;t.CLAMP_ADDRESSMODE=0;t.WRAP_ADDRESSMODE=1;t.MIRROR_ADDRESSMODE=2;t.UseSerializedUrlIfAny=!1;d([u()],t.prototype,"url",void 0);d([u()],t.prototype,"uOffset",void 0);d([u()],t.prototype,"vOffset",void 0);d([u()],t.prototype,"uScale",void 0);d([u()],t.prototype,"vScale",void 0);d([u()],t.prototype,"uAng",void 0);d([u()],t.prototype,"vAng",void 0);d([u()],t.prototype,"wAng",void 0);d([u()],t.prototype,"uRotationCenter",void 0);d([u()],t.prototype,"vRotationCenter",void 0);d([u()],t.prototype,"wRotationCenter",void 0);d([u()],t.prototype,"homogeneousRotationInUVTransform",void 0);d([u()],t.prototype,"isBlocking",null);F("BABYLON.Texture",t);N._TextureParser=t.Parse;export{t as T};
