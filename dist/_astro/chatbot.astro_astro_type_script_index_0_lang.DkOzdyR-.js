let r=JSON.parse(localStorage.getItem("chatHistory")||"[]"),d=null;async function h(){console.log("đźš€ sendMessage() wywoĹ‚ana");const s=document.getElementById("messageInput"),e=s.value.trim();if(console.log("đź“ť WiadomoĹ›Ä‡ do wysĹ‚ania:",e),!e){console.log("âťŚ Pusta wiadomoĹ›Ä‡ - przerywanie");return}const t=document.getElementById("sendButton"),o=document.getElementById("typingIndicator");console.log("âž• Dodawanie wiadomoĹ›ci uĹĽytkownika do czatu"),g(e,"user"),s.value="",t.disabled=!0,t.textContent="WysyĹ‚anie...",o.classList.remove("hidden"),console.log("đź”’ Przycisk zablokowany, rozpoczynanie wysyĹ‚ania");try{const a=document.getElementById("aiModel").value,n=parseFloat(document.getElementById("temperature").value),l=document.getElementById("language").value;console.log("âš™ď¸Ź Parametry:",{aiModel:a,temperature:n,language:l}),console.log("đź“¤ WysyĹ‚anie ĹĽÄ…dania do /api/chat:",{prompt:e,model:a,temperature:n,language:l});const i=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e})});if(console.log("đź“Ą OdpowiedĹş otrzymana:",i.status,i.statusText),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const c=await i.json();if(console.log("đź“Š Dane z API:",c),c.answer||c.response){const m=c.answer||c.response;console.log("âś… Dodawanie odpowiedzi AI:",m),g(m,"assistant"),w(e,m)}else throw new Error(c.error||"BĹ‚Ä…d odpowiedzi AI")}catch(a){console.error("âťŚ Chat error:",a),g("Przepraszam, wystÄ…piĹ‚ bĹ‚Ä…d podczas przetwarzania Twojej wiadomoĹ›ci. SprĂłbuj ponownie. BĹ‚Ä…d: "+a.message,"assistant",!0)}finally{console.log("đź”“ Odblokowanie przycisku"),t.disabled=!1,t.textContent="WyĹ›lij",o.classList.add("hidden")}}async function p(){console.log("đź§Ş Testowanie API...");try{const s=await fetch("/api/chat",{method:"GET"});console.log("đź“ˇ GET test response:",s.status,s.statusText);const e=await s.json();console.log("đź“Š GET test data:",e);const t=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:"test message"})});console.log("đź“ˇ POST test response:",t.status,t.statusText);const o=await t.json();console.log("đź“Š POST test data:",o)}catch(s){console.error("âťŚ API test error:",s)}}function g(s,e,t=!1){const o=document.getElementById("chatMessages"),a=document.createElement("div");a.className=`message ${e}-message`;const n=new Date().toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"}),l=e==="user"?"bg-blue-600/20 border-blue-400/30":t?"bg-red-600/20 border-red-400/30":"bg-cyan-600/20 border-cyan-400/30",u=e==="user"?"text-blue-400":t?"text-red-400":"text-cyan-400",i=e==="user"?"bg-blue-400":t?"bg-red-400":"bg-cyan-400";a.innerHTML=`
      <div class="message-content ${l} rounded-lg p-3">
        <div class="message-header flex items-center gap-2 mb-2">
          <span class="w-2 h-2 ${i} rounded-full"></span>
          <span class="${u} text-sm font-medium">${e==="user"?"Ty":"AI Assistant"}</span>
          <span class="text-gray-400 text-xs ml-auto">${n}</span>
        </div>
        <div class="message-text text-primary-foreground whitespace-pre-wrap">${s}</div>
      </div>
    `,o.appendChild(a),o.scrollTop=o.scrollHeight}function w(s,e){const t={id:d||Date.now(),timestamp:new Date().toISOString(),messages:[{type:"user",content:s},{type:"assistant",content:e}]};if(!d)d=t.id,r.unshift(t);else{const o=r.find(a=>a.id===d);o&&o.messages.push(...t.messages)}r.length>10&&(r=r.slice(0,10)),localStorage.setItem("chatHistory",JSON.stringify(r)),y()}function y(){const s=document.getElementById("chatHistoryList");s.innerHTML="",r.forEach(e=>{const t=document.createElement("div");t.className="history-item border border-edge rounded-lg p-3 cursor-pointer hover:border-cyan-400 transition-colors",t.style.background="rgba(0, 0, 0, 0.5)";const o=e.messages.find(n=>n.type==="user")?.content||"Rozmowa",a=new Date(e.timestamp).toLocaleDateString("pl-PL");t.innerHTML=`
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <p class="text-primary-foreground text-sm font-medium truncate">${o}</p>
            <p class="text-gray-400 text-xs">${a} â€˘ ${e.messages.length} wiadomoĹ›ci</p>
          </div>
          <button onclick="deleteChat(${e.id})" class="text-red-400 hover:text-red-300 text-xs ml-2">âś•</button>
        </div>
      `,t.onclick=n=>{n.target.tagName!=="BUTTON"&&f(e.id)},s.appendChild(t)})}function f(s){const e=r.find(o=>o.id===s);if(!e)return;const t=document.getElementById("chatMessages");t.innerHTML="",e.messages.forEach(o=>{g(o.content,o.type)}),d=s}document.addEventListener("DOMContentLoaded",()=>{console.log("đźš€ Chatbot DOM zaĹ‚adowany"),y(),p();const s=localStorage.getItem("quickChatPrompt");s&&(console.log("đź’ľ ZaĹ‚adowano szybki prompt:",s),document.getElementById("messageInput").value=s,localStorage.removeItem("quickChatPrompt")),window.testAPI=p,window.sendMessage=h,console.log("âś… Funkcje chatbot dostÄ™pne globalnie")});
