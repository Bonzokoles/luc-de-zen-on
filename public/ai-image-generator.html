<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBonzo AI - Generator Obraz�w</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Rajdhani', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a; color: white; min-height: 100vh; padding: 20px; line-height: 1.6;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: rgba(0, 0, 0, 0.3);
            -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 8px; padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 217, 255, 0.1);
        }
        .header { text-align: center; margin-bottom: 40px; border-bottom: 1px solid rgba(0, 217, 255, 0.3); padding-bottom: 20px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #00d9ff; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; font-family: 'Rajdhani', sans-serif; }
        .header p { color: #888; font-size: 1.1em; }
        .generator-form { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 217, 255, 0.3); border-radius: 8px; padding: 30px; margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { margin-bottom: 8px; font-weight: 600; color: #00d9ff; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em; }
        textarea, input[type="number"], select {
            background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(0,217,255,0.3);
            border-radius: 6px; padding: 12px 14px; outline: none; transition: border-color .2s, box-shadow .2s;
        }
        textarea { min-height: 100px; resize: vertical; }
        textarea:focus, input[type="number"]:focus, select:focus { border-color: #00d9ff; box-shadow: 0 0 0 3px rgba(0,217,255,0.15); }
        .generate-btn { display: inline-block; background: linear-gradient(90deg, #00d9ff, #0077ff); color: #000; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; letter-spacing: .5px; text-transform: uppercase; }
        .generate-btn:disabled { opacity: .7; cursor: not-allowed; }
        .loading { display: none; align-items: center; gap: 10px; margin: 20px 0; }
        .loading.active { display: flex; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,217,255,0.3); border-top-color: #00d9ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { background: rgba(255, 68, 68, 0.1); color: #ff4444; padding: 15px; border-radius: 8px; margin: 20px 0; display: none; border: 1px solid rgba(255, 68, 68, 0.3); }
        .error-message.active { display: block; }
        .result-container { display: none; margin-top: 20px; }
        .result-container.active { display: block; }
        .generated-image img { max-width: 100%; border-radius: 8px; border: 1px solid rgba(0, 217, 255, 0.25); box-shadow: 0 4px 20px rgba(0, 217, 255, 0.08); }
        .image-actions { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .action-btn, .gallery-item-actions a {
            display: inline-block; padding: 8px 12px; color: #00d9ff; background: rgba(0, 217, 255, 0.1);
            border-radius: 4px; text-decoration: none; font-size: 0.8em; transition: all 0.3s;
            border: 1px solid rgba(0, 217, 255, 0.3); text-transform: uppercase; letter-spacing: 1px; font-weight: 500;
        }
        .gallery-item-actions a:hover, .action-btn:hover { background: rgba(0, 217, 255, 0.2); }
        .gallery-section h3, .result-container h3 { margin: 20px 0 10px; color: #00d9ff; text-transform: uppercase; letter-spacing: 1px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; }
        .gallery-item { position: relative; overflow: hidden; border-radius: 8px; border: 1px solid rgba(0, 217, 255, 0.2); }
        .gallery-item img { width: 100%; height: auto; display: block; }
        .gallery-item-info { position: absolute; left: 0; right: 0; bottom: 0; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0)); }
        .gallery-item-prompt { color: #eee; font-size: 0.9em; margin-bottom: 6px; }
        .gallery-item-actions { display: flex; gap: 8px; }
    .quick-prompt-indicator { display: none; background: rgba(0, 217, 255, 0.1); border: 1px solid rgba(0, 217, 255, 0.3); padding: 10px 15px; border-radius: 4px; margin-bottom: 20px; color: #00d9ff; font-size: 0.9em; text-align: center; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .image-actions { flex-direction: column; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .container { padding: 20px; }
        }
        /* Add cursor pointer to generated image */
        #generatedImage img { cursor: pointer; transition: opacity 0.3s; }
        #generatedImage img:hover { opacity: 0.8; }
    </style>
    <style>
        /* Fullscreen Modal Styles */
        .fullscreen-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 20px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 85vh;
            border-radius: 8px;
        }

        #modalCaption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: #ccc;
            padding: 10px 0;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #bbb;
            text-decoration: none;
        }

        /* Add cursor pointer to generated image */
        #generatedImage img {
            cursor: pointer;
            transition: opacity 0.3s;
        }
        #generatedImage img:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> MyBonzo AI Generator</h1>
            <p>Tw�rz niesamowite obrazy za pomoc� Cloudflare Workers AI</p>
        </div>

    <div id="quickPromptIndicator" class="quick-prompt-indicator">
             U�ywasz szybkiego prompt z g��wnej strony
        </div>

        <form class="generator-form" id="imageForm">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="prompt">Opis obrazu (prompt) *</label>
                    <textarea 
                        id="prompt" 
                        name="prompt" 
                        placeholder="Opisz obraz, kt�ry chcesz wygenerowa�... np. 'Pi�kny zach�d s�o�ca nad g�rami'"
                        required
                        minlength="5"
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label for="style">Styl artystyczny</label>
                    <select id="style" name="style">
                        <option value="">Brak (domy�lny)</option>
                        <option value="realistyczny">Realistyczny</option>
                        <option value="surrealistyczny">Surrealistyczny</option>
                        <option value="abstrakcyjny">Abstrakcyjny</option>
                        <option value="retro">Retro</option>
                        <option value="nowoczesny">Nowoczesny</option>
                        <option value="akwarela">Akwarela</option>
                        <option value="olej">Malarstwo olejne</option>
                        <option value="anime">Anime</option>
                        <option value="fotograficzny">Fotograficzny</option>
                        <option value="fantasy">Fantasy</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="model">Model AI</label>
                    <select id="model" name="model">
                        <option value="@cf/black-forest-labs/flux-1-schnell">Flux-1 Schnell (Szybki)</option>
                        <option value="@cf/stabilityai/stable-diffusion-xl-base-1.0">Stable Diffusion XL</option>
                        <option value="@cf/lykon/dreamshaper-8-lcm">DreamShaper LCM</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="width">Szeroko�� (256-1024px)</label>
                    <input type="number" id="width" name="width" min="256" max="1024" value="512" step="64">
                </div>
                
                <div class="form-group">
                    <label for="height">Wysoko�� (256-1024px)</label>
                    <input type="number" id="height" name="height" min="256" max="1024" value="512" step="64">
                </div>
                
                <div class="form-group">
                    <label for="steps">Kroki inferencji (1-20)</label>
                    <input type="number" id="steps" name="steps" min="1" max="20" value="8">
                </div>
            </div>
            
            <button type="submit" class="generate-btn" id="generateBtn">
                 Generuj Obraz
            </button>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Generowanie obrazu... To mo�e potrwa� chwil�.</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="result-container" id="resultContainer">
            <h3> Tw�j wygenerowany obraz:</h3>
            <div class="generated-image" id="generatedImage"></div>
            <div class="image-actions" id="imageActions"></div>
        </div>

        <div class="gallery-section">
            <h3> Galeria wygenerowanych obraz�w</h3>
            <div class="gallery-grid" id="galleryGrid">
                <!-- Galeria b�dzie �adowana dynamicznie -->
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div id="fullscreenModal" class="fullscreen-modal">
        <span class="close-modal" id="closeModal">&times;</span>
        <img class="modal-content" id="fullscreenImage">
        <div id="modalCaption"></div>
    </div>

    <script>
        const form = document.getElementById('imageForm');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const resultContainer = document.getElementById('resultContainer');
        const generatedImage = document.getElementById('generatedImage');
        const imageActions = document.getElementById('imageActions');
        const generateBtn = document.getElementById('generateBtn');
        const galleryGrid = document.getElementById('galleryGrid');
        const quickPromptIndicator = document.getElementById('quickPromptIndicator');

        // Modal elements
        const modal = document.getElementById('fullscreenModal');
        const modalImg = document.getElementById('fullscreenImage');
        const modalCaption = document.getElementById('modalCaption');
        const closeModal = document.getElementById('closeModal');

        // Generate image
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const prompt = formData.get('prompt');
            if (!prompt || String(prompt).trim().length < 5) {
                showError('Prompt musi mieć co najmniej 5 znaków');
                return;
            }

            showLoading(true);
            hideError();
            hideResult();

            const requestData = {
                prompt: String(prompt).trim(),
                style: formData.get('style') || undefined,
                model: formData.get('model'),
                width: parseInt(String(formData.get('width'))) || 512,
                height: parseInt(String(formData.get('height'))) || 512,
                steps: parseInt(String(formData.get('steps'))) || 8
            };

            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                if (!response.ok) {
                    const txt = await response.text();
                    throw new Error('HTTP ' + response.status + ': ' + txt);
                }
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                const imageData = {
                    data_url: blobUrl,
                    download_url: blobUrl,
                    prompt: requestData.prompt,
                    originalPrompt: requestData.prompt,
                    style: requestData.style,
                    parameters: { width: requestData.width, height: requestData.height, steps: requestData.steps }
                };
                showResult(imageData);
                loadGallery();
            } catch (error) {
                showError('Błąd połączenia: ' + (error && error.message ? error.message : String(error)));
            } finally {
                showLoading(false);
            }
        });

        function showLoading(show) {
            loading.classList.toggle('active', show);
            generateBtn.disabled = show;
            generateBtn.textContent = show ? ' Generowanie...' : ' Generuj Obraz';
        }

        function showError(message) { errorMessage.textContent = message; errorMessage.classList.add('active'); }
        function hideError() { errorMessage.classList.remove('active'); }

        function showResult(imageData) {
            generatedImage.innerHTML = `
                <img id="resultImage" src="${imageData.data_url}" alt="Wygenerowany obraz" />
                <p style="margin-top: 15px; color: #888;"><strong>Prompt:</strong> ${imageData.prompt}</p>
                ${imageData.style ? `<p style=\"color: #888;\"><strong>Styl:</strong> ${imageData.style}</p>` : ''}
                <p style="color: #888;"><strong>Parametry:</strong> ${imageData.parameters.width}x${imageData.parameters.height}, ${imageData.parameters.steps} kroków</p>
            `;

            imageActions.innerHTML = `
                <a href="${imageData.download_url}" class="action-btn" download>Pobierz</a>
                <button class="action-btn" onclick="copyImageUrl('${imageData.data_url}')">Kopiuj URL</button>
                <button class="action-btn" onclick="shareImage('${imageData.data_url}', '${imageData.prompt}')">Udostępnij</button>
                <button class="action-btn" onclick="saveToDevice('${imageData.data_url}', '${imageData.originalPrompt || imageData.prompt}')">Zapisz</button>
            `;

            resultContainer.classList.add('active');

            const imgEl = document.getElementById('resultImage');
            if (imgEl) {
                imgEl.addEventListener('click', function(){
                    const caption = (imageData.originalPrompt || imageData.prompt || '') +
                        (imageData.style ? ' • ' + imageData.style : '') +
                        ' • ' + imageData.parameters.width + 'x' + imageData.parameters.height;
                    openModal(imageData.data_url, caption);
                });
            }
        }

        function hideResult() { resultContainer.classList.remove('active'); }

        // Global helpers for inline buttons
        function copyImageUrl(dataUrl) { navigator.clipboard.writeText(dataUrl).then(() => { alert('URL obrazu skopiowany do schowka!'); }); }
        function shareImage(dataUrl, prompt) {
            if (navigator.share) { navigator.share({ title: 'MyBonzo AI - Wygenerowany obraz', text: `Obraz wygenerowany przez AI: ${prompt}`, url: window.location.href }); }
            else { copyImageUrl(dataUrl); alert('URL skopiowany do schowka (udostępnianie nie jest dostępne)'); }
        }
        function saveToDevice(dataUrl, prompt) {
            const link = document.createElement('a'); link.href = dataUrl;
            const cleanPrompt = String(prompt || '').replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 30);
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `mybonzo_ai_${cleanPrompt}_${timestamp}.png`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // Fullscreen modal
        function openModal(src, caption) { if (modal) modal.style.display = 'block'; if (modalImg) modalImg.src = src; if (modalCaption) modalCaption.textContent = caption || ''; }
        function closeModalFn() { if (modal) modal.style.display = 'none'; if (modalImg) modalImg.src = ''; }
        if (closeModal) closeModal.addEventListener('click', closeModalFn);
        if (modal) modal.addEventListener('click', function(ev){ if (ev.target === modal) closeModalFn(); });
        document.addEventListener('keydown', function(ev){ if (ev.key === 'Escape') closeModalFn(); });

        // Load gallery
        async function loadGallery() {
            try {
                const response = await fetch('/api/images/gallery?limit=12');
                const result = await response.json();
                if (result.success && result.images) {
                    galleryGrid.innerHTML = result.images.map(image => `
                        <div class="gallery-item">
                            <img src="${image.view_url}" alt="Obraz AI" loading="lazy" />
                            <div class="gallery-item-info">
                                <div class="gallery-item-prompt">${image.originalPrompt || image.prompt}</div>
                                <div class="gallery-item-actions">
                                    <a href="${image.download_url}" download>Pobierz</a>
                                    <a href="${image.view_url}" target="_blank">Zobacz</a>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    galleryGrid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #888;">Brak obrazów w galerii</p>';
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
                galleryGrid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #888;">Błąd ładowania galerii</p>';
            }
        }

        // On load: gallery + quick prompt from URL/localStorage
        document.addEventListener('DOMContentLoaded', () => {
            loadGallery();
            try {
                const params = new URLSearchParams(window.location.search);
                const urlPrompt = params.get('prompt');
                if (urlPrompt && urlPrompt.trim().length >= 5) {
                    const promptEl = document.getElementById('prompt');
                    if (promptEl) promptEl.value = urlPrompt.trim();
                    if (quickPromptIndicator) {
                        quickPromptIndicator.style.display = 'block';
                        quickPromptIndicator.textContent = 'Wczytano prompt z adresu URL';
                        setTimeout(function(){ quickPromptIndicator.style.display = 'none'; }, 5000);
                    }
                }
            } catch (e) {}
            const quickPrompt = localStorage.getItem('quickPrompt');
            if (quickPrompt) {
                const p = document.getElementById('prompt');
                if (p) p.value = quickPrompt;
                localStorage.removeItem('quickPrompt');
                if (quickPromptIndicator) quickPromptIndicator.style.display = 'block';
                const btn = document.getElementById('generateBtn');
                if (btn && btn.scrollIntoView) btn.scrollIntoView({ behavior: 'smooth' });
                setTimeout(function(){ if (quickPromptIndicator) quickPromptIndicator.style.display = 'none'; }, 5000);
            }
        });
    </script>
</body>
</html>
